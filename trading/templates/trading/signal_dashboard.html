{% extends 'core/base.html' %}
{% load static %}
{% load trading_tags %}

{% block title %}Fiona - Signal Dashboard{% endblock %}

{% block extra_css %}
<style>
    /* Fiona Trading Dashboard - Page Specific Styles */
    /* Note: Core dark mode variables are defined in finoa.css */
    
    .fiona-dashboard {
        min-height: 100vh;
        padding: 1rem;
    }
    
    .fiona-header {
        display: flex;
        justify-content: space-between;
        align-items: center;      
    }
    
    .fiona-header h1 {
        margin: 0;
    }
    
    .fiona-header .badge {
        font-size: 1rem;
        padding: 0.5rem 1rem;
    }
    
    /* Signal Card */
    .signal-card {
        background-color: var(--fiona-card-dark);
        border: 1px solid var(--fiona-border);
        border-radius: 12px;
        margin-bottom: 1.5rem;
        overflow: hidden;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .signal-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    
    .signal-card-header {
        background-color: var(--fiona-card-header);
        padding: 1rem 1.25rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid var(--fiona-border);
    }
    
    .signal-card-body {
        padding: 1.25rem;
    }
    
    .signal-card-footer {
        padding: 1rem 1.25rem;
        background-color: var(--fiona-card-header);
        border-top: 1px solid var(--fiona-border);
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }
    
    /* Setup Type Badge */
    .setup-type-badge {
        font-size: 0.875rem;
        padding: 0.35rem 0.75rem;
        border-radius: 6px;
        font-weight: 600;
    }
    
    .setup-type-BREAKOUT {
        background-color: #2563eb;
        color: white;
    }
    
    .setup-type-EIA_REVERSION {
        background-color: #7c3aed;
        color: white;
    }
    
    .setup-type-EIA_TRENDDAY {
        background-color: #059669;
        color: white;
    }
    
    /* Session Phase Tag */
    .session-phase-tag {
        background-color: var(--fiona-border);
        color: var(--fiona-text-light);
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    /* Direction Badge */
    .direction-badge {
        font-size: 1rem;
        font-weight: 700;
        padding: 0.5rem 1rem;
        border-radius: 6px;
    }
    
    .direction-LONG {
        background-color: var(--signal-long);
        color: white;
    }
    
    .direction-SHORT {
        background-color: var(--signal-short);
        color: white;
    }
    
    /* Confidence Badge */
    .confidence-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.35rem 0.75rem;
        border-radius: 6px;
        font-weight: 600;
    }
    
    .confidence-high {
        background-color: rgba(40, 167, 69, 0.2);
        color: var(--confidence-high);
        border: 1px solid var(--confidence-high);
    }
    
    .confidence-medium {
        background-color: rgba(255, 193, 7, 0.2);
        color: var(--confidence-medium);
        border: 1px solid var(--confidence-medium);
    }
    
    .confidence-low {
        background-color: rgba(220, 53, 69, 0.2);
        color: var(--confidence-low);
        border: 1px solid var(--confidence-low);
    }
    
    /* Risk Badge */
    .risk-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.35rem 0.75rem;
        border-radius: 6px;
        font-weight: 600;
    }
    
    .risk-GREEN {
        background-color: rgba(40, 167, 69, 0.2);
        color: var(--risk-green);
        border: 1px solid var(--risk-green);
    }
    
    .risk-YELLOW {
        background-color: rgba(255, 193, 7, 0.2);
        color: var(--risk-yellow);
        border: 1px solid var(--risk-yellow);
    }
    
    .risk-RED {
        background-color: rgba(220, 53, 69, 0.2);
        color: var(--risk-red);
        border: 1px solid var(--risk-red);
    }
    
    /* Range Info Box */
    .range-info {
        background-color: rgba(0, 0, 0, 0.2);
        border-radius: 8px;
        padding: 0.75rem;
        margin-bottom: 1rem;
    }
    
    .range-info-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.25rem;
    }
    
    .range-info-row:last-child {
        margin-bottom: 0;
    }
    
    .range-label {
        color: var(--fiona-text-muted);
        font-size: 0.875rem;
    }
    
    .range-value {
        font-weight: 600;
        font-family: 'Roboto Mono', monospace;
    }
    
    /* KI Info */
    .ki-info {
        background-color: rgba(0, 0, 0, 0.2);
        border-radius: 8px;
        padding: 0.75rem;
        margin-top: 1rem;
    }
    
    .ki-reasoning {
        color: var(--fiona-text-muted);
        font-size: 0.875rem;
        line-height: 1.5;
        margin-top: 0.5rem;
    }
    
    /* Trade Buttons */
    .btn-trade-live {
        background-color: var(--signal-long);
        border-color: var(--signal-long);
        color: white;
        font-weight: 600;
    }
    
    .btn-trade-live:hover:not(:disabled) {
        background-color: #218838;
        border-color: #1e7e34;
        color: white;
    }
    
    .btn-trade-live:disabled {
        background-color: #6c757d;
        border-color: #6c757d;
        opacity: 0.65;
    }
    
    .btn-trade-shadow {
        background-color: #6c757d;
        border-color: #6c757d;
        color: white;
        font-weight: 600;
    }
    
    .btn-trade-shadow:hover {
        background-color: #545b62;
        border-color: #4e555b;
        color: white;
    }
    
    .btn-trade-reject {
        background-color: transparent;
        border-color: var(--signal-short);
        color: var(--signal-short);
    }
    
    .btn-trade-reject:hover {
        background-color: var(--signal-short);
        color: white;
    }
    
    .btn-trade-details {
        background-color: #3a6ea5;
        border-color: #3a6ea5;
        color: white;
    }
    
    .btn-trade-details:hover {
        background-color: #2e5684;
        border-color: #2e5684;
        color: white;
    }
    
    /* Section Label */
    .section-label {
        color: var(--fiona-text-muted);
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 1px;
        margin-bottom: 0.5rem;
    }
    
    /* Stats Grid */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
    }
    
    .stat-item {
        text-align: center;
    }
    
    .stat-value {
        font-size: 1.25rem;
        font-weight: 700;
        font-family: 'Roboto Mono', monospace;
    }
    
    .stat-label {
        font-size: 0.75rem;
        color: var(--fiona-text-muted);
        text-transform: uppercase;
    }
    
    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        color: var(--fiona-text-muted);
    }
    
    .empty-state i {
        font-size: 4rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }
    
    /* Account Info Card */
    .account-info-card {
        background-color: var(--fiona-card-dark);
        border: 1px solid var(--fiona-border);
        border-radius: 12px;
        padding: 1rem 1.25rem;
        margin-bottom: 1.5rem;
    }
    
    .account-info-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
    }
    
    .account-info-header h5 {
        margin: 0;
        color: var(--fiona-text-light);
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .account-info-status {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.75rem;
    }
    
    .account-info-status.connected {
        color: var(--signal-long);
    }
    
    .account-info-status.disconnected {
        color: var(--signal-short);
    }
    
    .account-info-status.loading {
        color: var(--fiona-text-muted);
    }
    
    .account-info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
    }
    
    .account-info-item {
        text-align: center;
        padding: 0.5rem;
        background-color: rgba(0, 0, 0, 0.2);
        border-radius: 8px;
    }
    
    .account-info-value {
        font-size: 1.25rem;
        font-weight: 700;
        font-family: 'Roboto Mono', monospace;
        color: var(--fiona-text-light);
    }
    
    .account-info-value.positive {
        color: var(--signal-long);
    }
    
    .account-info-value.negative {
        color: var(--signal-short);
    }
    
    .account-info-label {
        font-size: 0.75rem;
        color: var(--fiona-text-muted);
        text-transform: uppercase;
        margin-top: 0.25rem;
    }
    
    .account-info-error {
        color: var(--signal-short);
        font-size: 0.875rem;
        text-align: center;
        padding: 1rem;
    }
    
    /* Broker Tabs */
    .broker-tabs {
        display: flex;
        gap: 0.25rem;
    }
    
    .broker-tab-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.25rem 0.6rem;
        font-size: 0.75rem;
        border-radius: 4px;
        background-color: rgba(0, 0, 0, 0.3);
        border: 1px solid var(--fiona-border);
        color: var(--fiona-text-muted);
        cursor: pointer;
        transition: all 0.2s;
        font-weight: 500;
    }
    
    .broker-tab-btn:hover {
        background-color: rgba(0, 0, 0, 0.5);
        color: var(--fiona-text-light);
    }
    
    .broker-tab-btn.active {
        background-color: #2563eb;
        border-color: #2563eb;
        color: white;
    }
    
    .broker-status-dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background-color: var(--fiona-text-muted);
    }
    
    .broker-status-dot.connected {
        background-color: var(--signal-long);
    }
    
    .broker-status-dot.disconnected {
        background-color: var(--signal-short);
    }
    
    .broker-status-dot.loading {
        background-color: var(--confidence-medium);
        animation: pulse-dot 1s ease-in-out infinite;
    }
    
    @keyframes pulse-dot {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.4; }
    }
    
    .broker-content {
        display: none;
    }
    
    .broker-content.active {
        display: block;
    }
    
    .refresh-btn {
        background: transparent;
        border: none;
        color: var(--fiona-text-muted);
        cursor: pointer;
        padding: 0.25rem;
        transition: color 0.2s;
    }
    
    .refresh-btn:hover {
        color: var(--fiona-text-light);
    }
    
    .refresh-btn.spinning i {
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    
    /* Worker Status Card */
    .worker-status-card {
        background-color: var(--fiona-card-dark);
        border: 1px solid var(--fiona-border);
        border-radius: 12px;
        padding: 1rem 1.25rem;
        margin-bottom: 1.5rem;
    }
    
    .worker-status-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
    }
    
    .worker-status-header h5 {
        margin: 0;
        color: var(--fiona-text-light);
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .worker-status-indicator {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.875rem;
        font-weight: 600;
        padding: 0.25rem 0.75rem;
        border-radius: 6px;
    }
    
    .worker-status-indicator.online {
        background-color: rgba(40, 167, 69, 0.2);
        color: var(--signal-long);
        border: 1px solid var(--signal-long);
    }
    
    .worker-status-indicator.offline {
        background-color: rgba(220, 53, 69, 0.2);
        color: var(--signal-short);
        border: 1px solid var(--signal-short);
    }
    
    .worker-status-indicator.no-data {
        background-color: rgba(108, 117, 125, 0.2);
        color: var(--fiona-text-muted);
        border: 1px solid var(--fiona-border);
    }
    
    .worker-status-indicator.loading {
        background-color: rgba(108, 117, 125, 0.2);
        color: var(--fiona-text-muted);
        border: 1px solid var(--fiona-border);
    }
    
    .worker-status-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 0.75rem;
    }
    
    .worker-status-item {
        text-align: center;
        padding: 0.5rem;
        background-color: rgba(0, 0, 0, 0.2);
        border-radius: 8px;
    }
    
    .worker-status-value {
        font-size: 1rem;
        font-weight: 400;
        font-family: 'Roboto Mono', monospace;
        color: var(--fiona-text-light);
    }
    
    .worker-status-label {
        font-size: 0.7rem;
        color: var(--fiona-text-muted);
        text-transform: uppercase;
        margin-top: 0.25rem;
    }
    
    .worker-diagnostic {
        margin-top: 0.75rem;
        padding: 0.5rem 0.75rem;
        background-color: rgba(0, 0, 0, 0.2);
        border-radius: 8px;
        font-size: 0.85rem;
        color: var(--fiona-text-muted);
    }
    
    .worker-diagnostic .label {
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 0.25rem;
        color: var(--fiona-text-muted);
    }
    
    .worker-diagnostic .message {
        color: var(--fiona-text-light);
    }
    
    .worker-status-error {
        color: var(--signal-short);
        font-size: 0.875rem;
        text-align: center;
        padding: 1rem;
    }
    
    /* Breakout Range Diagnostics Card */
    .range-diagnostics-card {
        background-color: var(--fiona-card-dark);
        border: 1px solid var(--fiona-border);
        border-radius: 12px;
        padding: 1rem 1.25rem;
        margin-bottom: 1.5rem;
    }
    
    .range-diagnostics-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
    }
    
    .range-diagnostics-header h5 {
        margin: 0;
        color: var(--fiona-text-light);
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .range-type-selector {
        display: flex;
        gap: 0.5rem;
    }
    
    .range-type-btn {
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
        border-radius: 4px;
        background-color: rgba(0, 0, 0, 0.3);
        border: 1px solid var(--fiona-border);
        color: var(--fiona-text-muted);
        cursor: pointer;
    }
    
    .range-type-btn.active {
        background-color: #2563eb;
        border-color: #2563eb;
        color: white;
    }
    
    .range-diagnostics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 0.75rem;
    }
    
    .range-diagnostics-item {
        text-align: center;
        padding: 0.5rem;
        background-color: rgba(0, 0, 0, 0.2);
        border-radius: 8px;
    }
    
    .range-diagnostics-value {
        font-size: 1rem;
        font-weight: 700;
        font-family: 'Roboto Mono', monospace;
        color: var(--fiona-text-light);
    }
    
    .range-diagnostics-label {
        font-size: 0.7rem;
        color: var(--fiona-text-muted);
        text-transform: uppercase;
        margin-top: 0.25rem;
    }
    
    .range-status-indicator {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 600;
    }
    
    .range-status-indicator.valid {
        background-color: rgba(40, 167, 69, 0.2);
        color: var(--signal-long);
        border: 1px solid var(--signal-long);
    }
    
    .range-status-indicator.invalid {
        background-color: rgba(220, 53, 69, 0.2);
        color: var(--signal-short);
        border: 1px solid var(--signal-short);
    }
    
    .range-status-indicator.pending {
        background-color: rgba(255, 193, 7, 0.2);
        color: var(--confidence-medium);
        border: 1px solid var(--confidence-medium);
    }
    
    .range-status-indicator.no-data {
        background-color: rgba(108, 117, 125, 0.2);
        color: var(--fiona-text-muted);
        border: 1px solid var(--fiona-border);
    }
    
    .price-position-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.2rem 0.5rem;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 600;
    }
    
    .price-position-badge.above {
        background-color: rgba(40, 167, 69, 0.2);
        color: var(--signal-long);
    }
    
    .price-position-badge.inside {
        background-color: rgba(255, 193, 7, 0.2);
        color: var(--confidence-medium);
    }

    .price-position-badge.below {
        background-color: rgba(220, 53, 69, 0.2);
        color: var(--signal-short);
    }

    .range-diagnostic-message {
        margin-top: 0.75rem;
        padding: 0.75rem;
        background-color: rgba(0, 0, 0, 0.2);
        border-radius: 8px;
    }

    /* Diagnostic Criteria List - Accordion Style */
    .diagnostic-criteria {
        margin-top: 0.75rem;
        background-color: rgba(0, 0, 0, 0.2);
        border-radius: 8px;
        overflow: hidden;
    }
    
    .diagnostic-criteria-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.5rem 0.75rem;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    
    .diagnostic-criteria-header:hover {
        background-color: rgba(255, 255, 255, 0.05);
    }
    
    .diagnostic-criteria .label {
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--fiona-text-muted);
        margin: 0;
    }
    
    .diagnostic-criteria-toggle {
        color: var(--fiona-text-muted);
        font-size: 0.8rem;
        transition: transform 0.2s;
    }
    
    .diagnostic-criteria-toggle.expanded {
        transform: rotate(180deg);
    }
    
    .diagnostic-criteria-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-out;
        padding: 0 0.75rem;
    }
    
    .diagnostic-criteria-content.expanded {
        max-height: 500px;
        padding: 0 0.75rem 0.5rem 0.75rem;
    }
    
    .criteria-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    
    .criteria-item {
        display: flex;
        align-items: flex-start;
        gap: 0.5rem;
        padding: 0.25rem 0;
        font-size: 0.8rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .criteria-item:last-child {
        border-bottom: none;
    }
    
    .criteria-icon {
        flex-shrink: 0;
        font-size: 0.9rem;
    }
    
    .criteria-icon.passed {
        color: var(--signal-long);
    }
    
    .criteria-icon.failed {
        color: var(--signal-short);
    }
    
    .criteria-content {
        flex: 1;
    }
    
    .criteria-name {
        color: var(--fiona-text-light);
        font-weight: 500;
    }
    
    .criteria-detail {
        color: var(--fiona-text-muted);
        font-size: 0.75rem;
        margin-top: 0.1rem;
    }
    
    /* Countdown Timer */
    .worker-countdown {
        margin-top: 0.75rem;
        padding: 0.5rem 0.75rem;
        background-color: rgba(0, 0, 0, 0.2);
        border-radius: 8px;
        font-size: 0.85rem;
    }
    
    .range-diagnostic-message .label {
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 0.25rem;
        color: var(--fiona-text-muted);
    }
    
    .range-diagnostic-message .message {
        color: var(--fiona-text-light);
    }
    
    .range-config-section {
        margin-top: 0.75rem;
        padding: 0.5rem 0.75rem;
        background-color: rgba(0, 0, 0, 0.15);
        border-radius: 8px;
        font-size: 0.8rem;
    }
    
    .range-config-section .label {
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 0.5rem;
        color: var(--fiona-text-muted);
    }
    
    .range-config-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
        gap: 0.5rem;
    }
    
    .range-config-item {
        display: flex;
        justify-content: space-between;
        padding: 0.25rem 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .range-config-item:last-child {
        border-bottom: none;
    }
    
    .range-config-key {
        color: var(--fiona-text-muted);
    }
    
    .range-config-value {
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    .countdown-label {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--fiona-text-muted);
    }
    
    .countdown-value {
        font-size: 1.1rem;
        font-weight: 700;
        font-family: 'Roboto Mono', monospace;
        color: var(--fiona-text-light);
    }
    
    .range-diagnostics-error {
        color: var(--signal-short);
        font-size: 0.875rem;
        text-align: center;
        padding: 1rem;
    }
    
    /* =========================================================
     * Price vs Range - Live Status Card Styles
     * ========================================================= */
    .price-range-status-card {
        background-color: var(--fiona-card-dark);
        border: 1px solid var(--fiona-border);
        border-radius: 12px;
        padding: 1rem 1.25rem;
        margin-bottom: 1.5rem;
    }
    
    .price-range-status-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
        flex-wrap: wrap;
        gap: 0.5rem;
    }
    
    .price-range-status-header h5 {
        margin: 0;
        color: var(--fiona-text-light);
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .price-range-phase-tabs {
        display: flex;
        gap: 0.25rem;
    }
    
    .phase-tab-btn {
        padding: 0.25rem 0.5rem;
        font-size: 0.7rem;
        border-radius: 4px;
        background-color: rgba(0, 0, 0, 0.3);
        border: 1px solid var(--fiona-border);
        color: var(--fiona-text-muted);
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .phase-tab-btn:hover {
        background-color: rgba(0, 0, 0, 0.5);
        color: var(--fiona-text-light);
    }
    
    .phase-tab-btn.active {
        background-color: #2563eb;
        border-color: #2563eb;
        color: white;
    }
    
    /* Price Range Content */
    .price-range-content {
        padding: 0.5rem 0;
    }
    
    .price-range-status-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-size: 0.9rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 1rem;
    }
    
    .price-range-status-badge.status-inside_range {
        background-color: rgba(40, 167, 69, 0.2);
        color: var(--signal-long);
        border: 1px solid var(--signal-long);
    }
    
    .price-range-status-badge.status-near_breakout_long,
    .price-range-status-badge.status-near_breakout_short {
        background-color: rgba(255, 193, 7, 0.2);
        color: var(--confidence-medium);
        border: 1px solid var(--confidence-medium);
    }
    
    .price-range-status-badge.status-breakout_long,
    .price-range-status-badge.status-breakout_short {
        background-color: rgba(220, 53, 69, 0.2);
        color: var(--signal-short);
        border: 1px solid var(--signal-short);
    }
    
    .price-range-status-badge.status-no_range {
        background-color: rgba(108, 117, 125, 0.2);
        color: var(--fiona-text-muted);
        border: 1px solid var(--fiona-border);
    }
    
    /* Two-column grid for range data vs live metrics */
    .price-range-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
    }
    
    .price-range-column {
        background-color: rgba(0, 0, 0, 0.2);
        border-radius: 8px;
        padding: 0.75rem;
    }
    
    .column-label {
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--fiona-text-muted);
        margin-bottom: 0.5rem;
        padding-bottom: 0.25rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .data-row {
        display: flex;
        justify-content: space-between;
        padding: 0.35rem 0;
        font-size: 0.85rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .data-row:last-child {
        border-bottom: none;
    }
    
    .data-label {
        color: var(--fiona-text-muted);
    }
    
    .data-value {
        font-weight: 600;
        font-family: 'Roboto Mono', monospace;
        color: var(--fiona-text-light);
    }
    
    .data-value.price-value {
        color: #17a2b8;
    }
    
    .data-value.distance-above {
        color: var(--signal-long);
    }
    
    .data-value.distance-below {
        color: var(--signal-short);
    }
    
    .data-value.phase-value {
        color: #6c757d;
        font-size: 0.75rem;
    }
    
    /* Fallback/Error state */
    .price-range-fallback {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        padding: 1.5rem;
        color: var(--fiona-text-muted);
        font-size: 0.85rem;
    }
    
    .price-range-fallback i {
        font-size: 1.1rem;
    }
    
    /* Responsive for Price Range Card */
    @media (max-width: 768px) {
        .price-range-grid {
            grid-template-columns: 1fr;
            gap: 1rem;
        }
        
        .price-range-status-header {
            flex-direction: column;
            align-items: flex-start;
        }
        
        .price-range-phase-tabs {
            flex-wrap: wrap;
        }
    }
    
    .countdown-value.imminent {
        color: var(--confidence-medium);
    }
    
    /* Badge pulse animation for new signals */
    .badge-pulse {
        animation: pulse 1s ease-in-out;
    }
    
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.2); background-color: #ffc107; }
        100% { transform: scale(1); }
    }
    
    /* Notification toggle button styles */
    #notification-toggle.btn-success {
        background-color: var(--signal-long);
        border-color: var(--signal-long);
    }
    
    #notification-toggle.btn-success:hover {
        background-color: #218838;
        border-color: #1e7e34;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
        .signal-card-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.5rem;
        }
        
        .signal-card-footer {
            justify-content: center;
        }
        
        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .account-info-grid {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .worker-status-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }
    
    /* =========================================================
     * Dashboard Layout with Sidebar
     * ========================================================= */
    .dashboard-layout {
        display: flex;
        flex-wrap: wrap;
        align-items: flex-start;
        column-gap: 1.5rem;
        row-gap: 1.5rem;
        min-height: calc(100vh - 120px);
        width: 100%;
    }

    .dashboard-sidebar-col {
        flex: 0 0 100%;
    }

    .dashboard-main-col {
        flex: 1 1 0;
        min-width: 0;
    }

    @media (min-width: 992px) {
        .dashboard-sidebar-col {
            flex: 0 0 400px;
            max-width: 400px;
        }

        .dashboard-main-col {
            flex: 1 1 calc(100% - 400px - 1.5rem);
        }
    }

    /* Assets Sidebar */
    .assets-sidebar {
        width: 100%;
        min-width: 0;
        background: linear-gradient(180deg, rgba(46, 120, 214, 0.12), rgba(26, 188, 156, 0.04)),
                    var(--fiona-card-dark);
        border: 1px solid rgba(255, 255, 255, 0.06);       
        display: flex;
        flex-direction: column;
        overflow: hidden;
        position: sticky;
        top: 1rem;
        max-height: calc(100vh - 130px);       
        backdrop-filter: blur(6px);
    }

    .sidebar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.9rem 1.25rem;
        background: rgba(255, 255, 255, 0.03);
        border-bottom: 1px solid var(--fiona-border);
    }

    .sidebar-header h5 {
        margin: 0;
        color: var(--fiona-text-light);
        font-size: 0.95rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .sidebar-content {
        flex: 1;
        overflow-y: auto;
        padding: 0.75rem 0.75rem 1rem;
        background: rgba(0, 0, 0, 0.18);
    }

    .sidebar-list {
        background: transparent;
    }

    .sidebar-list .list-group-item {
        background-color: rgba(0, 0, 0, 0.28);
    }

    .sidebar-loading {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 1.75rem 1rem;
        color: var(--fiona-text-muted);
        gap: 0.5rem;
        font-size: 0.95rem;
    }

    .sidebar-loading i {
        font-size: 1.25rem;
        animation: spin 2s linear infinite;
    }

    /* Asset List Items (Bootstrap inspired) */
    .asset-list-item {
        background: rgba(0, 0, 0, 0.25);
        border-color: rgba(255, 255, 255, 0.06) !important;
        padding: 0.9rem 1rem;
        transition: all 0.2s ease;
        color: var(--fiona-text-light);
    }

    .asset-list-item:hover {
        background: rgba(46, 120, 214, 0.08);
        border-color: rgba(46, 120, 214, 0.25) !important;
        transform: translateX(2px);
        box-shadow: inset 3px 0 0 rgba(46, 120, 214, 0.5);
    }

    .asset-meta {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .asset-avatar {
        width: 42px;
        height: 42px;
        border-radius: 12px;
        background: linear-gradient(135deg, rgba(58, 110, 165, 0.45), rgba(255, 255, 255, 0.08));
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 700;
        letter-spacing: 0.4px;
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.12);
        border: 1px solid rgba(255, 255, 255, 0.12);
        text-transform: uppercase;
    }

    .asset-title {
        display: flex;
        flex-direction: column;
        gap: 0.15rem;
    }

    .asset-name {
        font-weight: 700;
        color: var(--fiona-text-light);
        font-size: 0.95rem;
    }

    .asset-symbol {
        color: var(--fiona-text-muted);
        font-size: 0.8rem;
        letter-spacing: 0.2px;
        text-transform: uppercase;
    }

    .price-badge {
        font-family: 'Roboto Mono', monospace;
        background: rgba(0, 0, 0, 0.45);
        color: var(--fiona-text-light);
        border: 1px solid rgba(255, 255, 255, 0.08);
        padding: 0.4rem 0.65rem;
        font-weight: 700;
        font-size: 1rem;
        letter-spacing: 0.2px;
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.04);
    }

    .price-badge .price-currency {
        font-size: 0.85rem;
        opacity: 0.85;
        margin-left: 0.2rem;
    }

    .price-badge.above-range {
        background: rgba(40, 167, 69, 0.18);
        color: var(--signal-long);
        border-color: rgba(40, 167, 69, 0.45);
    }

    .price-badge.within-range {
        background: rgba(255, 193, 7, 0.15);
        color: var(--confidence-medium);
        border-color: rgba(255, 193, 7, 0.45);
    }

    .price-badge.below-range {
        background: rgba(220, 53, 69, 0.15);
        color: var(--signal-short);
        border-color: rgba(220, 53, 69, 0.5);
    }

    .phase-pill {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.3rem 0.65rem;
        border-radius: 999px;
        font-size: 0.73rem;
        font-weight: 700;
        letter-spacing: 0.4px;
        text-transform: uppercase;
        border: 1px solid transparent;
    }

    .phase-pill.tradeable {
        background: rgba(40, 167, 69, 0.15);
        color: var(--signal-long);
        border-color: rgba(40, 167, 69, 0.55);
    }

    .phase-pill.range-building {
        background: rgba(255, 193, 7, 0.15);
        color: var(--confidence-medium);
        border-color: rgba(255, 193, 7, 0.6);
    }

    .phase-pill.not-tradeable {
        background: rgba(220, 53, 69, 0.15);
        color: var(--signal-short);
        border-color: rgba(220, 53, 69, 0.6);
    }

    .phase-pill.other {
        background: rgba(108, 117, 125, 0.18);
        color: var(--fiona-text-muted);
        border-color: rgba(108, 117, 125, 0.5);
    }

    .range-pills {
        display: flex;
        gap: 0.4rem;
        flex-wrap: wrap;
    }

    .range-pill {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.3rem 0.55rem;
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.06);
        font-size: 0.78rem;
        color: var(--fiona-text-light);
    }

    .range-pill .label {
        color: var(--fiona-text-muted);
        font-size: 0.72rem;
    }

    .range-pill.high {
        border-color: rgba(40, 167, 69, 0.4);
        color: var(--signal-long);
    }

    .range-pill.low {
        border-color: rgba(220, 53, 69, 0.4);
        color: var(--signal-short);
    }

    .range-distance {
        display: inline-flex;
        align-items: center;
        gap: 0.15rem;
        padding: 0.1rem 0.4rem;
        border-radius: 6px;
        background: rgba(255, 255, 255, 0.06);
        font-size: 0.72rem;
        color: var(--fiona-text-light);
        border: 1px solid rgba(255, 255, 255, 0.08);
    }

    .range-distance.negative {
        border-color: rgba(220, 53, 69, 0.35);
        color: var(--signal-short);
    }

    .range-distance.positive {
        border-color: rgba(40, 167, 69, 0.35);
        color: var(--signal-long);
    }

    .asset-status {
        color: var(--fiona-text-muted);
    }

    /* Dashboard Main Content Area - Split Layout */
    .dashboard-main {
        flex: 1;
        min-width: 0;
        display: flex;
        flex-direction: column;
        height: calc(100vh - 140px);
        gap: 1rem;
    }
    
    /* Top Area - Chart (2/3 height) */
    .dashboard-top-area {
        flex: 2;
        min-height: 0;
        background-color: var(--fiona-card-dark);
        border: 1px solid var(--fiona-border);
        border-radius: 12px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }
    
    /* Bottom Area - Tabs (1/3 height) */
    .dashboard-bottom-area {
        flex: 1;
        min-height: 0;
        background-color: var(--fiona-card-dark);
        border: 1px solid var(--fiona-border);
        border-radius: 12px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }
    
    /* Tab Navigation */
    .bottom-tabs {
        display: flex;
        border-bottom: 1px solid var(--fiona-border);
        background: rgba(255, 255, 255, 0.02);
        padding: 0.5rem 1rem;
        gap: 0.5rem;
    }
    
    .bottom-tab-btn {
        padding: 0.5rem 1rem;
        background: transparent;
        border: none;
        color: var(--fiona-text-muted);
        cursor: pointer;
        border-radius: 6px 6px 0 0;
        transition: all 0.2s;
        font-weight: 500;
    }
    
    .bottom-tab-btn:hover {
        background: rgba(255, 255, 255, 0.05);
        color: var(--fiona-text-light);
    }
    
    .bottom-tab-btn.active {
        background: var(--fiona-card-dark);
        color: var(--fiona-text-light);
        border-bottom: 2px solid #2563eb;
    }
    
    .bottom-tab-content {
        display: none;
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
    }
    
    .bottom-tab-content.active {
        display: block;
    }
    
    /* Chart Container in Top Area */
    .chart-top-container {
        flex: 1;
        position: relative;
        background: rgba(0, 0, 0, 0.2);
    }
    
    .chart-top-header {
        padding: 0.75rem 1rem;
        border-bottom: 1px solid var(--fiona-border);
        background: rgba(255, 255, 255, 0.02);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .chart-top-title {
        margin: 0;
        font-size: 0.95rem;
        color: var(--fiona-text-light);
    }
    
    .chart-placeholder {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: var(--fiona-text-muted);
        flex-direction: column;
        gap: 1rem;
    }
    
    .chart-placeholder i {
        font-size: 3rem;
        opacity: 0.3;
    }
    
    /* Signals Table */
    .signals-table {
        width: 100%;
        color: var(--fiona-text-light);
        font-size: 0.9rem;
    }
    
    .signals-table thead {
        background: rgba(0, 0, 0, 0.3);
        position: sticky;
        top: 0;
        z-index: 10;
    }
    
    .signals-table th {
        padding: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.5px;
        color: var(--fiona-text-muted);
        border-bottom: 1px solid var(--fiona-border);
    }
    
    .signals-table td {
        padding: 0.75rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        vertical-align: middle;
    }
    
    .signals-table tbody tr:hover {
        background: rgba(255, 255, 255, 0.02);
    }
    
    /* Positions Table */
    .positions-table {
        width: 100%;
        color: var(--fiona-text-light);
        font-size: 0.9rem;
    }
    
    .positions-table thead {
        background: rgba(0, 0, 0, 0.3);
        position: sticky;
        top: 0;
        z-index: 10;
    }
    
    .positions-table th {
        padding: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.5px;
        color: var(--fiona-text-muted);
        border-bottom: 1px solid var(--fiona-border);
    }
    
    .positions-table td {
        padding: 0.75rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        vertical-align: middle;
        font-family: 'Roboto Mono', monospace;
    }
    
    .positions-table tbody tr:hover {
        background: rgba(255, 255, 255, 0.02);
    }
    
    .position-side-long {
        color: var(--signal-long);
        font-weight: 600;
    }
    
    .position-side-short {
        color: var(--signal-short);
        font-weight: 600;
    }
    
    .position-pnl-positive {
        color: var(--signal-long);
    }
    
    .position-pnl-negative {
        color: var(--signal-short);
    }

    /* Sidebar Empty State */
    .sidebar-empty {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 1.6rem 1rem;
        color: var(--fiona-text-muted);
        text-align: center;
        gap: 0.4rem;
    }

    .sidebar-empty i {
        font-size: 1.5rem;
        opacity: 0.6;
    }

    .asset-actions {
        margin-left: auto;
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }

    .asset-chart-btn {
        padding: 0.35rem 0.65rem;
        border-radius: 8px;
        background: rgba(46, 120, 214, 0.12);
        border: 1px solid rgba(46, 120, 214, 0.4);
        color: var(--fiona-text-light);
        font-size: 0.8rem;
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
    }

    .asset-chart-btn:hover {
        background: rgba(46, 120, 214, 0.2);
        border-color: rgba(46, 120, 214, 0.6);
        color: white;
    }

    /* Data Status Indicator (shared with chart component) */
    .data-status-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.35rem 0.65rem;
        border-radius: 6px;
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .data-status-badge i {
        font-size: 0.5rem;
    }

    .data-status-badge.live {
        background-color: rgba(34, 197, 94, 0.2);
        color: #22c55e;
        border: 1px solid #22c55e;
    }

    .data-status-badge.poll {
        background-color: rgba(59, 130, 246, 0.2);
        color: #3b82f6;
        border: 1px solid #3b82f6;
    }

    .data-status-badge.cached {
        background-color: rgba(255, 193, 7, 0.2);
        color: #ffc107;
        border: 1px solid #ffc107;
    }

    .data-status-badge.offline {
        background-color: rgba(239, 68, 68, 0.2);
        color: #ef4444;
        border: 1px solid #ef4444;
    }

    /* Modal for realtime chart */
    .chart-modal {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.6);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 2000;
        backdrop-filter: blur(2px);
        padding: 1rem;
    }

    .chart-modal.open {
        display: flex;
    }

    .chart-modal.fullscreen {
        padding: 0;
    }

    .chart-modal-dialog {
        width: 75vw;
        height: 75vh;
        max-width: 1200px;
        background: linear-gradient(180deg, rgba(46, 120, 214, 0.12), rgba(26, 188, 156, 0.04)), var(--fiona-card-dark);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 16px;
        display: flex;
        flex-direction: column;
        box-shadow: 0 24px 60px rgba(0, 0, 0, 0.45);
        overflow: hidden;
    }

    .chart-modal.fullscreen .chart-modal-dialog {
        width: 100vw;
        height: 100vh;
        max-width: none;
        border-radius: 0;
        box-shadow: none;
    }

    .chart-modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.9rem 1.25rem;
        border-bottom: 1px solid var(--fiona-border);
        background: rgba(255, 255, 255, 0.02);
    }

    .chart-modal-title {
        margin: 0;
        color: var(--fiona-text-light);
        font-size: 1.05rem;
    }

    .chart-control-btn {
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid rgba(255, 255, 255, 0.12);
        color: #e5e7eb;
        border-radius: 8px;
        padding: 0.35rem 0.5rem;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        transition: all 0.15s ease;
    }

    .chart-control-btn:hover,
    .chart-control-btn:focus {
        color: #fff;
        border-color: rgba(255, 255, 255, 0.25);
        background: rgba(255, 255, 255, 0.1);
        box-shadow: 0 0 0 0.15rem rgba(255, 255, 255, 0.08);
    }

    .chart-modal-body {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        padding: 1rem 1.25rem 1.25rem;
        overflow: hidden;
    }

    .chart-modal-meta {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 0.75rem;
    }

    .chart-modal-meta .meta-item {
        background: rgba(0, 0, 0, 0.24);
        border: 1px solid rgba(255, 255, 255, 0.06);
        border-radius: 10px;
        padding: 0.65rem 0.75rem;
        display: flex;
        flex-direction: column;
        gap: 0.15rem;
    }

    .chart-modal-meta .meta-item span {
        font-size: 0.75rem;
        color: #cfd6e4;
        letter-spacing: 0.01em;
    }

    .chart-modal-meta .meta-item strong {
        font-size: 1rem;
        color: #f8fafc;
    }

    .chart-modal-meta .meta-item .phase-label {
        color: #93c5fd;
    }

    .chart-modal-meta .meta-item .current-price {
        color: #38bdf8;
    }

    .chart-modal-canvas {
        flex: 1;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.08);
        background: rgba(0, 0, 0, 0.22);
        min-height: 320px;
    }

    .chart-modal-info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 0.75rem;
    }

    .info-tile {
        background: rgba(0, 0, 0, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 10px;
        padding: 0.65rem 0.75rem;
    }

    .info-tile .label {
        color: #d0d7e2;
        font-size: 0.72rem;
        display: block;
        margin-bottom: 0.25rem;
    }

    .info-tile .value {
        font-size: 0.95rem;
        font-weight: 700;
        color: #f1f5f9;
        letter-spacing: 0.01em;
    }

    .chart-modal-info-grid .value.price-high,
    .chart-modal-info-grid .value.breakout-long,
    .chart-modal-info-grid .value.distance-high {
        color: var(--signal-long);
    }

    .chart-modal-info-grid .value.price-low,
    .chart-modal-info-grid .value.breakout-short,
    .chart-modal-info-grid .value.distance-low {
        color: var(--signal-short);
    }

    .chart-modal-info-grid .value.emphasis {
        color: #a5f3fc;
    }

    .chart-loading,
    .chart-error {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        height: 100%;
        color: var(--fiona-text-muted);
        flex-direction: column;
        text-align: center;
    }

    .chart-error p {
        margin: 0;
    }

    @media (max-width: 992px) {
        .chart-modal-dialog {
            width: 95vw;
            height: 80vh;
        }

        .chart-modal.fullscreen .chart-modal-dialog {
            width: 100vw;
            height: 100vh;
        }
    }

    /* Responsive - Hide sidebar on mobile */
    @media (max-width: 992px) {
        .dashboard-layout {
            column-gap: 0;
        }

        .dashboard-sidebar-col,
        .dashboard-main-col {
            flex: 0 0 100%;
            max-width: 100%;
        }

        .assets-sidebar {
            position: relative;
            top: 0;
            max-height: none;
        }

        .asset-list-item {
            padding: 0.85rem 0.9rem;
        }
    }
    @media (max-width: 576px) {
        .asset-list-item {
            padding: 0.8rem 0.85rem;
        }
    }
    
    /* Signal Controls */
    .signal-controls {
        background-color: var(--fiona-card-dark);
        border: 1px solid var(--fiona-border);
        border-radius: 12px;
        padding: 1rem;
    }
    
    .signal-controls .btn-group .btn {
        border-color: var(--fiona-border);
    }
    
    .signal-controls .btn-group .btn.active {
        background-color: rgba(255, 255, 255, 0.1);
        border-color: var(--fiona-text-light);
    }
    
    /* Signal Card Checkbox */
    .signal-card-header .form-check-input {
        width: 1.2rem;
        height: 1.2rem;
        cursor: pointer;
        margin-right: 0.5rem;
    }
    
    .signal-card-header .form-check-input:checked {
        background-color: var(--signal-long);
        border-color: var(--signal-long);
    }
</style>
{% endblock %}

{% block content %}
<div class="fiona-dashboard" data-signals-api-base="{% url 'api_signals_since' 'TIMESTAMP' %}">
    <div class="container-fluid">
        <div class="fiona-header">            
            <ul class="list-group list-group-horizontal">
                 <li class="list-group-item text-center"  style="background-color: #2e3440">
                    <span class="lead text-white" id="worker-last-activity">--</span><br>
                    <span class="small text-warning" >Worker last run</span>
                 </li>
                  <li class="list-group-item text-center"  style="background-color: #2e3440">
                    <span class="lead text-white" id="worker-status-indicator">--</span>
                    <span class="small text-warning" >Worker Status</span>
                 </li>
                 <li class="list-group-item text-center"  style="background-color: #2e3440">
                    <span class="lead text-white" id="worker-phase">--</span><br>
                    <span class="small text-warning" >Phase</span>
                 </li>
                  <li class="list-group-item text-center"  style="background-color: #2e3440">
                    <span class="lead text-white">{{ active_count }}</span><br>
                    <span class="small text-warning">aktive Signale</span>
                 </li>
            
                 <li class="list-group-item text-center"  style="background-color: #2e3440">
                    <span class="lead text-white" id="ig-balance">--</span><br>
                    <span class="small text-danger">IG Kontostand</span>
                 </li>
                 <li class="list-group-item text-center"  style="background-color: #2e3440">
                    <span class="lead text-white" id="ig-margin-available">--</span><br>
                    <span class="small text-danger">IG Margin</span>
                 </li>
                   <li class="list-group-item text-center"  style="background-color: #2e3440">
                    <span class="lead text-white" id="ig-pnl">--</span><br>
                    <span class="small text-danger">P/L</span>
                 </li>
                  <li class="list-group-item text-center"  style="background-color: #2e3440">
                    <span class="lead text-white" id="mexc-balance">--</span><br>
                    <span class="small text-info">MEXC Kontostand</span>
                 </li>
                 <li class="list-group-item text-center"  style="background-color: #2e3440">
                    <span class="lead text-white" id="mexc-margin-available">--</span><br>
                    <span class="small text-info">MEXC Margin</span>
                 </li>
                  <li class="list-group-item text-center"  style="background-color: #2e3440">
                    <span class="lead text-white" id="mexc-pnl">--</span><br>
                    <span class="small text-info">P/L</span>
                 </li>
                </ul>


            <div class="d-flex gap-2 align-items-center">
                 <a href="{% url 'breakout_distance_chart' %}" class="btn btn-sm btn-outline-light" title="Breakout Chart" style="margin-top: auto;">
                        <i class="bi bi-graph-up"></i> Chart
                    </a>
                <!-- Notification toggle button -->
                <button id="notification-toggle" class="btn btn-sm btn-outline-light" onclick="toggleNotifications()" title="Benachrichtigungen">
                    <i id="notification-icon" class="bi bi-bell"></i>
                </button>
            </div>
        </div>
        
        <!-- Main Dashboard Layout with Sidebar -->
        <div class="row g-3 dashboard-layout">
            <!-- Left Sidebar - Active Assets -->
            <div class="col-12 col-lg-auto dashboard-sidebar-col">
                <aside class="assets-sidebar" id="assets-sidebar">
                    <div class="sidebar-header">
                        <h5><i class="bi bi-collection"></i> Aktive Assets</h5>
                        <button class="refresh-btn" id="refresh-sidebar-btn" onclick="refreshAssetsSidebar()" title="Aktualisieren">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>
                    </div>
                    <div class="sidebar-content">
                        <ul class="list-group list-group-flush sidebar-list" id="sidebar-assets-list">
                            <!-- Asset items will be dynamically loaded -->
                            <li class="list-group-item bg-transparent border-0">
                                <div class="sidebar-loading">
                                    <i class="bi bi-hourglass-split"></i>
                                    <span>Ldt Assets...</span>
                                </div>
                            </li>
                        </ul>
                    </div>
                </aside>
            </div>

            <!-- Main Content Area -->
            <div class="col-12 col-lg dashboard-main-col">
                <main class="dashboard-main">
                    <!-- Top Area - Chart (2/3) -->
                    <div class="dashboard-top-area">
                        <div class="chart-top-header">
                            <h5 class="chart-top-title">
                                <i class="bi bi-graph-up"></i> 
                                <span id="chart-asset-name">Realtime Chart</span>
                            </h5>
                            <div class="d-flex align-items-center gap-2">
                                <span id="chart-data-status" class="data-status-badge offline">
                                    <i class="bi bi-circle-fill"></i> 
                                    <span id="chart-status-text">OFFLINE</span>
                                </span>
                            </div>
                        </div>
                        <div class="chart-top-container" id="top-chart-container">
                            <div class="chart-placeholder">
                                <i class="bi bi-bar-chart-line"></i>
                                <p>Whlen Sie ein Asset aus der Sidebar, um das Chart anzuzeigen</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Bottom Area - Tabs (1/3) -->
                    <div class="dashboard-bottom-area">
                        <div class="bottom-tabs">
                            <button class="bottom-tab-btn active" onclick="switchBottomTab('signals', this)">
                                <i class="bi bi-lightning-charge"></i> Signals
                            </button>
                            <button class="bottom-tab-btn" onclick="switchBottomTab('open-positions', this)">
                                <i class="bi bi-graph-up-arrow"></i> Open Positions
                            </button>
                            <button class="bottom-tab-btn" onclick="switchBottomTab('positions-today', this)">
                                <i class="bi bi-calendar-check"></i> Positions Today
                            </button>
                        </div>
                        
                        <!-- Signals Tab -->
                        <div id="signals-tab" class="bottom-tab-content active">
                            <div class="signal-controls mb-3">
                                <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                                    <div class="btn-group" role="group" aria-label="Signal Filter">
                                        <button type="button" class="btn btn-sm btn-outline-light active" onclick="filterSignals('ALL', this)">
                                            <i class="bi bi-funnel"></i> Alle
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-success" onclick="filterSignals('GREEN', this)">
                                            <i class="bi bi-check-circle"></i> Erlaubt
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-warning" onclick="filterSignals('YELLOW', this)">
                                            <i class="bi bi-exclamation-triangle"></i> Riskant
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="filterSignals('RED', this)">
                                            <i class="bi bi-x-circle"></i> Verboten
                                        </button>
                                    </div>
                                    
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-sm btn-outline-danger" onclick="deleteAllForbiddenSignals()" title="Alle verbotenen Signale lschen">
                                            <i class="bi bi-trash"></i> Alle Verbotenen lschen
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" id="delete-selected-btn" onclick="deleteSelectedSignals()" style="display: none;" title="Ausgewhlte Signale lschen">
                                            <i class="bi bi-trash"></i> Ausgewhlte lschen (<span id="selected-count">0</span>)
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            {% if signals %}
                            <div class="table-responsive">
                                <table class="signals-table">
                                    <thead>
                                        <tr>
                                            <th><input type="checkbox" id="select-all-signals" onclick="toggleAllSignals(this)"></th>
                                            <th>Asset</th>
                                            <th>Setup</th>
                                            <th>Direction</th>
                                            <th>Trigger</th>
                                            <th>SL / TP</th>
                                            <th>Size</th>
                                            <th>Risk</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="signals-table-body">
                                        {% for signal in signals %}
                                        <tr data-risk-status="{{ signal.risk_status }}" data-signal-id="{{ signal.id }}">
                                            <td>
                                                <input type="checkbox" class="form-check-input signal-checkbox" data-signal-id="{{ signal.id }}" onchange="updateSelectedCount()">
                                            </td>
                                            <td>
                                                <strong>{% if signal.trading_asset %}{{ signal.trading_asset.name }}{% else %}{{ signal.instrument }}{% endif %}</strong>
                                                <br>
                                                <small class="text-muted">{{ signal.created_at|date:"d.m.Y H:i" }}</small>
                                            </td>
                                            <td>
                                                <span class="setup-type-badge setup-type-{% if signal.setup_type %}{{ signal.setup_type }}{% else %}BREAKOUT{% endif %}">
                                                    {% if signal.setup_type_display %}{{ signal.setup_type_display }}{% else %}{{ signal.get_setup_type_display }}{% endif %}
                                                </span>
                                            </td>
                                            <td>
                                                <span class="direction-badge direction-{{ signal.direction }}">
                                                    {% if signal.direction == 'LONG' %}<i class="bi bi-arrow-up-circle-fill"></i>{% else %}<i class="bi bi-arrow-down-circle-fill"></i>{% endif %}
                                                    {{ signal.direction }}
                                                </span>
                                            </td>
                                            <td>{{ signal.trigger_price }}</td>
                                            <td>
                                                <span class="text-danger">{{ signal.stop_loss }}</span> / 
                                                <span class="text-success">{{ signal.take_profit }}</span>
                                            </td>
                                            <td>{{ signal.position_size }}</td>
                                            <td>
                                                <span class="risk-badge risk-{{ signal.risk_status }}">
                                                    {% if signal.risk_status == 'GREEN' %}
                                                        <i class="bi bi-check-circle-fill"></i>
                                                    {% elif signal.risk_status == 'YELLOW' %}
                                                        <i class="bi bi-exclamation-triangle-fill"></i>
                                                    {% else %}
                                                        <i class="bi bi-x-circle-fill"></i>
                                                    {% endif %}
                                                </span>
                                            </td>
                                            <td>
                                                <div class="btn-group btn-group-sm" role="group">
                                                    <button class="btn btn-trade-live btn-sm" 
                                                            {% if not signal.can_execute_live %}disabled{% endif %}
                                                            onclick="executeTrade('{{ signal.id }}', 'live')"
                                                            title="Live Trade">
                                                        <i class="bi bi-lightning-fill"></i>
                                                    </button>
                                                    <a href="{% url 'signal_detail' signal.id %}" class="btn btn-trade-details btn-sm" title="Details">
                                                        <i class="bi bi-eye"></i>
                                                    </a>
                                                    <button class="btn btn-trade-reject btn-sm"
                                                            onclick="rejectSignal('{{ signal.id }}')"
                                                            title="Reject">
                                                        <i class="bi bi-x-lg"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% else %}
                            <div class="empty-state">
                                <i class="bi bi-graph-up-arrow"></i>
                                <h3>Keine aktiven Signale</h3>
                                <p>Es sind derzeit keine aktiven Trading-Signale vorhanden.</p>
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- Open Positions Tab -->
                        <div id="open-positions-tab" class="bottom-tab-content">
                            <div id="open-positions-container" hx-get="{% url 'htmx_open_positions' %}" hx-trigger="load, every 5s" hx-swap="innerHTML">
                                <div class="text-center py-4">
                                    <i class="bi bi-hourglass-split"></i> Ldt Positionen...
                                </div>
                            </div>
                        </div>
                        
                        <!-- Positions Today Tab -->
                        <div id="positions-today-tab" class="bottom-tab-content">
                            <div id="positions-today-container" hx-get="{% url 'htmx_positions_today' %}" hx-trigger="load" hx-swap="innerHTML">
                                <div class="text-center py-4">
                                    <i class="bi bi-hourglass-split"></i> Ldt Positionen...
                                </div>
                            </div>
                        </div>
                    </div>
                </main>
                <!-- End Main Content Area -->
            </div>
        </div>
        <!-- End Dashboard Layout -->
    </div>
</div>


{% endblock %}

{% block extra_js %}
<script src="{% static 'core/js/lightweight-charts.standalone.production.js' %}"></script>
<script src="{% static 'core/js/breakout_distance_widget.js' %}"></script>
<script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    const ASSET_CHART_WINDOW_HOURS = 6;
    const ASSET_CHART_REFRESH_MS = 5000;
    let assetChartWidget = null;
    
    function executeTrade(signalId, tradeType) {
        const url = tradeType === 'live' 
            ? `/fiona/signals/${signalId}/live/`
            : `/fiona/signals/${signalId}/shadow/`;
        
        fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert('Fehler: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Ein Fehler ist aufgetreten.');
        });
    }
    
    function rejectSignal(signalId) {
        // No confirmation dialog - per requirements, individual signals should be deleted immediately
        // This provides a faster workflow for dismissing single signals
        // Bulk operations still have confirmations for safety
        fetch(`/fiona/signals/${signalId}/reject/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Remove the signal card from DOM instead of reload for better UX
                const checkbox = document.querySelector(`.signal-checkbox[data-signal-id="${signalId}"]`);
                if (checkbox) {
                    const signalCard = checkbox.closest('.col-lg-6');
                    if (signalCard) {
                        signalCard.remove();
                        updateSelectedCount();
                    }
                }
            } else {
                alert('Fehler: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Ein Fehler ist aufgetreten.');
        });
    }
    
    // Filter signals by risk status
    function filterSignals(status, buttonElement) {
        const allCards = document.querySelectorAll('.signal-card');
        const buttons = document.querySelectorAll('.signal-controls .btn-group button');
        
        // Status to button text mapping
        const statusToText = {
            'ALL': 'Alle',
            'GREEN': 'Erlaubt',
            'YELLOW': 'Riskant',
            'RED': 'Verboten'
        };
        
        // Update active button - use buttonElement if passed, otherwise find by status
        buttons.forEach(btn => btn.classList.remove('active'));
        if (buttonElement) {
            buttonElement.classList.add('active');
        } else {
            // Fallback: find button by status text
            const targetText = statusToText[status] || 'Alle';
            buttons.forEach(btn => {
                if (btn.textContent.includes(targetText)) {
                    btn.classList.add('active');
                }
            });
        }
        
        allCards.forEach(card => {
            const cardStatus = card.getAttribute('data-risk-status');
            if (status === 'ALL' || cardStatus === status) {
                card.closest('.col-lg-6').style.display = '';
            } else {
                card.closest('.col-lg-6').style.display = 'none';
            }
        });
    }
    
    // Update selected signals count
    function updateSelectedCount() {
        const checkboxes = document.querySelectorAll('.signal-checkbox:checked');
        const count = checkboxes.length;
        const countSpan = document.getElementById('selected-count');
        const deleteBtn = document.getElementById('delete-selected-btn');
        
        if (countSpan) {
            countSpan.textContent = count;
        }
        
        if (deleteBtn) {
            deleteBtn.style.display = count > 0 ? '' : 'none';
        }
    }
    
    // Delete all forbidden signals
    function deleteAllForbiddenSignals() {
        if (!confirm('Wirklich alle verbotenen Signale lschen?')) {
            return;
        }
        
        fetch('/fiona/signals/delete-forbidden/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`${data.deleted_count} Signal(e) gelscht`);
                location.reload();
            } else {
                alert('Fehler: ' + (data.error || 'Unbekannter Fehler'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Ein Fehler ist aufgetreten.');
        });
    }
    
    // Delete selected signals
    function deleteSelectedSignals() {
        const checkboxes = document.querySelectorAll('.signal-checkbox:checked');
        const signalIds = Array.from(checkboxes).map(cb => cb.getAttribute('data-signal-id'));
        
        if (signalIds.length === 0) {
            alert('Keine Signale ausgewhlt');
            return;
        }
        
        if (!confirm(`Wirklich ${signalIds.length} Signal(e) lschen?`)) {
            return;
        }
        
        fetch('/fiona/signals/delete-selected/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ signal_ids: signalIds }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`${data.deleted_count} Signal(e) gelscht`);
                location.reload();
            } else {
                alert('Fehler: ' + (data.error || 'Unbekannter Fehler'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Ein Fehler ist aufgetreten.');
        });
    }
    
    // Account state auto-refresh functionality
    let accountRefreshInterval = null;
    const REFRESH_INTERVAL = 30000; // 30 seconds
    let currentBrokerTab = 'ig';  // Default to IG
    
    // Known cryptocurrency codes that are not ISO 4217 compliant
    const CRYPTO_CURRENCIES = ['USDT', 'BTC', 'ETH', 'USDC', 'BNB', 'XRP', 'SOL', 'ADA', 'DOGE', 'DOT'];
    
    function formatCurrency(value, currency) {
        const num = parseFloat(value);
        if (isNaN(num)) return '--';
        
        const currencyCode = currency || 'EUR';
        
        // Check if it's a cryptocurrency that Intl.NumberFormat doesn't support
        if (CRYPTO_CURRENCIES.includes(currencyCode.toUpperCase())) {
            // Format as plain number and append currency symbol
            const formatted = new Intl.NumberFormat('de-DE', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(num);
            return formatted + ' ' + currencyCode;
        }
        
        // Use standard currency formatting for ISO 4217 currencies
        try {
            return new Intl.NumberFormat('de-DE', {
                style: 'currency',
                currency: currencyCode,
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(num);
        } catch (e) {
            // Fallback for any other unsupported currency codes
            const formatted = new Intl.NumberFormat('de-DE', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(num);
            return formatted + ' ' + currencyCode;
        }
    }
    
    function selectBrokerTab(broker) {
        currentBrokerTab = broker;
        
        // Update tab button states
        document.querySelectorAll('.broker-tab-btn').forEach(btn => {
            if (btn.dataset.broker === broker) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });
        
        // Show/hide content
        document.querySelectorAll('.broker-content').forEach(content => {
            content.classList.remove('active');
        });
        const contentEl = document.getElementById(broker + '-account-content');
        if (contentEl) {
            contentEl.classList.add('active');
        }
    }
    
    function updateBrokerStatusDot(broker, status) {
        const dot = document.getElementById(broker + '-status-dot');
        if (!dot) return;
        
        dot.classList.remove('connected', 'disconnected', 'loading');
        if (status === 'connected') {
            dot.classList.add('connected');
        } else if (status === 'disconnected') {
            dot.classList.add('disconnected');
        } else if (status === 'loading') {
            dot.classList.add('loading');
        }
    }
    
    function setRefreshButtonLoading(loading) {
        const btn = document.getElementById('refresh-account-btn');
        if (!btn) return;
        
        if (loading) {
            btn.classList.add('spinning');
            btn.disabled = true;
        } else {
            btn.classList.remove('spinning');
            btn.disabled = false;
        }
    }
    
    function updateBrokerAccountInfo(broker, data) {
        const currency = data.currency || (broker === 'mexc' ? 'USDT' : 'EUR');
        const prefix = broker + '-';
        
        // Update balance
        const balanceEl = document.getElementById(prefix + 'balance');
        if (balanceEl) {
            balanceEl.textContent = formatCurrency(data.balance, currency);
        }
        
        // Update available
        const availableEl = document.getElementById(prefix + 'available');
        if (availableEl) {
            availableEl.textContent = formatCurrency(data.available, currency);
        }
        
        // Update margin used
        const marginUsedEl = document.getElementById(prefix + 'margin-used');
        if (marginUsedEl) {
            marginUsedEl.textContent = formatCurrency(data.margin_used, currency);
        }
        
        // Update margin available
        const marginAvailableEl = document.getElementById(prefix + 'margin-available');
        if (marginAvailableEl) {
            marginAvailableEl.textContent = formatCurrency(data.margin_available, currency);
        }
        
        // Update P&L with color coding
        const pnlEl = document.getElementById(prefix + 'pnl');
        if (pnlEl) {
            const pnlValue = parseFloat(data.unrealized_pnl);
            pnlEl.textContent = formatCurrency(data.unrealized_pnl, currency);
            pnlEl.classList.remove('positive', 'negative');
            if (!isNaN(pnlValue)) {
                if (pnlValue > 0) {
                    pnlEl.classList.add('positive');
                } else if (pnlValue < 0) {
                    pnlEl.classList.add('negative');
                }
            }
        }
    }
    
    function showBrokerError(broker, errorMessage) {
        const contentEl = document.getElementById(broker + '-account-content');
        if (contentEl) {
            contentEl.innerHTML = '<div class="account-info-error"><i class="bi bi-exclamation-triangle"></i> ' + escapeHtml(errorMessage) + '</div>';
        }
    }
    
    function resetBrokerAccountGrid(broker) {
        const contentEl = document.getElementById(broker + '-account-content');
        if (contentEl) {
            const prefix = broker + '-';
            contentEl.innerHTML = `
                <div class="account-info-grid">
                    <div class="account-info-item">
                        <div class="account-info-value" id="${prefix}balance">--</div>
                        <div class="account-info-label">Kontostand</div>
                    </div>
                    <div class="account-info-item">
                        <div class="account-info-value" id="${prefix}available">--</div>
                        <div class="account-info-label">Verfgbar</div>
                    </div>
                    <div class="account-info-item">
                        <div class="account-info-value" id="${prefix}margin-used">--</div>
                        <div class="account-info-label">Margin (genutzt)</div>
                    </div>
                    <div class="account-info-item">
                        <div class="account-info-value" id="${prefix}margin-available">--</div>
                        <div class="account-info-label">Margin (verfgbar)</div>
                    </div>
                    <div class="account-info-item">
                        <div class="account-info-value" id="${prefix}pnl">--</div>
                        <div class="account-info-label">Unrealisiert P&L</div>
                    </div>
                </div>
            `;
        }
    }
    
    function refreshAllBrokersAccountState() {
        setRefreshButtonLoading(true);
        updateBrokerStatusDot('ig', 'loading');
        updateBrokerStatusDot('mexc', 'loading');
        resetBrokerAccountGrid('ig');
        resetBrokerAccountGrid('mexc');
        
        fetch('/fiona/api/all-brokers-account-state/', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            setRefreshButtonLoading(false);
            
            // Update IG broker
            if (data.ig.connected) {
                updateBrokerStatusDot('ig', 'connected');
                resetBrokerAccountGrid('ig');
                updateBrokerAccountInfo('ig', data.ig.data);
            } else {
                updateBrokerStatusDot('ig', 'disconnected');
                showBrokerError('ig', data.ig.error || 'Nicht verbunden');
            }
            
            // Update MEXC broker
            if (data.mexc.connected) {
                updateBrokerStatusDot('mexc', 'connected');
                resetBrokerAccountGrid('mexc');
                updateBrokerAccountInfo('mexc', data.mexc.data);
            } else {
                updateBrokerStatusDot('mexc', 'disconnected');
                showBrokerError('mexc', data.mexc.error || 'Nicht verbunden');
            }
        })
        .catch(error => {
            console.error('All brokers account state error:', error);
            setRefreshButtonLoading(false);
            updateBrokerStatusDot('ig', 'disconnected');
            updateBrokerStatusDot('mexc', 'disconnected');
            showBrokerError('ig', 'Verbindungsfehler');
            showBrokerError('mexc', 'Verbindungsfehler');
        });
    }
    
    // Keep old function for backward compatibility (calls new function)
    function refreshAccountState() {
        refreshAllBrokersAccountState();
    }
    
    function startAutoRefresh() {
        // Initial load
        refreshAllBrokersAccountState();
        refreshWorkerStatus();
        
        // Set up interval for auto-refresh
        accountRefreshInterval = setInterval(refreshAllBrokersAccountState, REFRESH_INTERVAL);
        workerRefreshInterval = setInterval(refreshWorkerStatus, WORKER_REFRESH_INTERVAL);
    }
    
    function stopAutoRefresh() {
        if (accountRefreshInterval) {
            clearInterval(accountRefreshInterval);
            accountRefreshInterval = null;
        }
        if (workerRefreshInterval) {
            clearInterval(workerRefreshInterval);
            workerRefreshInterval = null;
        }
    }
    
    // Worker Status refresh functionality
    let workerRefreshInterval = null;
    const WORKER_REFRESH_INTERVAL = 30000; // 30 seconds
    
    function updateWorkerStatusIndicator(status, text) {
        const indicatorEl = document.getElementById('worker-status-indicator');
        if (!indicatorEl) return;
        
        indicatorEl.className = 'worker-status-indicator ' + status;
        indicatorEl.innerHTML = '<i class="bi bi-circle-fill"></i> <span>' + text + '</span>';
    }
    
    function setWorkerRefreshButtonLoading(loading) {
        const btn = document.getElementById('refresh-worker-btn');
        if (!btn) return;
        
        if (loading) {
            btn.classList.add('spinning');
            btn.disabled = true;
        } else {
            btn.classList.remove('spinning');
            btn.disabled = false;
        }
    }
    
    // Constants for display formatting
    const EPIC_MAX_DISPLAY_LENGTH = 15;
    const EPIC_TRUNCATED_LENGTH = 12;
    
    function formatTimeAgo(seconds) {
        if (seconds < 60) {
            return 'vor ' + seconds + 's';
        } else if (seconds < 3600) {
            const minutes = Math.floor(seconds / 60);
            return 'vor ' + minutes + ' Min.';
        } else {
            const hours = Math.floor(seconds / 3600);
            return 'vor ' + hours + ' Std.';
        }
    }
    
    function formatTime(isoString) {
        // Note: UTC is used intentionally for trading time consistency
        const date = new Date(isoString);
        return date.toLocaleTimeString('de-DE', { 
            hour: '2-digit', 
            minute: '2-digit', 
            second: '2-digit',
            timeZone: 'UTC'
        }) + ' UTC';
    }
    
    function updateWorkerInfo(data, isOnline) {
        // Update last activity
        const lastActivityEl = document.getElementById('worker-last-activity');
        if (lastActivityEl && data.last_run_at) {
            const timeStr = formatTime(data.last_run_at);
            const agoStr = formatTimeAgo(data.seconds_since_last_run);
            lastActivityEl.innerHTML = timeStr ; //+ '<br><small>' + agoStr + '</small>';
        }
        
        // Update phase
        const phaseEl = document.getElementById('worker-phase');
        if (phaseEl) {
            phaseEl.textContent = data.phase || '--';
        }
        
        // Update epic
        const epicEl = document.getElementById('worker-epic');
        if (epicEl) {
            // Shorten the epic for display if too long
            const epic = data.epic || '--';
            epicEl.textContent = epic.length > EPIC_MAX_DISPLAY_LENGTH 
                ? epic.substring(0, EPIC_TRUNCATED_LENGTH) + '...' 
                : epic;
            epicEl.title = epic;
        }
        
        // Update price
        const priceEl = document.getElementById('worker-price');
        if (priceEl && data.price_info) {
            if (data.price_info.bid && data.price_info.ask) {
                priceEl.textContent = data.price_info.bid + '/' + data.price_info.ask;
            } else {
                priceEl.textContent = '--';
            }
        }
        
        // Update setup count
        const setupCountEl = document.getElementById('worker-setup-count');
        if (setupCountEl) {
            setupCountEl.textContent = data.setup_count !== undefined ? data.setup_count : '--';
        }
        
        // Update interval
        const intervalEl = document.getElementById('worker-interval');
        if (intervalEl) {
            intervalEl.textContent = data.worker_interval ? (data.worker_interval + 's') : '--';
        }
        
        // Update diagnostic message
        const diagnosticEl = document.getElementById('worker-diagnostic-message');
        if (diagnosticEl) {
            diagnosticEl.textContent = data.diagnostic_message || 'Keine Diagnose verfgbar';
        }
        
        // Update countdown - pass the isOnline status
        updateCountdown(data.seconds_until_next_run, data.worker_interval, isOnline);
        
        // Update diagnostic criteria
        updateDiagnosticCriteria(data.diagnostic_criteria || []);
    }
    
    // Countdown state
    let countdownInterval = null;
    let currentCountdownValue = 0;
    let workerInterval = 60;
    let workerIsOnline = false;
    
    function updateCountdown(secondsUntilNextRun, interval, isOnline) {
        // Store worker online status
        workerIsOnline = isOnline;
        
        // Store worker interval for countdown reset
        workerInterval = interval || 60;
        currentCountdownValue = secondsUntilNextRun || 0;
        
        // Clear existing interval
        if (countdownInterval) {
            clearInterval(countdownInterval);
            countdownInterval = null;
        }
        
        // Only show countdown if worker is online
        if (!workerIsOnline) {
            displayCountdownValue(-1); // Show offline state
            return;
        }
        
        // Display the initial countdown value
        displayCountdownValue(currentCountdownValue);
        
        // Start countdown timer (updates every second)
        countdownInterval = setInterval(function() {
            currentCountdownValue--;
            
            if (currentCountdownValue <= 0) {
                // Reset to worker interval when countdown reaches 0
                currentCountdownValue = workerInterval;
            }
            
            displayCountdownValue(currentCountdownValue);
        }, 1000);
    }
    
    function displayCountdownValue(seconds) {
        const countdownEl = document.getElementById('worker-countdown-value');
        if (countdownEl) {
            if (seconds < 0) {
                // Offline or no data state
                countdownEl.textContent = '--';
                countdownEl.classList.remove('imminent');
                return;
            }
            countdownEl.textContent = seconds + 's';
            // Add visual emphasis when countdown is imminent
            if (seconds <= 5) {
                countdownEl.classList.add('imminent');
            } else {
                countdownEl.classList.remove('imminent');
            }
        }
    }
    
    function updateDiagnosticCriteria(criteria) {
        const criteriaListEl = document.getElementById('criteria-list');
        if (!criteriaListEl) return;
        
        if (!criteria || criteria.length === 0) {
            criteriaListEl.innerHTML = `
                <li class="criteria-item">
                    <span class="criteria-icon"><i class="bi bi-dash"></i></span>
                    <span class="criteria-content">
                        <span class="criteria-name">Keine Kriterien verfgbar</span>
                    </span>
                </li>
            `;
            return;
        }
        
        // Build criteria list HTML
        let html = '';
        for (const criterion of criteria) {
            const iconClass = criterion.passed ? 'passed' : 'failed';
            const iconSymbol = criterion.passed ? 'bi-check-circle-fill' : 'bi-x-circle-fill';
            
            html += `
                <li class="criteria-item">
                    <span class="criteria-icon ${iconClass}"><i class="bi ${iconSymbol}"></i></span>
                    <span class="criteria-content">
                        <span class="criteria-name">${escapeHtml(criterion.name)}</span>
                        ${criterion.detail ? `<div class="criteria-detail">${escapeHtml(criterion.detail)}</div>` : ''}
                    </span>
                </li>
            `;
        }
        
        criteriaListEl.innerHTML = html;
    }
    
    // HTML escape using a lookup table for better security
    const HTML_ESCAPE_MAP = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;',
    };
    
    function escapeHtml(text) {
        if (!text || typeof text !== 'string') {
            return '';
        }
        return text.replace(/[&<>"']/g, function(match) {
            return HTML_ESCAPE_MAP[match];
        });
    }
    
    function showWorkerError(errorMessage) {
        const contentEl = document.getElementById('worker-status-content');
        if (contentEl) {
            contentEl.innerHTML = '<div class="worker-status-error"><i class="bi bi-exclamation-triangle"></i> ' + escapeHtml(errorMessage) + '</div>';
        }
    }
    
    // Worker status grid template
    const WORKER_STATUS_GRID_TEMPLATE = `
        <div class="worker-status-grid">
            <div class="worker-status-item">
                <div class="worker-status-value" id="worker-last-activity">--</div>
                <div class="worker-status-label">Letzte Aktivitt</div>
            </div>
            <div class="worker-status-item">
                <div class="worker-status-value" id="worker-phase">--</div>
                <div class="worker-status-label">Phase</div>
            </div>
            <div class="worker-status-item">
                <div class="worker-status-value" id="worker-epic">--</div>
                <div class="worker-status-label">Epic</div>
            </div>
            <div class="worker-status-item">
                <div class="worker-status-value" id="worker-setup-count">--</div>
                <div class="worker-status-label">Setups gefunden</div>
            </div>
            <div class="worker-status-item">
                <div class="worker-status-value" id="worker-interval">--</div>
                <div class="worker-status-label">Intervall</div>
            </div>
        </div>
        <div class="worker-countdown" id="worker-countdown">
            <span class="countdown-label"><i class="bi bi-clock"></i> Nchster Lauf in</span>
            <span class="countdown-value" id="worker-countdown-value">--</span>
        </div>
    `;
    
    function resetWorkerStatusGrid() {
        const contentEl = document.getElementById('worker-status-content');
        if (contentEl) {
            contentEl.innerHTML = WORKER_STATUS_GRID_TEMPLATE;
        }
    }
    
    function refreshWorkerStatus() {
        updateWorkerStatusIndicator('loading', 'Ldt...');
        setWorkerRefreshButtonLoading(true);
        
        fetch('/fiona/api/worker/status/', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            setWorkerRefreshButtonLoading(false);
            
            if (data.success) {
                if (data.worker_status === 'NO_DATA') {
                    updateWorkerStatusIndicator('no-data', 'Keine Daten');
                    resetWorkerStatusGrid();
                    document.getElementById('worker-diagnostic-message').textContent = data.status_message;
                    updateCountdown(0, 60, false);  // Stop countdown
                } else if (data.worker_status === 'ONLINE') {
                    updateWorkerStatusIndicator('online', 'ONLINE');
                    resetWorkerStatusGrid();
                    updateWorkerInfo(data.data, true);  // Pass isOnline = true
                } else {
                    updateWorkerStatusIndicator('offline', 'OFFLINE');
                    resetWorkerStatusGrid();
                    updateWorkerInfo(data.data, false);  // Pass isOnline = false
                }
            } else {
                updateWorkerStatusIndicator('offline', 'Fehler');
                showWorkerError(data.status_message || 'Unbekannter Fehler');
                updateCountdown(0, 60, false);  // Stop countdown
            }
        })
        .catch(error => {
            console.error('Worker status error:', error);
            setWorkerRefreshButtonLoading(false);
            updateWorkerStatusIndicator('offline', 'Fehler');
            showWorkerError('Verbindungsfehler');
            updateCountdown(0, 60, false);  // Stop countdown
        });
    }
    
    // Start auto-refresh when page loads
    document.addEventListener('DOMContentLoaded', function() {
        startAutoRefresh();
    });
    
    // Stop auto-refresh when page is hidden to save resources
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            stopAutoRefresh();
            if (assetChartWidget) {
                assetChartWidget.stopAutoRefresh();
            }
        } else {
            startAutoRefresh();
            // Restart chart if it was active
            if (assetChartWidget) {
                assetChartWidget.refresh();
                assetChartWidget.startAutoRefresh();
            }
        }
    });
    
    // ============================================================================
    // Assets Sidebar
    // ============================================================================
    
    let sidebarRefreshInterval = null;
    const SIDEBAR_REFRESH_INTERVAL = 10000; // 10 seconds
    
    function setSidebarRefreshButtonLoading(loading) {
        const btn = document.getElementById('refresh-sidebar-btn');
        if (!btn) return;
        
        if (loading) {
            btn.classList.add('spinning');
            btn.disabled = true;
        } else {
            btn.classList.remove('spinning');
            btn.disabled = false;
        }
    }
    
    function getPhaseDisplayName(phase) {
        const phaseNames = {
            'ASIA_RANGE': 'Asia Range',
            'LONDON_CORE': 'London Core',
            'PRE_US_RANGE': 'Pre-US Range',
            'US_CORE_TRADING': 'US Core Trading',
            'US_CORE': 'US Core',
            'EIA_PRE': 'EIA Pre',
            'EIA_POST': 'EIA Post',
            'FRIDAY_LATE': 'Friday Late',
            'OTHER': 'Other',
        };
        return phaseNames[phase] || phase || 'Unknown';
    }
    
    function getPhaseClass(phaseType) {
        if (phaseType === 'tradeable') {
            return 'tradeable';
        } else if (phaseType === 'range_building') {
            return 'range-building';
        } else if (phaseType === 'not_tradeable') {
            return 'not-tradeable';
        }
        return 'other';
    }
    
    function formatAssetPrice(price) {
        if (price === null || price === undefined || price === '--') return '--';
        const num = parseFloat(price);
        if (isNaN(num)) return '--';
        // Adaptive decimal places based on price magnitude
        if (num >= 1000) {
            return num.toFixed(2);
        } else if (num >= 10) {
            return num.toFixed(3);
        } else {
            return num.toFixed(4);
        }
    }

    function getAssetInitials(asset) {
        const source = (asset.symbol || asset.name || '').trim();
        if (!source) return '?';
        const clean = source.replace(/[^a-zA-Z0-9]/g, '');
        return escapeHtml(clean.substring(0, 3).toUpperCase());
    }

    function getPricePositionClass(asset) {
        if (!asset || asset.current_price === null || asset.current_price === undefined) {
            return '';
        }

        const range = asset.previous_range || {};
        const high = range.high;
        const low = range.low;

        if (high === undefined || high === null || low === undefined || low === null) {
            return '';
        }

        if (asset.current_price > high) {
            return 'above-range';
        }

        if (asset.current_price < low) {
            return 'below-range';
        }

        return 'within-range';
    }

    function formatDistance(value) {
        if (value === null || value === undefined) return '--';
        const num = parseFloat(value);
        if (isNaN(num)) return '--';
        const sign = num > 0 ? '+' : num < 0 ? '-' : '';
        const magnitude = Math.abs(num);
        let formatted;
        if (magnitude >= 1000) {
            formatted = magnitude.toFixed(2);
        } else if (magnitude >= 10) {
            formatted = magnitude.toFixed(3);
        } else {
            formatted = magnitude.toFixed(4);
        }
        return `${sign}${formatted}`;
    }

    function getDistanceClass(value) {
        if (value === null || value === undefined) return '';
        const num = parseFloat(value);
        if (isNaN(num) || num === 0) return '';
        return num < 0 ? 'negative' : 'positive';
    }
    
    function renderAssetItem(asset) {
        const phaseClass = getPhaseClass(asset.phase_type);
        const phaseName = getPhaseDisplayName(asset.current_phase);
        const pricePositionClass = getPricePositionClass(asset);
        const currency = asset.quote_currency ? `<span class="price-currency">${escapeHtml(asset.quote_currency)}</span>` : '';

        const priceValue = (asset.current_price || asset.current_price === 0)
            ? formatAssetPrice(asset.current_price)
            : '--';

        const distToHigh = asset.range_distance ? asset.range_distance.to_high : null;
        const distToLow = asset.range_distance ? asset.range_distance.to_low : null;

        const highDistanceBadge = distToHigh === null || distToHigh === undefined ? '' : `
            <span class="range-distance ${getDistanceClass(distToHigh)}"> ${formatDistance(distToHigh)}</span>
        `;

        const lowDistanceBadge = distToLow === null || distToLow === undefined ? '' : `
            <span class="range-distance ${getDistanceClass(distToLow)}"> ${formatDistance(distToLow)}</span>
        `;

        let rangeHtml = '';
        if (asset.previous_range && (asset.previous_range.high || asset.previous_range.low)) {
            rangeHtml = `
                <div class="range-pills ms-auto">
                    <span class="range-pill high">
                        <span class="label">H</span>
                        ${formatAssetPrice(asset.previous_range.high)}
                        ${highDistanceBadge}
                    </span>
                    <span class="range-pill low">
                        <span class="label">L</span>
                        ${formatAssetPrice(asset.previous_range.low)}
                        ${lowDistanceBadge}
                    </span>
                </div>
            `;
        }

        let phaseIcon = 'bi-circle-fill';
        if (phaseClass === 'tradeable') {
            phaseIcon = 'bi-lightning-charge-fill';
        } else if (phaseClass === 'range-building') {
            phaseIcon = 'bi-hourglass-split';
        } else if (phaseClass === 'not-tradeable') {
            phaseIcon = 'bi-x-circle-fill';
        } else {
            phaseIcon = 'bi-dash-circle';
        }

        return `
            <li class="list-group-item asset-list-item border-secondary-subtle"  data-asset-id="${asset.id}" data-symbol="${escapeHtml(asset.symbol || '')}" onclick="openAssetChartModalFromButton(this)">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="asset-meta">                       
                        <div class="asset-title">
                            <span class="asset-name">${escapeHtml(asset.name)}</span>
                            <span class="asset-symbol">${escapeHtml(asset.symbol || 'N/A')}</span>
                        </div>
                    </div>
                    <span class="badge rounded-pill price-badge ${pricePositionClass}">${priceValue}${currency}</span>
                </div>
                <div class="d-flex align-items-center gap-2 mt-2 flex-wrap justify-content-between">
                    <div class="d-flex align-items-center gap-2 flex-wrap">
                        <span class="phase-pill ${phaseClass}">
                            <i class="bi ${phaseIcon}"></i>
                            ${escapeHtml(phaseName)}
                        </span>
                        ${rangeHtml}
                    </div>                 
                </div>
                <hr>
                <div class="asset-status mt-1">
                    <small><i class="bi bi-info-circle"></i> ${escapeHtml(asset.status_message || 'Kein Status')}</small>
                </div>
            </li>
        `;
    }
    
    function renderSidebarContent(assets) {
        const container = document.getElementById('sidebar-assets-list');
        if (!container) return;
        
        if (!assets || assets.length === 0) {
            container.innerHTML = `
                <li class="list-group-item bg-transparent border-0">
                    <div class="sidebar-empty">
                        <i class="bi bi-box-seam"></i>
                        <span>Keine aktiven Assets</span>
                    </div>
                </li>
            `;
            return;
        }

        const html = assets.map(asset => renderAssetItem(asset)).join('');
        container.innerHTML = html;
    }
    
    function refreshAssetsSidebar() {
        setSidebarRefreshButtonLoading(true);
        
        fetch('/fiona/api/sidebar/assets/', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            setSidebarRefreshButtonLoading(false);
            
            if (data.success) {
                renderSidebarContent(data.assets);
            } else {
                const container = document.getElementById('sidebar-assets-list');
                if (container) {
                    container.innerHTML = `
                        <li class="list-group-item bg-transparent border-0">
                            <div class="sidebar-empty">
                                <i class="bi bi-exclamation-triangle"></i>
                                <span>${escapeHtml(data.error || 'Fehler beim Laden')}</span>
                            </div>
                        </li>
                    `;
                }
            }
        })
        .catch(error => {
            console.error('Sidebar refresh error:', error);
            setSidebarRefreshButtonLoading(false);
            const container = document.getElementById('sidebar-assets-list');
            if (container) {
                container.innerHTML = `
                    <li class="list-group-item bg-transparent border-0">
                        <div class="sidebar-empty">
                            <i class="bi bi-exclamation-triangle"></i>
                            <span>Verbindungsfehler</span>
                        </div>
                    </li>
                `;
            }
        });
    }
    
    // Override startAutoRefresh to include sidebar
    const originalStartAutoRefresh = startAutoRefresh;
    startAutoRefresh = function() {
        originalStartAutoRefresh();
        // Also refresh sidebar
        refreshAssetsSidebar();
        sidebarRefreshInterval = setInterval(refreshAssetsSidebar, SIDEBAR_REFRESH_INTERVAL);
    };
    
    // Override stopAutoRefresh to include sidebar
    const originalStopAutoRefresh = stopAutoRefresh;
    stopAutoRefresh = function() {
        originalStopAutoRefresh();
        if (sidebarRefreshInterval) {
            clearInterval(sidebarRefreshInterval);
            sidebarRefreshInterval = null;
        }
    };

    function getAssetChartWidget() {
        if (!window.BreakoutDistanceChartWidget) {
            console.warn('BreakoutDistanceChartWidget not available');
            return null;
        }

        if (!assetChartWidget) {
            // Create chart in the top container (not modal)
            assetChartWidget = new BreakoutDistanceChartWidget({
                chartContainer: 'top-chart-container',
                assetSymbol: '',
                assetId: '',
                hours: ASSET_CHART_WINDOW_HOURS,
                refreshMs: ASSET_CHART_REFRESH_MS,
                dataStatusBadge: '#chart-data-status',
                dataStatusText: '#chart-status-text',
                infoSelectors: {
                    // We'll add info tiles later or use a different display
                    asset: null,
                    phase: null,
                    referencePhase: null,
                    rangeHigh: null,
                    rangeLow: null,
                    breakoutLong: null,
                    breakoutShort: null,
                    currentPrice: null,
                    window: null,
                    distanceHigh: null,
                    distanceLow: null,
                    status: null,
                },
            });
            assetChartWidget.init();
        }

        return assetChartWidget;
    }

    function openAssetChartModalFromButton(button) {
        if (!button) return;
        const { symbol, assetId } = button.dataset;
        loadAssetChart(symbol, assetId);
    }

    function loadAssetChart(symbol, assetId) {
        if (!symbol || !assetId) return;
        
        const widget = getAssetChartWidget();
        if (!widget) return;

        // Remove placeholder
        const placeholder = document.querySelector('.chart-placeholder');
        if (placeholder) {
            placeholder.style.display = 'none';
        }

        widget.setAsset(symbol, assetId);
        widget.setHours(ASSET_CHART_WINDOW_HOURS);
        widget.refresh();
        widget.startAutoRefresh();
        setTimeout(() => widget.resizeToContainer(), 100);

        // Update header title
        const titleEl = document.getElementById('chart-asset-name');
        if (titleEl) {
            titleEl.textContent = `${symbol} Realtime Chart`;
        }
    }

    // Tab switching function
    function switchBottomTab(tabName, buttonElement) {
        // Hide all tab content
        document.querySelectorAll('.bottom-tab-content').forEach(content => {
            content.classList.remove('active');
        });
        
        // Remove active class from all buttons
        document.querySelectorAll('.bottom-tab-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        
        // Show selected tab content
        const tabContent = document.getElementById(tabName + '-tab');
        if (tabContent) {
            tabContent.classList.add('active');
        }
        
        // Activate selected button if provided
        if (buttonElement) {
            buttonElement.classList.add('active');
        }
    }

    // Function to toggle all signals checkboxes
    function toggleAllSignals(checkbox) {
        const checkboxes = document.querySelectorAll('.signal-checkbox');
        checkboxes.forEach(cb => {
            cb.checked = checkbox.checked;
        });
        updateSelectedCount();
    }

    // ============================================================================
    // Signal Polling & Desktop Notifications
    // ============================================================================
    
    const SIGNAL_POLLING_INTERVAL = 10000; // 10 seconds
    let signalPollingInterval = null;
    let lastSignalCheckTime = new Date().toISOString();
    let notificationsEnabled = false;
    
    /**
     * Request notification permission from the user.
     */
    function requestNotificationPermission() {
        if (!('Notification' in window)) {
            console.log('Browser does not support notifications');
            return Promise.resolve('denied');
        }
        
        if (Notification.permission === 'granted') {
            return Promise.resolve('granted');
        }
        
        if (Notification.permission !== 'denied') {
            return Notification.requestPermission();
        }
        
        return Promise.resolve(Notification.permission);
    }
    
    /**
     * Toggle notifications on/off.
     */
    function toggleNotifications() {
        const icon = document.getElementById('notification-icon');
        const btn = document.getElementById('notification-toggle');
        
        if (notificationsEnabled) {
            // Disable notifications
            notificationsEnabled = false;
            icon.classList.remove('bi-bell-fill');
            icon.classList.add('bi-bell');
            btn.classList.remove('btn-success');
            btn.classList.add('btn-outline-light');
            btn.title = 'Benachrichtigungen aktivieren';
        } else {
            // Try to enable notifications
            requestNotificationPermission().then(function(permission) {
                if (permission === 'granted') {
                    notificationsEnabled = true;
                    icon.classList.remove('bi-bell');
                    icon.classList.add('bi-bell-fill');
                    btn.classList.remove('btn-outline-light');
                    btn.classList.add('btn-success');
                    btn.title = 'Benachrichtigungen deaktivieren';
                } else {
                    alert('Benachrichtigungen wurden vom Browser blockiert. Bitte erlauben Sie Benachrichtigungen in den Browser-Einstellungen.');
                }
            });
        }
    }
    
    /**
     * Show a desktop notification for new signals.
     */
    function showSignalNotification(signals) {
        if (!notificationsEnabled || !('Notification' in window) || Notification.permission !== 'granted') {
            return;
        }
        
        const count = signals.length;
        const firstSignal = signals[0];
        
        let title = count === 1 
            ? 'Neues Trading-Signal'
            : `${count} neue Trading-Signale`;
        
        let body = '';
        if (firstSignal) {
            body = `${firstSignal.setup_type_display} - ${firstSignal.direction}`;
            if (firstSignal.trigger_price) {
                body += ` @ ${firstSignal.trigger_price}`;
            }
            if (count > 1) {
                body += `\n+${count - 1} weitere`;
            }
        }
        
        const notification = new Notification(title, {
            body: body,
            icon: '/media/Finoa_192.png',
            tag: 'fiona-signal',
            requireInteraction: false,
        });
        
        // Focus window and navigate to signal detail on click
        notification.onclick = function() {
            window.focus();
            if (firstSignal && firstSignal.id) {
                // Build the URL dynamically using the signal ID
                window.location.href = window.location.origin + '/fiona/signals/' + firstSignal.id + '/';
            }
            notification.close();
        };
        
        // Auto-close after 8 seconds
        setTimeout(function() {
            notification.close();
        }, 8000);
    }
    
    /**
     * Update the UI with new signals.
     */
    function updateUIWithNewSignals(count) {
        // Update badge count
        const badge = document.getElementById('signal-count-badge');
        if (badge) {
            // Get current count from the badge text and add new count
            const currentText = badge.textContent;
            const match = currentText.match(/(\d+)/);
            const currentCount = match ? parseInt(match[1], 10) : 0;
            const newTotal = currentCount + count;
            badge.textContent = `${newTotal} aktive Signale`;
            
            // Add visual pulse effect
            badge.classList.add('badge-pulse');
            setTimeout(function() {
                badge.classList.remove('badge-pulse');
            }, 1000);
        }
        
        // Reload the signal list (full page reload for now, HTMX partial refresh could be added)
        // This ensures we get the complete updated UI with proper Django template rendering
        location.reload();
    }
    
    /**
     * Poll for new signals since the last check.
     */
    function pollForNewSignals() {
        // Get the API URL from the data attribute and replace the placeholder with actual timestamp
        const dashboard = document.querySelector('.fiona-dashboard');
        const apiBase = dashboard ? dashboard.dataset.signalsApiBase : '/fiona/api/signals/since/TIMESTAMP/';
        const url = apiBase.replace('TIMESTAMP', encodeURIComponent(lastSignalCheckTime));
        
        fetch(url, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            },
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            // Update the last check time to the server's 'now' timestamp
            lastSignalCheckTime = data.now;
            
            if (data.count > 0) {
                console.log(`Found ${data.count} new signal(s)`);
                
                // Show desktop notification
                showSignalNotification(data.signals);
                
                // Update the UI
                updateUIWithNewSignals(data.count);
            }
        })
        .catch(error => {
            console.error('Error polling for signals:', error);
        });
    }
    
    /**
     * Start polling for new signals.
     */
    function startSignalPolling() {
        // Don't start if already running
        if (signalPollingInterval) {
            return;
        }
        
        // Set the initial last check time to now
        lastSignalCheckTime = new Date().toISOString();
        
        // Start polling
        signalPollingInterval = setInterval(pollForNewSignals, SIGNAL_POLLING_INTERVAL);
        console.log('Signal polling started');
    }
    
    /**
     * Stop polling for new signals.
     */
    function stopSignalPolling() {
        if (signalPollingInterval) {
            clearInterval(signalPollingInterval);
            signalPollingInterval = null;
            console.log('Signal polling stopped');
        }
    }
    
    /**
     * Initialize notification state based on browser permission.
     */
    function initializeNotificationState() {
        if ('Notification' in window && Notification.permission === 'granted') {
            // Notifications were previously granted, enable them
            notificationsEnabled = true;
            const icon = document.getElementById('notification-icon');
            const btn = document.getElementById('notification-toggle');
            if (icon && btn) {
                icon.classList.remove('bi-bell');
                icon.classList.add('bi-bell-fill');
                btn.classList.remove('btn-outline-light');
                btn.classList.add('btn-success');
                btn.title = 'Benachrichtigungen deaktivieren';
            }
        }
    }
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        initializeNotificationState();
        startSignalPolling();
    });
    
    // Handle visibility changes to conserve resources
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            stopSignalPolling();
        } else {
            startSignalPolling();
        }
    });
</script>
{% endblock %}
