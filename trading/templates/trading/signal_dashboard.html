{% extends 'core/base.html' %}

{% block title %}Fiona - Signal Dashboard{% endblock %}

{% block extra_css %}
<style>
    /* Fiona Trading Dashboard - Dark Mode Styles */
    :root {
        --fiona-bg-dark: #1a1d21;
        --fiona-card-dark: #2d3239;
        --fiona-card-header: #3a4149;
        --fiona-text-light: #e9ecef;
        --fiona-text-muted: #8b949e;
        --fiona-border: #484f58;
        
        /* Signal Colors */
        --signal-long: #28a745;
        --signal-short: #dc3545;
        
        /* Confidence Colors */
        --confidence-high: #28a745;
        --confidence-medium: #ffc107;
        --confidence-low: #dc3545;
        
        /* Risk Colors */
        --risk-green: #28a745;
        --risk-yellow: #ffc107;
        --risk-red: #dc3545;
    }
    
    .fiona-dashboard {
        background-color: var(--fiona-bg-dark);
        min-height: 100vh;
        color: var(--fiona-text-light);
        padding: 1rem;
    }
    
    .fiona-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--fiona-border);
    }
    
    .fiona-header h1 {
        color: var(--fiona-text-light);
        margin: 0;
    }
    
    .fiona-header .badge {
        font-size: 1rem;
        padding: 0.5rem 1rem;
    }
    
    /* Signal Card */
    .signal-card {
        background-color: var(--fiona-card-dark);
        border: 1px solid var(--fiona-border);
        border-radius: 12px;
        margin-bottom: 1.5rem;
        overflow: hidden;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .signal-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    
    .signal-card-header {
        background-color: var(--fiona-card-header);
        padding: 1rem 1.25rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid var(--fiona-border);
    }
    
    .signal-card-body {
        padding: 1.25rem;
    }
    
    .signal-card-footer {
        padding: 1rem 1.25rem;
        background-color: var(--fiona-card-header);
        border-top: 1px solid var(--fiona-border);
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }
    
    /* Setup Type Badge */
    .setup-type-badge {
        font-size: 0.875rem;
        padding: 0.35rem 0.75rem;
        border-radius: 6px;
        font-weight: 600;
    }
    
    .setup-type-BREAKOUT {
        background-color: #2563eb;
        color: white;
    }
    
    .setup-type-EIA_REVERSION {
        background-color: #7c3aed;
        color: white;
    }
    
    .setup-type-EIA_TRENDDAY {
        background-color: #059669;
        color: white;
    }
    
    /* Session Phase Tag */
    .session-phase-tag {
        background-color: var(--fiona-border);
        color: var(--fiona-text-light);
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    /* Direction Badge */
    .direction-badge {
        font-size: 1rem;
        font-weight: 700;
        padding: 0.5rem 1rem;
        border-radius: 6px;
    }
    
    .direction-LONG {
        background-color: var(--signal-long);
        color: white;
    }
    
    .direction-SHORT {
        background-color: var(--signal-short);
        color: white;
    }
    
    /* Confidence Badge */
    .confidence-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.35rem 0.75rem;
        border-radius: 6px;
        font-weight: 600;
    }
    
    .confidence-high {
        background-color: rgba(40, 167, 69, 0.2);
        color: var(--confidence-high);
        border: 1px solid var(--confidence-high);
    }
    
    .confidence-medium {
        background-color: rgba(255, 193, 7, 0.2);
        color: var(--confidence-medium);
        border: 1px solid var(--confidence-medium);
    }
    
    .confidence-low {
        background-color: rgba(220, 53, 69, 0.2);
        color: var(--confidence-low);
        border: 1px solid var(--confidence-low);
    }
    
    /* Risk Badge */
    .risk-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.35rem 0.75rem;
        border-radius: 6px;
        font-weight: 600;
    }
    
    .risk-GREEN {
        background-color: rgba(40, 167, 69, 0.2);
        color: var(--risk-green);
        border: 1px solid var(--risk-green);
    }
    
    .risk-YELLOW {
        background-color: rgba(255, 193, 7, 0.2);
        color: var(--risk-yellow);
        border: 1px solid var(--risk-yellow);
    }
    
    .risk-RED {
        background-color: rgba(220, 53, 69, 0.2);
        color: var(--risk-red);
        border: 1px solid var(--risk-red);
    }
    
    /* Range Info Box */
    .range-info {
        background-color: rgba(0, 0, 0, 0.2);
        border-radius: 8px;
        padding: 0.75rem;
        margin-bottom: 1rem;
    }
    
    .range-info-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.25rem;
    }
    
    .range-info-row:last-child {
        margin-bottom: 0;
    }
    
    .range-label {
        color: var(--fiona-text-muted);
        font-size: 0.875rem;
    }
    
    .range-value {
        font-weight: 600;
        font-family: 'Roboto Mono', monospace;
    }
    
    /* KI Info */
    .ki-info {
        background-color: rgba(0, 0, 0, 0.2);
        border-radius: 8px;
        padding: 0.75rem;
        margin-top: 1rem;
    }
    
    .ki-reasoning {
        color: var(--fiona-text-muted);
        font-size: 0.875rem;
        line-height: 1.5;
        margin-top: 0.5rem;
    }
    
    /* Trade Buttons */
    .btn-trade-live {
        background-color: var(--signal-long);
        border-color: var(--signal-long);
        color: white;
        font-weight: 600;
    }
    
    .btn-trade-live:hover:not(:disabled) {
        background-color: #218838;
        border-color: #1e7e34;
        color: white;
    }
    
    .btn-trade-live:disabled {
        background-color: #6c757d;
        border-color: #6c757d;
        opacity: 0.65;
    }
    
    .btn-trade-shadow {
        background-color: #6c757d;
        border-color: #6c757d;
        color: white;
        font-weight: 600;
    }
    
    .btn-trade-shadow:hover {
        background-color: #545b62;
        border-color: #4e555b;
        color: white;
    }
    
    .btn-trade-reject {
        background-color: transparent;
        border-color: var(--signal-short);
        color: var(--signal-short);
    }
    
    .btn-trade-reject:hover {
        background-color: var(--signal-short);
        color: white;
    }
    
    .btn-trade-details {
        background-color: #3a6ea5;
        border-color: #3a6ea5;
        color: white;
    }
    
    .btn-trade-details:hover {
        background-color: #2e5684;
        border-color: #2e5684;
        color: white;
    }
    
    /* Section Label */
    .section-label {
        color: var(--fiona-text-muted);
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 1px;
        margin-bottom: 0.5rem;
    }
    
    /* Stats Grid */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
    }
    
    .stat-item {
        text-align: center;
    }
    
    .stat-value {
        font-size: 1.25rem;
        font-weight: 700;
        font-family: 'Roboto Mono', monospace;
    }
    
    .stat-label {
        font-size: 0.75rem;
        color: var(--fiona-text-muted);
        text-transform: uppercase;
    }
    
    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        color: var(--fiona-text-muted);
    }
    
    .empty-state i {
        font-size: 4rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }
    
    /* Account Info Card */
    .account-info-card {
        background-color: var(--fiona-card-dark);
        border: 1px solid var(--fiona-border);
        border-radius: 12px;
        padding: 1rem 1.25rem;
        margin-bottom: 1.5rem;
    }
    
    .account-info-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
    }
    
    .account-info-header h5 {
        margin: 0;
        color: var(--fiona-text-light);
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .account-info-status {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.75rem;
    }
    
    .account-info-status.connected {
        color: var(--signal-long);
    }
    
    .account-info-status.disconnected {
        color: var(--signal-short);
    }
    
    .account-info-status.loading {
        color: var(--fiona-text-muted);
    }
    
    .account-info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
    }
    
    .account-info-item {
        text-align: center;
        padding: 0.5rem;
        background-color: rgba(0, 0, 0, 0.2);
        border-radius: 8px;
    }
    
    .account-info-value {
        font-size: 1.25rem;
        font-weight: 700;
        font-family: 'Roboto Mono', monospace;
        color: var(--fiona-text-light);
    }
    
    .account-info-value.positive {
        color: var(--signal-long);
    }
    
    .account-info-value.negative {
        color: var(--signal-short);
    }
    
    .account-info-label {
        font-size: 0.75rem;
        color: var(--fiona-text-muted);
        text-transform: uppercase;
        margin-top: 0.25rem;
    }
    
    .account-info-error {
        color: var(--signal-short);
        font-size: 0.875rem;
        text-align: center;
        padding: 1rem;
    }
    
    /* Broker Tabs */
    .broker-tabs {
        display: flex;
        gap: 0.25rem;
    }
    
    .broker-tab-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.25rem 0.6rem;
        font-size: 0.75rem;
        border-radius: 4px;
        background-color: rgba(0, 0, 0, 0.3);
        border: 1px solid var(--fiona-border);
        color: var(--fiona-text-muted);
        cursor: pointer;
        transition: all 0.2s;
        font-weight: 500;
    }
    
    .broker-tab-btn:hover {
        background-color: rgba(0, 0, 0, 0.5);
        color: var(--fiona-text-light);
    }
    
    .broker-tab-btn.active {
        background-color: #2563eb;
        border-color: #2563eb;
        color: white;
    }
    
    .broker-status-dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background-color: var(--fiona-text-muted);
    }
    
    .broker-status-dot.connected {
        background-color: var(--signal-long);
    }
    
    .broker-status-dot.disconnected {
        background-color: var(--signal-short);
    }
    
    .broker-status-dot.loading {
        background-color: var(--confidence-medium);
        animation: pulse-dot 1s ease-in-out infinite;
    }
    
    @keyframes pulse-dot {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.4; }
    }
    
    .broker-content {
        display: none;
    }
    
    .broker-content.active {
        display: block;
    }
    
    .refresh-btn {
        background: transparent;
        border: none;
        color: var(--fiona-text-muted);
        cursor: pointer;
        padding: 0.25rem;
        transition: color 0.2s;
    }
    
    .refresh-btn:hover {
        color: var(--fiona-text-light);
    }
    
    .refresh-btn.spinning i {
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    
    /* Worker Status Card */
    .worker-status-card {
        background-color: var(--fiona-card-dark);
        border: 1px solid var(--fiona-border);
        border-radius: 12px;
        padding: 1rem 1.25rem;
        margin-bottom: 1.5rem;
    }
    
    .worker-status-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
    }
    
    .worker-status-header h5 {
        margin: 0;
        color: var(--fiona-text-light);
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .worker-status-indicator {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.875rem;
        font-weight: 600;
        padding: 0.25rem 0.75rem;
        border-radius: 6px;
    }
    
    .worker-status-indicator.online {
        background-color: rgba(40, 167, 69, 0.2);
        color: var(--signal-long);
        border: 1px solid var(--signal-long);
    }
    
    .worker-status-indicator.offline {
        background-color: rgba(220, 53, 69, 0.2);
        color: var(--signal-short);
        border: 1px solid var(--signal-short);
    }
    
    .worker-status-indicator.no-data {
        background-color: rgba(108, 117, 125, 0.2);
        color: var(--fiona-text-muted);
        border: 1px solid var(--fiona-border);
    }
    
    .worker-status-indicator.loading {
        background-color: rgba(108, 117, 125, 0.2);
        color: var(--fiona-text-muted);
        border: 1px solid var(--fiona-border);
    }
    
    .worker-status-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 0.75rem;
    }
    
    .worker-status-item {
        text-align: center;
        padding: 0.5rem;
        background-color: rgba(0, 0, 0, 0.2);
        border-radius: 8px;
    }
    
    .worker-status-value {
        font-size: 1rem;
        font-weight: 700;
        font-family: 'Roboto Mono', monospace;
        color: var(--fiona-text-light);
    }
    
    .worker-status-label {
        font-size: 0.7rem;
        color: var(--fiona-text-muted);
        text-transform: uppercase;
        margin-top: 0.25rem;
    }
    
    .worker-diagnostic {
        margin-top: 0.75rem;
        padding: 0.5rem 0.75rem;
        background-color: rgba(0, 0, 0, 0.2);
        border-radius: 8px;
        font-size: 0.85rem;
        color: var(--fiona-text-muted);
    }
    
    .worker-diagnostic .label {
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 0.25rem;
        color: var(--fiona-text-muted);
    }
    
    .worker-diagnostic .message {
        color: var(--fiona-text-light);
    }
    
    .worker-status-error {
        color: var(--signal-short);
        font-size: 0.875rem;
        text-align: center;
        padding: 1rem;
    }
    
    /* Breakout Range Diagnostics Card */
    .range-diagnostics-card {
        background-color: var(--fiona-card-dark);
        border: 1px solid var(--fiona-border);
        border-radius: 12px;
        padding: 1rem 1.25rem;
        margin-bottom: 1.5rem;
    }
    
    .range-diagnostics-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
    }
    
    .range-diagnostics-header h5 {
        margin: 0;
        color: var(--fiona-text-light);
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .range-type-selector {
        display: flex;
        gap: 0.5rem;
    }
    
    .range-type-btn {
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
        border-radius: 4px;
        background-color: rgba(0, 0, 0, 0.3);
        border: 1px solid var(--fiona-border);
        color: var(--fiona-text-muted);
        cursor: pointer;
    }
    
    .range-type-btn.active {
        background-color: #2563eb;
        border-color: #2563eb;
        color: white;
    }
    
    .range-diagnostics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 0.75rem;
    }
    
    .range-diagnostics-item {
        text-align: center;
        padding: 0.5rem;
        background-color: rgba(0, 0, 0, 0.2);
        border-radius: 8px;
    }
    
    .range-diagnostics-value {
        font-size: 1rem;
        font-weight: 700;
        font-family: 'Roboto Mono', monospace;
        color: var(--fiona-text-light);
    }
    
    .range-diagnostics-label {
        font-size: 0.7rem;
        color: var(--fiona-text-muted);
        text-transform: uppercase;
        margin-top: 0.25rem;
    }
    
    .range-status-indicator {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 600;
    }
    
    .range-status-indicator.valid {
        background-color: rgba(40, 167, 69, 0.2);
        color: var(--signal-long);
        border: 1px solid var(--signal-long);
    }
    
    .range-status-indicator.invalid {
        background-color: rgba(220, 53, 69, 0.2);
        color: var(--signal-short);
        border: 1px solid var(--signal-short);
    }
    
    .range-status-indicator.pending {
        background-color: rgba(255, 193, 7, 0.2);
        color: var(--confidence-medium);
        border: 1px solid var(--confidence-medium);
    }
    
    .range-status-indicator.no-data {
        background-color: rgba(108, 117, 125, 0.2);
        color: var(--fiona-text-muted);
        border: 1px solid var(--fiona-border);
    }
    
    .price-position-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.2rem 0.5rem;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 600;
    }
    
    .price-position-badge.above {
        background-color: rgba(40, 167, 69, 0.2);
        color: var(--signal-long);
    }
    
    .price-position-badge.inside {
        background-color: rgba(255, 193, 7, 0.2);
        color: var(--confidence-medium);
    }
    
    .price-position-badge.below {
        background-color: rgba(220, 53, 69, 0.2);
        color: var(--signal-short);
    }
    
    .range-diagnostic-message {
    /* Diagnostic Criteria List - Accordion Style */
    .diagnostic-criteria {
        margin-top: 0.75rem;
        background-color: rgba(0, 0, 0, 0.2);
        border-radius: 8px;
        overflow: hidden;
    }
    
    .diagnostic-criteria-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.5rem 0.75rem;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    
    .diagnostic-criteria-header:hover {
        background-color: rgba(255, 255, 255, 0.05);
    }
    
    .diagnostic-criteria .label {
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--fiona-text-muted);
        margin: 0;
    }
    
    .diagnostic-criteria-toggle {
        color: var(--fiona-text-muted);
        font-size: 0.8rem;
        transition: transform 0.2s;
    }
    
    .diagnostic-criteria-toggle.expanded {
        transform: rotate(180deg);
    }
    
    .diagnostic-criteria-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-out;
        padding: 0 0.75rem;
    }
    
    .diagnostic-criteria-content.expanded {
        max-height: 500px;
        padding: 0 0.75rem 0.5rem 0.75rem;
    }
    
    .criteria-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    
    .criteria-item {
        display: flex;
        align-items: flex-start;
        gap: 0.5rem;
        padding: 0.25rem 0;
        font-size: 0.8rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .criteria-item:last-child {
        border-bottom: none;
    }
    
    .criteria-icon {
        flex-shrink: 0;
        font-size: 0.9rem;
    }
    
    .criteria-icon.passed {
        color: var(--signal-long);
    }
    
    .criteria-icon.failed {
        color: var(--signal-short);
    }
    
    .criteria-content {
        flex: 1;
    }
    
    .criteria-name {
        color: var(--fiona-text-light);
        font-weight: 500;
    }
    
    .criteria-detail {
        color: var(--fiona-text-muted);
        font-size: 0.75rem;
        margin-top: 0.1rem;
    }
    
    /* Countdown Timer */
    .worker-countdown {
        margin-top: 0.75rem;
        padding: 0.5rem 0.75rem;
        background-color: rgba(0, 0, 0, 0.2);
        border-radius: 8px;
        font-size: 0.85rem;
    }
    
    .range-diagnostic-message .label {
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 0.25rem;
        color: var(--fiona-text-muted);
    }
    
    .range-diagnostic-message .message {
        color: var(--fiona-text-light);
    }
    
    .range-config-section {
        margin-top: 0.75rem;
        padding: 0.5rem 0.75rem;
        background-color: rgba(0, 0, 0, 0.15);
        border-radius: 8px;
        font-size: 0.8rem;
    }
    
    .range-config-section .label {
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 0.5rem;
        color: var(--fiona-text-muted);
    }
    
    .range-config-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
        gap: 0.5rem;
    }
    
    .range-config-item {
        display: flex;
        justify-content: space-between;
        padding: 0.25rem 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .range-config-item:last-child {
        border-bottom: none;
    }
    
    .range-config-key {
        color: var(--fiona-text-muted);
    }
    
    .range-config-value {
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    .countdown-label {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--fiona-text-muted);
    }
    
    .countdown-value {
        font-size: 1.1rem;
        font-weight: 700;
        font-family: 'Roboto Mono', monospace;
        color: var(--fiona-text-light);
    }
    
    .range-diagnostics-error {
        color: var(--signal-short);
        font-size: 0.875rem;
        text-align: center;
        padding: 1rem;
    }
    
    /* =========================================================
     * Price vs Range - Live Status Card Styles
     * ========================================================= */
    .price-range-status-card {
        background-color: var(--fiona-card-dark);
        border: 1px solid var(--fiona-border);
        border-radius: 12px;
        padding: 1rem 1.25rem;
        margin-bottom: 1.5rem;
    }
    
    .price-range-status-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
        flex-wrap: wrap;
        gap: 0.5rem;
    }
    
    .price-range-status-header h5 {
        margin: 0;
        color: var(--fiona-text-light);
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .price-range-phase-tabs {
        display: flex;
        gap: 0.25rem;
    }
    
    .phase-tab-btn {
        padding: 0.25rem 0.5rem;
        font-size: 0.7rem;
        border-radius: 4px;
        background-color: rgba(0, 0, 0, 0.3);
        border: 1px solid var(--fiona-border);
        color: var(--fiona-text-muted);
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .phase-tab-btn:hover {
        background-color: rgba(0, 0, 0, 0.5);
        color: var(--fiona-text-light);
    }
    
    .phase-tab-btn.active {
        background-color: #2563eb;
        border-color: #2563eb;
        color: white;
    }
    
    /* Price Range Content */
    .price-range-content {
        padding: 0.5rem 0;
    }
    
    .price-range-status-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-size: 0.9rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 1rem;
    }
    
    .price-range-status-badge.status-inside_range {
        background-color: rgba(40, 167, 69, 0.2);
        color: var(--signal-long);
        border: 1px solid var(--signal-long);
    }
    
    .price-range-status-badge.status-near_breakout_long,
    .price-range-status-badge.status-near_breakout_short {
        background-color: rgba(255, 193, 7, 0.2);
        color: var(--confidence-medium);
        border: 1px solid var(--confidence-medium);
    }
    
    .price-range-status-badge.status-breakout_long,
    .price-range-status-badge.status-breakout_short {
        background-color: rgba(220, 53, 69, 0.2);
        color: var(--signal-short);
        border: 1px solid var(--signal-short);
    }
    
    .price-range-status-badge.status-no_range {
        background-color: rgba(108, 117, 125, 0.2);
        color: var(--fiona-text-muted);
        border: 1px solid var(--fiona-border);
    }
    
    /* Two-column grid for range data vs live metrics */
    .price-range-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
    }
    
    .price-range-column {
        background-color: rgba(0, 0, 0, 0.2);
        border-radius: 8px;
        padding: 0.75rem;
    }
    
    .column-label {
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--fiona-text-muted);
        margin-bottom: 0.5rem;
        padding-bottom: 0.25rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .data-row {
        display: flex;
        justify-content: space-between;
        padding: 0.35rem 0;
        font-size: 0.85rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .data-row:last-child {
        border-bottom: none;
    }
    
    .data-label {
        color: var(--fiona-text-muted);
    }
    
    .data-value {
        font-weight: 600;
        font-family: 'Roboto Mono', monospace;
        color: var(--fiona-text-light);
    }
    
    .data-value.price-value {
        color: #17a2b8;
    }
    
    .data-value.distance-above {
        color: var(--signal-long);
    }
    
    .data-value.distance-below {
        color: var(--signal-short);
    }
    
    .data-value.phase-value {
        color: #6c757d;
        font-size: 0.75rem;
    }
    
    /* Fallback/Error state */
    .price-range-fallback {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        padding: 1.5rem;
        color: var(--fiona-text-muted);
        font-size: 0.85rem;
    }
    
    .price-range-fallback i {
        font-size: 1.1rem;
    }
    
    /* Responsive for Price Range Card */
    @media (max-width: 768px) {
        .price-range-grid {
            grid-template-columns: 1fr;
            gap: 1rem;
        }
        
        .price-range-status-header {
            flex-direction: column;
            align-items: flex-start;
        }
        
        .price-range-phase-tabs {
            flex-wrap: wrap;
        }
    }
    
    .countdown-value.imminent {
        color: var(--confidence-medium);
    }
    
    /* Badge pulse animation for new signals */
    .badge-pulse {
        animation: pulse 1s ease-in-out;
    }
    
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.2); background-color: #ffc107; }
        100% { transform: scale(1); }
    }
    
    /* Notification toggle button styles */
    #notification-toggle.btn-success {
        background-color: var(--signal-long);
        border-color: var(--signal-long);
    }
    
    #notification-toggle.btn-success:hover {
        background-color: #218838;
        border-color: #1e7e34;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
        .signal-card-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.5rem;
        }
        
        .signal-card-footer {
            justify-content: center;
        }
        
        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .account-info-grid {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .worker-status-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="fiona-dashboard" data-signals-api-base="{% url 'api_signals_since' 'TIMESTAMP' %}">
    <div class="container-fluid">
        <div class="fiona-header">
            <div>
                <h1>
                    <i class="bi bi-graph-up-arrow"></i> Fiona Signal Dashboard
                </h1>
                <small class="text-muted">Trading Signal Management v1.0</small>
            </div>
            <div class="d-flex gap-2 align-items-center">
                <span id="signal-count-badge" class="badge bg-success">{{ active_count }} aktive Signale</span>
                <!-- Notification toggle button -->
                <button id="notification-toggle" class="btn btn-sm btn-outline-light" onclick="toggleNotifications()" title="Benachrichtigungen">
                    <i id="notification-icon" class="bi bi-bell"></i>
                </button>
                <a href="{% url 'breakout_distance_chart' %}" class="btn btn-sm btn-outline-light" title="Breakout Chart">
                    <i class="bi bi-graph-up"></i> Chart
                </a>
                <a href="{% url 'trading_diagnostics' %}" class="btn btn-sm btn-outline-light" title="Trading Diagnostics">
                    <i class="bi bi-activity"></i> Diagnostics
                </a>
                <a href="{% url 'asset_list' %}" class="btn btn-sm btn-outline-light">
                    <i class="bi bi-box-seam"></i> Assets
                </a>
                <a href="{% url 'trade_history' %}" class="btn btn-sm btn-outline-light">
                    <i class="bi bi-clock-history"></i> Historie
                </a>
            </div>
        </div>
        
        <!-- Account Info Card - Multi-Broker -->
        <div class="account-info-card" id="account-info">
            <div class="account-info-header">
                <h5><i class="bi bi-bank"></i> Konto &amp; Margin</h5>
                <div class="d-flex align-items-center gap-2">
                    <!-- Broker Tabs -->
                    <div class="broker-tabs">
                        <button class="broker-tab-btn active" data-broker="ig" onclick="selectBrokerTab('ig')">
                            <span class="broker-status-dot" id="ig-status-dot"></span>
                            IG
                        </button>
                        <button class="broker-tab-btn" data-broker="mexc" onclick="selectBrokerTab('mexc')">
                            <span class="broker-status-dot" id="mexc-status-dot"></span>
                            MEXC
                        </button>
                    </div>
                    <button class="refresh-btn" id="refresh-account-btn" onclick="refreshAllBrokersAccountState()" title="Aktualisieren">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                </div>
            </div>
            
            <!-- IG Broker Content -->
            <div id="ig-account-content" class="broker-content active">
                <div class="account-info-grid">
                    <div class="account-info-item">
                        <div class="account-info-value" id="ig-balance">--</div>
                        <div class="account-info-label">Kontostand</div>
                    </div>
                    <div class="account-info-item">
                        <div class="account-info-value" id="ig-available">--</div>
                        <div class="account-info-label">Verfügbar</div>
                    </div>
                    <div class="account-info-item">
                        <div class="account-info-value" id="ig-margin-used">--</div>
                        <div class="account-info-label">Margin (genutzt)</div>
                    </div>
                    <div class="account-info-item">
                        <div class="account-info-value" id="ig-margin-available">--</div>
                        <div class="account-info-label">Margin (verfügbar)</div>
                    </div>
                    <div class="account-info-item">
                        <div class="account-info-value" id="ig-pnl">--</div>
                        <div class="account-info-label">Unrealisiert P&amp;L</div>
                    </div>
                </div>
            </div>
            
            <!-- MEXC Broker Content -->
            <div id="mexc-account-content" class="broker-content">
                <div class="account-info-grid">
                    <div class="account-info-item">
                        <div class="account-info-value" id="mexc-balance">--</div>
                        <div class="account-info-label">Kontostand</div>
                    </div>
                    <div class="account-info-item">
                        <div class="account-info-value" id="mexc-available">--</div>
                        <div class="account-info-label">Verfügbar</div>
                    </div>
                    <div class="account-info-item">
                        <div class="account-info-value" id="mexc-margin-used">--</div>
                        <div class="account-info-label">Margin (genutzt)</div>
                    </div>
                    <div class="account-info-item">
                        <div class="account-info-value" id="mexc-margin-available">--</div>
                        <div class="account-info-label">Margin (verfügbar)</div>
                    </div>
                    <div class="account-info-item">
                        <div class="account-info-value" id="mexc-pnl">--</div>
                        <div class="account-info-label">Unrealisiert P&amp;L</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Worker Status Card -->
        <div class="worker-status-card" id="worker-status">
            <div class="worker-status-header">
                <h5><i class="bi bi-cpu"></i> Worker Status</h5>
                <div class="d-flex align-items-center gap-2">
                    <span id="worker-status-indicator" class="worker-status-indicator loading">
                        <i class="bi bi-circle-fill"></i>
                        <span>Lädt...</span>
                    </span>
                    <button class="refresh-btn" id="refresh-worker-btn" onclick="refreshWorkerStatus()" title="Aktualisieren">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                </div>
            </div>
            <div id="worker-status-content">
                <div class="worker-status-grid">
                    <div class="worker-status-item">
                        <div class="worker-status-value" id="worker-last-activity">--</div>
                        <div class="worker-status-label">Letzte Aktivität</div>
                    </div>
                    <div class="worker-status-item">
                        <div class="worker-status-value" id="worker-phase">--</div>
                        <div class="worker-status-label">Phase</div>
                    </div>
                    <div class="worker-status-item">
                        <div class="worker-status-value" id="worker-epic">--</div>
                        <div class="worker-status-label">Epic</div>
                    </div>
                    <div class="worker-status-item">
                        <div class="worker-status-value" id="worker-price">--</div>
                        <div class="worker-status-label">Preis (Bid/Ask)</div>
                    </div>
                    <div class="worker-status-item">
                        <div class="worker-status-value" id="worker-setup-count">--</div>
                        <div class="worker-status-label">Setups gefunden</div>
                    </div>
                    <div class="worker-status-item">
                        <div class="worker-status-value" id="worker-interval">--</div>
                        <div class="worker-status-label">Intervall</div>
                    </div>
                </div>
                <!-- Countdown Timer -->
                <div class="worker-countdown" id="worker-countdown">
                    <span class="countdown-label"><i class="bi bi-clock"></i> Nächster Lauf in</span>
                    <span class="countdown-value" id="worker-countdown-value">--</span>
                </div>
                <div class="worker-diagnostic" id="worker-diagnostic">
                    <div class="label">Diagnose</div>
                    <div class="message" id="worker-diagnostic-message">--</div>
                </div>
                <!-- Diagnostic Criteria List - Accordion -->
                <div class="diagnostic-criteria" id="diagnostic-criteria">
                    <div class="diagnostic-criteria-header" onclick="toggleCriteriaAccordion()">
                        <div class="label">Kriterien-Prüfung</div>
                        <span class="diagnostic-criteria-toggle" id="criteria-toggle"><i class="bi bi-chevron-down"></i></span>
                    </div>
                    <div class="diagnostic-criteria-content" id="criteria-content">
                        <ul class="criteria-list" id="criteria-list">
                            <li class="criteria-item">
                                <span class="criteria-icon"><i class="bi bi-dash"></i></span>
                            <span class="criteria-content">
                                <span class="criteria-name">Keine Daten</span>
                            </span>
                        </li>
                    </ul>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Breakout Range Diagnostics Card -->
        <div class="range-diagnostics-card" id="range-diagnostics">
            <div class="range-diagnostics-header">
                <h5><i class="bi bi-arrows-expand"></i> Breakout Range Diagnose</h5>
                <div class="d-flex align-items-center gap-2">
                    <!-- Asset Selector -->
                    <select id="range-asset-selector" class="form-select form-select-sm" style="width: auto; min-width: 120px; background-color: rgba(0, 0, 0, 0.3); border: 1px solid var(--fiona-border); color: var(--fiona-text-light); font-size: 0.75rem; padding: 0.25rem 0.5rem;" onchange="selectRangeAsset(this.value)">
                        {% for asset in active_assets %}
                        <option value="{{ asset.id }}" data-epic="{{ asset.epic }}">{{ asset.symbol }}</option>
                        {% empty %}
                        <option value="">Keine Assets</option>
                        {% endfor %}
                    </select>
                    <div class="range-type-selector">
                        <button class="range-type-btn active" data-range-type="asia" onclick="selectRangeType('asia')">Asia Range</button>
                        <button class="range-type-btn" data-range-type="london_core" onclick="selectRangeType('london_core')">London Core</button>
                        <button class="range-type-btn" data-range-type="pre_us" onclick="selectRangeType('pre_us')">Pre-US Range</button>
                    </div>
                    <button class="refresh-btn" id="refresh-range-btn" onclick="refreshRangeDiagnostics()" title="Aktualisieren">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                </div>
            </div>
            <div id="range-diagnostics-content">
                <div class="range-diagnostics-grid">
                    <div class="range-diagnostics-item">
                        <div class="range-diagnostics-value" id="range-high">--</div>
                        <div class="range-diagnostics-label">Range High</div>
                    </div>
                    <div class="range-diagnostics-item">
                        <div class="range-diagnostics-value" id="range-low">--</div>
                        <div class="range-diagnostics-label">Range Low</div>
                    </div>
                    <div class="range-diagnostics-item">
                        <div class="range-diagnostics-value" id="range-height">--</div>
                        <div class="range-diagnostics-label">Range Höhe</div>
                    </div>
                    <div class="range-diagnostics-item">
                        <div class="range-diagnostics-value" id="range-height-ticks">--</div>
                        <div class="range-diagnostics-label">Ticks</div>
                    </div>
                    <div class="range-diagnostics-item">
                        <div class="range-diagnostics-value" id="range-current-price">--</div>
                        <div class="range-diagnostics-label">Aktueller Preis</div>
                    </div>
                    <div class="range-diagnostics-item">
                        <div class="range-diagnostics-value" id="range-price-position">--</div>
                        <div class="range-diagnostics-label">Position</div>
                    </div>
                </div>
                
                <!-- Status Badges Row -->
                <div class="d-flex flex-wrap gap-2 mt-3 mb-2">
                    <span id="range-validation-badge" class="range-status-indicator no-data">
                        <i class="bi bi-circle-fill"></i>
                        <span>--</span>
                    </span>
                    <span id="breakout-status-badge" class="range-status-indicator no-data">
                        <i class="bi bi-lightning-fill"></i>
                        <span>--</span>
                    </span>
                </div>
                
                <!-- Configuration Section (collapsible) -->
                <div class="range-config-section" id="range-config-section">
                    <div class="label">Konfiguration</div>
                    <div class="range-config-grid">
                        <div class="range-config-item">
                            <span class="range-config-key">min_range_ticks</span>
                            <span class="range-config-value" id="config-min-ticks">--</span>
                        </div>
                        <div class="range-config-item">
                            <span class="range-config-key">max_range_ticks</span>
                            <span class="range-config-value" id="config-max-ticks">--</span>
                        </div>
                        <div class="range-config-item">
                            <span class="range-config-key">min_body_fraction</span>
                            <span class="range-config-value" id="config-body-fraction">--</span>
                        </div>
                        <div class="range-config-item">
                            <span class="range-config-key">tick_size</span>
                            <span class="range-config-value" id="config-tick-size">--</span>
                        </div>
                    </div>
                </div>
                
                <!-- Diagnostic Message -->
                <div class="range-diagnostic-message" id="range-diagnostic-message-section">
                    <div class="label">Diagnose</div>
                    <div class="message" id="range-diagnostic-message">--</div>
                </div>
            </div>
        </div>
        
        <!-- Price vs Range - Live Status Panel -->
        <div class="price-range-status-card" id="price-range-status">
            <div class="price-range-status-header">
                <h5><i class="bi bi-crosshair"></i> Price vs Range – Live Status</h5>
                <div class="d-flex align-items-center gap-2">
                    <!-- Asset Selector (synced with range diagnostics) -->
                    <select id="price-range-asset-selector" class="form-select form-select-sm" style="width: auto; min-width: 120px; background-color: rgba(0, 0, 0, 0.3); border: 1px solid var(--fiona-border); color: var(--fiona-text-light); font-size: 0.75rem; padding: 0.25rem 0.5rem;" onchange="selectPriceRangeAsset(this.value)">
                        {% for asset in active_assets %}
                        <option value="{{ asset.id }}">{{ asset.symbol }}</option>
                        {% empty %}
                        <option value="">Keine Assets</option>
                        {% endfor %}
                    </select>
                    <!-- Phase Tabs -->
                    <div class="price-range-phase-tabs">
                        <button class="phase-tab-btn active" data-phase="ASIA_RANGE" onclick="selectPriceRangePhase('ASIA_RANGE')">Asia</button>
                        <button class="phase-tab-btn" data-phase="LONDON_CORE" onclick="selectPriceRangePhase('LONDON_CORE')">London</button>
                        <button class="phase-tab-btn" data-phase="PRE_US_RANGE" onclick="selectPriceRangePhase('PRE_US_RANGE')">Pre-US</button>
                        <button class="phase-tab-btn" data-phase="US_CORE_TRADING" onclick="selectPriceRangePhase('US_CORE_TRADING')">US Core</button>
                    </div>
                    <button class="refresh-btn" id="refresh-price-range-btn" onclick="refreshPriceRangeStatus()" title="Aktualisieren">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                </div>
            </div>
            <div id="price-range-status-content"
                 hx-get="{% url 'htmx_price_range_status' %}"
                 hx-trigger="load"
                 hx-swap="innerHTML">
                <div class="price-range-fallback">
                    <i class="bi bi-hourglass-split"></i>
                    <span>Lade Status...</span>
                </div>
            </div>
        </div>
        
        <!-- Signal List Container (refreshable via HTMX) -->
        <div id="signal-list-container">
        {% if signals %}
        <div class="row" id="signals-row">
            {% for signal in signals %}
            <div class="col-lg-6 col-xl-4">
                <div class="signal-card">
                    <div class="signal-card-header">
                        <div class="d-flex align-items-center gap-2">
                            <span class="setup-type-badge setup-type-{% if signal.setup_type %}{{ signal.setup_type }}{% else %}BREAKOUT{% endif %}">
                                {% if signal.setup_type_display %}
                                    {{ signal.setup_type_display }}
                                {% else %}
                                    {{ signal.get_setup_type_display }}
                                {% endif %}
                            </span>
                            <span class="session-phase-tag">
                                {% if signal.session_phase_display %}
                                    {{ signal.session_phase_display }}
                                {% else %}
                                    {{ signal.get_session_phase_display }}
                                {% endif %}
                            </span>
                        </div>
                        <span class="direction-badge direction-{{ signal.direction }}">
                            {% if signal.direction == 'LONG' %}
                                <i class="bi bi-arrow-up-circle-fill"></i>
                            {% else %}
                                <i class="bi bi-arrow-down-circle-fill"></i>
                            {% endif %}
                            {{ signal.direction }}
                        </span>
                    </div>
                    
                    <div class="signal-card-body">
                        <!-- Range Info -->
                        <div class="range-info">
                            <div class="section-label">Range Info</div>
                            <div class="range-info-row">
                                <span class="range-label">Range High</span>
                                <span class="range-value">{{ signal.range_high }}</span>
                            </div>
                            <div class="range-info-row">
                                <span class="range-label">Range Low</span>
                                <span class="range-value">{{ signal.range_low }}</span>
                            </div>
                            <div class="range-info-row">
                                <span class="range-label">Trigger</span>
                                <span class="range-value text-warning">{{ signal.trigger_price }}</span>
                            </div>
                        </div>
                        
                        <!-- Stats -->
                        <div class="stats-grid">
                            <div class="stat-item">
                                <div class="stat-value text-danger">{{ signal.stop_loss }}</div>
                                <div class="stat-label">SL</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value text-success">{{ signal.take_profit }}</div>
                                <div class="stat-label">TP</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">{{ signal.position_size }}</div>
                                <div class="stat-label">Size</div>
                            </div>
                        </div>
                        
                        <!-- KI & Risk Badges -->
                        <div class="d-flex flex-wrap gap-2 mt-3">
                            {% with gpt_conf=signal.gpt_confidence|floatformat:0 %}
                            <span class="confidence-badge {% if gpt_conf >= 80 %}confidence-high{% elif gpt_conf >= 60 %}confidence-medium{% else %}confidence-low{% endif %}">
                                <i class="bi bi-cpu"></i> GPT {{ gpt_conf }}%
                            </span>
                            {% endwith %}
                            
                            <span class="risk-badge risk-{{ signal.risk_status }}">
                                {% if signal.risk_status == 'GREEN' %}
                                    <i class="bi bi-check-circle-fill"></i> Erlaubt
                                {% elif signal.risk_status == 'YELLOW' %}
                                    <i class="bi bi-exclamation-triangle-fill"></i> Riskant
                                {% else %}
                                    <i class="bi bi-x-circle-fill"></i> Verboten
                                {% endif %}
                            </span>
                        </div>
                        
                        <!-- KI Reasoning -->
                        <div class="ki-info">
                            <div class="section-label">KI-Begründung</div>
                            <p class="ki-reasoning mb-0">{{ signal.ki_reasoning|truncatechars:120 }}</p>
                        </div>
                    </div>
                    
                    <div class="signal-card-footer">
                        <a href="{% url 'signal_detail' signal.id %}" class="btn btn-trade-details btn-sm">
                            <i class="bi bi-eye"></i> Details
                        </a>
                        
                        <button class="btn btn-trade-live btn-sm" 
                                {% if not signal.can_execute_live %}disabled{% endif %}
                                onclick="executeTrade('{{ signal.id }}', 'live')">
                            <i class="bi bi-lightning-fill"></i> Live Trade
                        </button>
                        
                        <button class="btn btn-trade-shadow btn-sm"
                                onclick="executeTrade('{{ signal.id }}', 'shadow')">
                            <i class="bi bi-eye-slash"></i> Shadow
                        </button>
                        
                        <button class="btn btn-trade-reject btn-sm"
                                onclick="rejectSignal('{{ signal.id }}')">
                            <i class="bi bi-x-lg"></i>
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state" id="empty-state">
            <i class="bi bi-graph-up-arrow"></i>
            <h3>Keine aktiven Signale</h3>
            <p>Es sind derzeit keine aktiven Trading-Signale vorhanden.</p>
        </div>
        {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    function executeTrade(signalId, tradeType) {
        const url = tradeType === 'live' 
            ? `/fiona/signals/${signalId}/live/`
            : `/fiona/signals/${signalId}/shadow/`;
        
        fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert('Fehler: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Ein Fehler ist aufgetreten.');
        });
    }
    
    function rejectSignal(signalId) {
        if (!confirm('Signal wirklich verwerfen?')) {
            return;
        }
        
        fetch(`/fiona/signals/${signalId}/reject/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert('Fehler: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Ein Fehler ist aufgetreten.');
        });
    }
    
    // Account state auto-refresh functionality
    let accountRefreshInterval = null;
    const REFRESH_INTERVAL = 30000; // 30 seconds
    let currentBrokerTab = 'ig';  // Default to IG
    
    function formatCurrency(value, currency) {
        const num = parseFloat(value);
        if (isNaN(num)) return '--';
        return new Intl.NumberFormat('de-DE', {
            style: 'currency',
            currency: currency || 'EUR',
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        }).format(num);
    }
    
    function selectBrokerTab(broker) {
        currentBrokerTab = broker;
        
        // Update tab button states
        document.querySelectorAll('.broker-tab-btn').forEach(btn => {
            if (btn.dataset.broker === broker) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });
        
        // Show/hide content
        document.querySelectorAll('.broker-content').forEach(content => {
            content.classList.remove('active');
        });
        const contentEl = document.getElementById(broker + '-account-content');
        if (contentEl) {
            contentEl.classList.add('active');
        }
    }
    
    function updateBrokerStatusDot(broker, status) {
        const dot = document.getElementById(broker + '-status-dot');
        if (!dot) return;
        
        dot.classList.remove('connected', 'disconnected', 'loading');
        if (status === 'connected') {
            dot.classList.add('connected');
        } else if (status === 'disconnected') {
            dot.classList.add('disconnected');
        } else if (status === 'loading') {
            dot.classList.add('loading');
        }
    }
    
    function setRefreshButtonLoading(loading) {
        const btn = document.getElementById('refresh-account-btn');
        if (!btn) return;
        
        if (loading) {
            btn.classList.add('spinning');
            btn.disabled = true;
        } else {
            btn.classList.remove('spinning');
            btn.disabled = false;
        }
    }
    
    function updateBrokerAccountInfo(broker, data) {
        const currency = data.currency || (broker === 'mexc' ? 'USDT' : 'EUR');
        const prefix = broker + '-';
        
        // Update balance
        const balanceEl = document.getElementById(prefix + 'balance');
        if (balanceEl) {
            balanceEl.textContent = formatCurrency(data.balance, currency);
        }
        
        // Update available
        const availableEl = document.getElementById(prefix + 'available');
        if (availableEl) {
            availableEl.textContent = formatCurrency(data.available, currency);
        }
        
        // Update margin used
        const marginUsedEl = document.getElementById(prefix + 'margin-used');
        if (marginUsedEl) {
            marginUsedEl.textContent = formatCurrency(data.margin_used, currency);
        }
        
        // Update margin available
        const marginAvailableEl = document.getElementById(prefix + 'margin-available');
        if (marginAvailableEl) {
            marginAvailableEl.textContent = formatCurrency(data.margin_available, currency);
        }
        
        // Update P&L with color coding
        const pnlEl = document.getElementById(prefix + 'pnl');
        if (pnlEl) {
            const pnlValue = parseFloat(data.unrealized_pnl);
            pnlEl.textContent = formatCurrency(data.unrealized_pnl, currency);
            pnlEl.classList.remove('positive', 'negative');
            if (!isNaN(pnlValue)) {
                if (pnlValue > 0) {
                    pnlEl.classList.add('positive');
                } else if (pnlValue < 0) {
                    pnlEl.classList.add('negative');
                }
            }
        }
    }
    
    function showBrokerError(broker, errorMessage) {
        const contentEl = document.getElementById(broker + '-account-content');
        if (contentEl) {
            contentEl.innerHTML = '<div class="account-info-error"><i class="bi bi-exclamation-triangle"></i> ' + escapeHtml(errorMessage) + '</div>';
        }
    }
    
    function resetBrokerAccountGrid(broker) {
        const contentEl = document.getElementById(broker + '-account-content');
        if (contentEl) {
            const prefix = broker + '-';
            contentEl.innerHTML = `
                <div class="account-info-grid">
                    <div class="account-info-item">
                        <div class="account-info-value" id="${prefix}balance">--</div>
                        <div class="account-info-label">Kontostand</div>
                    </div>
                    <div class="account-info-item">
                        <div class="account-info-value" id="${prefix}available">--</div>
                        <div class="account-info-label">Verfügbar</div>
                    </div>
                    <div class="account-info-item">
                        <div class="account-info-value" id="${prefix}margin-used">--</div>
                        <div class="account-info-label">Margin (genutzt)</div>
                    </div>
                    <div class="account-info-item">
                        <div class="account-info-value" id="${prefix}margin-available">--</div>
                        <div class="account-info-label">Margin (verfügbar)</div>
                    </div>
                    <div class="account-info-item">
                        <div class="account-info-value" id="${prefix}pnl">--</div>
                        <div class="account-info-label">Unrealisiert P&L</div>
                    </div>
                </div>
            `;
        }
    }
    
    function refreshAllBrokersAccountState() {
        setRefreshButtonLoading(true);
        updateBrokerStatusDot('ig', 'loading');
        updateBrokerStatusDot('mexc', 'loading');
        resetBrokerAccountGrid('ig');
        resetBrokerAccountGrid('mexc');
        
        fetch('/fiona/api/all-brokers-account-state/', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            setRefreshButtonLoading(false);
            
            // Update IG broker
            if (data.ig.connected) {
                updateBrokerStatusDot('ig', 'connected');
                resetBrokerAccountGrid('ig');
                updateBrokerAccountInfo('ig', data.ig.data);
            } else {
                updateBrokerStatusDot('ig', 'disconnected');
                showBrokerError('ig', data.ig.error || 'Nicht verbunden');
            }
            
            // Update MEXC broker
            if (data.mexc.connected) {
                updateBrokerStatusDot('mexc', 'connected');
                resetBrokerAccountGrid('mexc');
                updateBrokerAccountInfo('mexc', data.mexc.data);
            } else {
                updateBrokerStatusDot('mexc', 'disconnected');
                showBrokerError('mexc', data.mexc.error || 'Nicht verbunden');
            }
        })
        .catch(error => {
            console.error('All brokers account state error:', error);
            setRefreshButtonLoading(false);
            updateBrokerStatusDot('ig', 'disconnected');
            updateBrokerStatusDot('mexc', 'disconnected');
            showBrokerError('ig', 'Verbindungsfehler');
            showBrokerError('mexc', 'Verbindungsfehler');
        });
    }
    
    // Keep old function for backward compatibility (calls new function)
    function refreshAccountState() {
        refreshAllBrokersAccountState();
    }
    
    function startAutoRefresh() {
        // Initial load
        refreshAllBrokersAccountState();
        refreshWorkerStatus();
        
        // Set up interval for auto-refresh
        accountRefreshInterval = setInterval(refreshAllBrokersAccountState, REFRESH_INTERVAL);
        workerRefreshInterval = setInterval(refreshWorkerStatus, WORKER_REFRESH_INTERVAL);
    }
    
    function stopAutoRefresh() {
        if (accountRefreshInterval) {
            clearInterval(accountRefreshInterval);
            accountRefreshInterval = null;
        }
        if (workerRefreshInterval) {
            clearInterval(workerRefreshInterval);
            workerRefreshInterval = null;
        }
    }
    
    // Worker Status refresh functionality
    let workerRefreshInterval = null;
    const WORKER_REFRESH_INTERVAL = 30000; // 30 seconds
    
    function updateWorkerStatusIndicator(status, text) {
        const indicatorEl = document.getElementById('worker-status-indicator');
        if (!indicatorEl) return;
        
        indicatorEl.className = 'worker-status-indicator ' + status;
        indicatorEl.innerHTML = '<i class="bi bi-circle-fill"></i> <span>' + text + '</span>';
    }
    
    function setWorkerRefreshButtonLoading(loading) {
        const btn = document.getElementById('refresh-worker-btn');
        if (!btn) return;
        
        if (loading) {
            btn.classList.add('spinning');
            btn.disabled = true;
        } else {
            btn.classList.remove('spinning');
            btn.disabled = false;
        }
    }
    
    // Constants for display formatting
    const EPIC_MAX_DISPLAY_LENGTH = 15;
    const EPIC_TRUNCATED_LENGTH = 12;
    
    function formatTimeAgo(seconds) {
        if (seconds < 60) {
            return 'vor ' + seconds + 's';
        } else if (seconds < 3600) {
            const minutes = Math.floor(seconds / 60);
            return 'vor ' + minutes + ' Min.';
        } else {
            const hours = Math.floor(seconds / 3600);
            return 'vor ' + hours + ' Std.';
        }
    }
    
    function formatTime(isoString) {
        // Note: UTC is used intentionally for trading time consistency
        const date = new Date(isoString);
        return date.toLocaleTimeString('de-DE', { 
            hour: '2-digit', 
            minute: '2-digit', 
            second: '2-digit',
            timeZone: 'UTC'
        }) + ' UTC';
    }
    
    function updateWorkerInfo(data, isOnline) {
        // Update last activity
        const lastActivityEl = document.getElementById('worker-last-activity');
        if (lastActivityEl && data.last_run_at) {
            const timeStr = formatTime(data.last_run_at);
            const agoStr = formatTimeAgo(data.seconds_since_last_run);
            lastActivityEl.innerHTML = timeStr + '<br><small>' + agoStr + '</small>';
        }
        
        // Update phase
        const phaseEl = document.getElementById('worker-phase');
        if (phaseEl) {
            phaseEl.textContent = data.phase || '--';
        }
        
        // Update epic
        const epicEl = document.getElementById('worker-epic');
        if (epicEl) {
            // Shorten the epic for display if too long
            const epic = data.epic || '--';
            epicEl.textContent = epic.length > EPIC_MAX_DISPLAY_LENGTH 
                ? epic.substring(0, EPIC_TRUNCATED_LENGTH) + '...' 
                : epic;
            epicEl.title = epic;
        }
        
        // Update price
        const priceEl = document.getElementById('worker-price');
        if (priceEl && data.price_info) {
            if (data.price_info.bid && data.price_info.ask) {
                priceEl.textContent = data.price_info.bid + '/' + data.price_info.ask;
            } else {
                priceEl.textContent = '--';
            }
        }
        
        // Update setup count
        const setupCountEl = document.getElementById('worker-setup-count');
        if (setupCountEl) {
            setupCountEl.textContent = data.setup_count !== undefined ? data.setup_count : '--';
        }
        
        // Update interval
        const intervalEl = document.getElementById('worker-interval');
        if (intervalEl) {
            intervalEl.textContent = data.worker_interval ? (data.worker_interval + 's') : '--';
        }
        
        // Update diagnostic message
        const diagnosticEl = document.getElementById('worker-diagnostic-message');
        if (diagnosticEl) {
            diagnosticEl.textContent = data.diagnostic_message || 'Keine Diagnose verfügbar';
        }
        
        // Update countdown - pass the isOnline status
        updateCountdown(data.seconds_until_next_run, data.worker_interval, isOnline);
        
        // Update diagnostic criteria
        updateDiagnosticCriteria(data.diagnostic_criteria || []);
    }
    
    // Countdown state
    let countdownInterval = null;
    let currentCountdownValue = 0;
    let workerInterval = 60;
    let workerIsOnline = false;
    
    function updateCountdown(secondsUntilNextRun, interval, isOnline) {
        // Store worker online status
        workerIsOnline = isOnline;
        
        // Store worker interval for countdown reset
        workerInterval = interval || 60;
        currentCountdownValue = secondsUntilNextRun || 0;
        
        // Clear existing interval
        if (countdownInterval) {
            clearInterval(countdownInterval);
            countdownInterval = null;
        }
        
        // Only show countdown if worker is online
        if (!workerIsOnline) {
            displayCountdownValue(-1); // Show offline state
            return;
        }
        
        // Display the initial countdown value
        displayCountdownValue(currentCountdownValue);
        
        // Start countdown timer (updates every second)
        countdownInterval = setInterval(function() {
            currentCountdownValue--;
            
            if (currentCountdownValue <= 0) {
                // Reset to worker interval when countdown reaches 0
                currentCountdownValue = workerInterval;
            }
            
            displayCountdownValue(currentCountdownValue);
        }, 1000);
    }
    
    function displayCountdownValue(seconds) {
        const countdownEl = document.getElementById('worker-countdown-value');
        if (countdownEl) {
            if (seconds < 0) {
                // Offline or no data state
                countdownEl.textContent = '--';
                countdownEl.classList.remove('imminent');
                return;
            }
            countdownEl.textContent = seconds + 's';
            // Add visual emphasis when countdown is imminent
            if (seconds <= 5) {
                countdownEl.classList.add('imminent');
            } else {
                countdownEl.classList.remove('imminent');
            }
        }
    }
    
    function updateDiagnosticCriteria(criteria) {
        const criteriaListEl = document.getElementById('criteria-list');
        if (!criteriaListEl) return;
        
        if (!criteria || criteria.length === 0) {
            criteriaListEl.innerHTML = `
                <li class="criteria-item">
                    <span class="criteria-icon"><i class="bi bi-dash"></i></span>
                    <span class="criteria-content">
                        <span class="criteria-name">Keine Kriterien verfügbar</span>
                    </span>
                </li>
            `;
            return;
        }
        
        // Build criteria list HTML
        let html = '';
        for (const criterion of criteria) {
            const iconClass = criterion.passed ? 'passed' : 'failed';
            const iconSymbol = criterion.passed ? 'bi-check-circle-fill' : 'bi-x-circle-fill';
            
            html += `
                <li class="criteria-item">
                    <span class="criteria-icon ${iconClass}"><i class="bi ${iconSymbol}"></i></span>
                    <span class="criteria-content">
                        <span class="criteria-name">${escapeHtml(criterion.name)}</span>
                        ${criterion.detail ? `<div class="criteria-detail">${escapeHtml(criterion.detail)}</div>` : ''}
                    </span>
                </li>
            `;
        }
        
        criteriaListEl.innerHTML = html;
    }
    
    // HTML escape using a lookup table for better security
    const HTML_ESCAPE_MAP = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;',
    };
    
    function escapeHtml(text) {
        if (!text || typeof text !== 'string') {
            return '';
        }
        return text.replace(/[&<>"']/g, function(match) {
            return HTML_ESCAPE_MAP[match];
        });
    }
    
    // Accordion toggle for Criteria
    function toggleCriteriaAccordion() {
        const content = document.getElementById('criteria-content');
        const toggle = document.getElementById('criteria-toggle');
        
        if (content && toggle) {
            content.classList.toggle('expanded');
            toggle.classList.toggle('expanded');
        }
    }
    
    function showWorkerError(errorMessage) {
        const contentEl = document.getElementById('worker-status-content');
        if (contentEl) {
            contentEl.innerHTML = '<div class="worker-status-error"><i class="bi bi-exclamation-triangle"></i> ' + escapeHtml(errorMessage) + '</div>';
        }
    }
    
    // Worker status grid template
    const WORKER_STATUS_GRID_TEMPLATE = `
        <div class="worker-status-grid">
            <div class="worker-status-item">
                <div class="worker-status-value" id="worker-last-activity">--</div>
                <div class="worker-status-label">Letzte Aktivität</div>
            </div>
            <div class="worker-status-item">
                <div class="worker-status-value" id="worker-phase">--</div>
                <div class="worker-status-label">Phase</div>
            </div>
            <div class="worker-status-item">
                <div class="worker-status-value" id="worker-epic">--</div>
                <div class="worker-status-label">Epic</div>
            </div>
            <div class="worker-status-item">
                <div class="worker-status-value" id="worker-price">--</div>
                <div class="worker-status-label">Preis (Bid/Ask)</div>
            </div>
            <div class="worker-status-item">
                <div class="worker-status-value" id="worker-setup-count">--</div>
                <div class="worker-status-label">Setups gefunden</div>
            </div>
            <div class="worker-status-item">
                <div class="worker-status-value" id="worker-interval">--</div>
                <div class="worker-status-label">Intervall</div>
            </div>
        </div>
        <div class="worker-countdown" id="worker-countdown">
            <span class="countdown-label"><i class="bi bi-clock"></i> Nächster Lauf in</span>
            <span class="countdown-value" id="worker-countdown-value">--</span>
        </div>
        <div class="worker-diagnostic" id="worker-diagnostic">
            <div class="label">Diagnose</div>
            <div class="message" id="worker-diagnostic-message">--</div>
        </div>
        <div class="diagnostic-criteria" id="diagnostic-criteria">
            <div class="diagnostic-criteria-header" onclick="toggleCriteriaAccordion()">
                <div class="label">Kriterien-Prüfung</div>
                <span class="diagnostic-criteria-toggle" id="criteria-toggle"><i class="bi bi-chevron-down"></i></span>
            </div>
            <div class="diagnostic-criteria-content" id="criteria-content">
                <ul class="criteria-list" id="criteria-list">
                    <li class="criteria-item">
                        <span class="criteria-icon"><i class="bi bi-dash"></i></span>
                        <span class="criteria-content">
                            <span class="criteria-name">Keine Daten</span>
                        </span>
                    </li>
                </ul>
            </div>
        </div>
    `;
    
    function resetWorkerStatusGrid() {
        const contentEl = document.getElementById('worker-status-content');
        if (contentEl) {
            contentEl.innerHTML = WORKER_STATUS_GRID_TEMPLATE;
        }
    }
    
    function refreshWorkerStatus() {
        updateWorkerStatusIndicator('loading', 'Lädt...');
        setWorkerRefreshButtonLoading(true);
        
        fetch('/fiona/api/worker/status/', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            setWorkerRefreshButtonLoading(false);
            
            if (data.success) {
                if (data.worker_status === 'NO_DATA') {
                    updateWorkerStatusIndicator('no-data', 'Keine Daten');
                    resetWorkerStatusGrid();
                    document.getElementById('worker-diagnostic-message').textContent = data.status_message;
                    updateCountdown(0, 60, false);  // Stop countdown
                } else if (data.worker_status === 'ONLINE') {
                    updateWorkerStatusIndicator('online', 'ONLINE');
                    resetWorkerStatusGrid();
                    updateWorkerInfo(data.data, true);  // Pass isOnline = true
                } else {
                    updateWorkerStatusIndicator('offline', 'OFFLINE');
                    resetWorkerStatusGrid();
                    updateWorkerInfo(data.data, false);  // Pass isOnline = false
                }
            } else {
                updateWorkerStatusIndicator('offline', 'Fehler');
                showWorkerError(data.status_message || 'Unbekannter Fehler');
                updateCountdown(0, 60, false);  // Stop countdown
            }
        })
        .catch(error => {
            console.error('Worker status error:', error);
            setWorkerRefreshButtonLoading(false);
            updateWorkerStatusIndicator('offline', 'Fehler');
            showWorkerError('Verbindungsfehler');
            updateCountdown(0, 60, false);  // Stop countdown
        });
    }
    
    // Start auto-refresh when page loads
    document.addEventListener('DOMContentLoaded', function() {
        startAutoRefresh();
    });
    
    // Stop auto-refresh when page is hidden to save resources
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            stopAutoRefresh();
        } else {
            startAutoRefresh();
        }
    });
    
    // ============================================================================
    // Breakout Range Diagnostics
    // ============================================================================
    
    let rangeRefreshInterval = null;
    const RANGE_REFRESH_INTERVAL = 30000; // 30 seconds
    let currentRangeType = 'asia';
    let currentRangeAssetId = null;
    
    // Initialize selected asset from the dropdown
    function initializeRangeAssetSelector() {
        const selector = document.getElementById('range-asset-selector');
        if (selector && selector.options.length > 0) {
            currentRangeAssetId = selector.value;
        }
    }
    
    function selectRangeAsset(assetId) {
        currentRangeAssetId = assetId;
        // Refresh diagnostics with new asset
        refreshRangeDiagnostics();
    }
    
    function selectRangeType(rangeType) {
        currentRangeType = rangeType;
        
        // Update button states
        document.querySelectorAll('.range-type-btn').forEach(btn => {
            if (btn.dataset.rangeType === rangeType) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });
        
        // Refresh diagnostics with new type
        refreshRangeDiagnostics();
    }
    
    function setRangeRefreshButtonLoading(loading) {
        const btn = document.getElementById('refresh-range-btn');
        if (!btn) return;
        
        if (loading) {
            btn.classList.add('spinning');
            btn.disabled = true;
        } else {
            btn.classList.remove('spinning');
            btn.disabled = false;
        }
    }
    
    function updateRangeValidationBadge(validation) {
        const badge = document.getElementById('range-validation-badge');
        if (!badge) return;
        
        badge.classList.remove('valid', 'invalid', 'pending', 'no-data');
        
        let icon = 'circle-fill';
        let text = '--';
        let statusClass = 'no-data';
        
        if (validation === 'VALID') {
            icon = 'check-circle-fill';
            text = 'Range OK';
            statusClass = 'valid';
        } else if (validation === 'TOO_SMALL') {
            icon = 'exclamation-triangle-fill';
            text = 'Zu klein';
            statusClass = 'invalid';
        } else if (validation === 'TOO_LARGE') {
            icon = 'exclamation-triangle-fill';
            text = 'Zu groß';
            statusClass = 'invalid';
        } else if (validation === 'NOT_AVAILABLE') {
            icon = 'x-circle-fill';
            text = 'Keine Daten';
            statusClass = 'no-data';
        }
        
        badge.classList.add(statusClass);
        badge.innerHTML = '<i class="bi bi-' + icon + '"></i> <span>' + text + '</span>';
    }
    
    function updateBreakoutStatusBadge(status, direction) {
        const badge = document.getElementById('breakout-status-badge');
        if (!badge) return;
        
        badge.classList.remove('valid', 'invalid', 'pending', 'no-data');
        
        let icon = 'lightning-fill';
        let text = '--';
        let statusClass = 'no-data';
        
        if (status === 'VALID_BREAKOUT') {
            icon = 'lightning-charge-fill';
            text = direction ? direction + ' Breakout!' : 'Breakout!';
            statusClass = 'valid';
        } else if (status === 'POTENTIAL_BREAKOUT') {
            icon = 'lightning';
            text = direction ? 'Pot. ' + direction : 'Potentiell';
            statusClass = 'pending';
        } else if (status === 'NO_BREAKOUT') {
            icon = 'dash-circle';
            text = 'Kein Breakout';
            statusClass = 'no-data';
        }
        
        badge.classList.add(statusClass);
        badge.innerHTML = '<i class="bi bi-' + icon + '"></i> <span>' + text + '</span>';
    }
    
    function updatePricePositionDisplay(position) {
        const el = document.getElementById('range-price-position');
        if (!el) return;
        
        el.classList.remove('above', 'inside', 'below');
        
        if (position === 'ABOVE') {
            el.innerHTML = '<span class="price-position-badge above"><i class="bi bi-arrow-up"></i> Oberhalb</span>';
        } else if (position === 'BELOW') {
            el.innerHTML = '<span class="price-position-badge below"><i class="bi bi-arrow-down"></i> Unterhalb</span>';
        } else if (position === 'INSIDE') {
            el.innerHTML = '<span class="price-position-badge inside"><i class="bi bi-arrows-collapse"></i> Innerhalb</span>';
        } else {
            el.textContent = '--';
        }
    }
    
    function formatPrice(value) {
        if (value === null || value === undefined) return '--';
        return parseFloat(value).toFixed(2);
    }
    
    function updateRangeDiagnosticsUI(data) {
        // Update range data
        const rangeData = data.range_data || {};
        document.getElementById('range-high').textContent = formatPrice(rangeData.high);
        document.getElementById('range-low').textContent = formatPrice(rangeData.low);
        document.getElementById('range-height').textContent = rangeData.height ? rangeData.height.toFixed(2) : '--';
        document.getElementById('range-height-ticks').textContent = rangeData.height_ticks || '--';
        
        // Update current market data
        const currentMarket = data.current_market || {};
        document.getElementById('range-current-price').textContent = formatPrice(currentMarket.price);
        updatePricePositionDisplay(currentMarket.position);
        
        // Update validation badge
        const validation = data.validation || {};
        updateRangeValidationBadge(validation.range_validation);
        
        // Update breakout status badge
        const breakoutStatus = data.breakout_status || {};
        updateBreakoutStatusBadge(breakoutStatus.status, breakoutStatus.potential_direction);
        
        // Update config values
        const config = data.config || {};
        document.getElementById('config-min-ticks').textContent = config.min_range_ticks || '--';
        document.getElementById('config-max-ticks').textContent = config.max_range_ticks || '--';
        document.getElementById('config-body-fraction').textContent = config.min_breakout_body_fraction ? (config.min_breakout_body_fraction * 100).toFixed(0) + '%' : '--';
        document.getElementById('config-tick-size').textContent = config.tick_size || '--';
        
        // Update diagnostic message
        const diagnostics = data.diagnostics || {};
        document.getElementById('range-diagnostic-message').textContent = diagnostics.message || 'Keine Diagnose verfügbar';
    }
    
    function showRangeDiagnosticsError(errorMessage) {
        const contentEl = document.getElementById('range-diagnostics-content');
        if (contentEl) {
            contentEl.innerHTML = '<div class="range-diagnostics-error"><i class="bi bi-exclamation-triangle"></i> ' + errorMessage + '</div>';
        }
    }
    
    // Range diagnostics grid template
    const RANGE_DIAGNOSTICS_GRID_TEMPLATE = `
        <div class="range-diagnostics-grid">
            <div class="range-diagnostics-item">
                <div class="range-diagnostics-value" id="range-high">--</div>
                <div class="range-diagnostics-label">Range High</div>
            </div>
            <div class="range-diagnostics-item">
                <div class="range-diagnostics-value" id="range-low">--</div>
                <div class="range-diagnostics-label">Range Low</div>
            </div>
            <div class="range-diagnostics-item">
                <div class="range-diagnostics-value" id="range-height">--</div>
                <div class="range-diagnostics-label">Range Höhe</div>
            </div>
            <div class="range-diagnostics-item">
                <div class="range-diagnostics-value" id="range-height-ticks">--</div>
                <div class="range-diagnostics-label">Ticks</div>
            </div>
            <div class="range-diagnostics-item">
                <div class="range-diagnostics-value" id="range-current-price">--</div>
                <div class="range-diagnostics-label">Aktueller Preis</div>
            </div>
            <div class="range-diagnostics-item">
                <div class="range-diagnostics-value" id="range-price-position">--</div>
                <div class="range-diagnostics-label">Position</div>
            </div>
        </div>
        
        <div class="d-flex flex-wrap gap-2 mt-3 mb-2">
            <span id="range-validation-badge" class="range-status-indicator no-data">
                <i class="bi bi-circle-fill"></i>
                <span>--</span>
            </span>
            <span id="breakout-status-badge" class="range-status-indicator no-data">
                <i class="bi bi-lightning-fill"></i>
                <span>--</span>
            </span>
        </div>
        
        <div class="range-config-section" id="range-config-section">
            <div class="label">Konfiguration</div>
            <div class="range-config-grid">
                <div class="range-config-item">
                    <span class="range-config-key">min_range_ticks</span>
                    <span class="range-config-value" id="config-min-ticks">--</span>
                </div>
                <div class="range-config-item">
                    <span class="range-config-key">max_range_ticks</span>
                    <span class="range-config-value" id="config-max-ticks">--</span>
                </div>
                <div class="range-config-item">
                    <span class="range-config-key">min_body_fraction</span>
                    <span class="range-config-value" id="config-body-fraction">--</span>
                </div>
                <div class="range-config-item">
                    <span class="range-config-key">tick_size</span>
                    <span class="range-config-value" id="config-tick-size">--</span>
                </div>
            </div>
        </div>
        
        <div class="range-diagnostic-message" id="range-diagnostic-message-section">
            <div class="label">Diagnose</div>
            <div class="message" id="range-diagnostic-message">--</div>
        </div>
    `;
    
    function resetRangeDiagnosticsGrid() {
        const contentEl = document.getElementById('range-diagnostics-content');
        if (contentEl) {
            contentEl.innerHTML = RANGE_DIAGNOSTICS_GRID_TEMPLATE;
        }
    }
    
    function refreshRangeDiagnostics() {
        setRangeRefreshButtonLoading(true);
        resetRangeDiagnosticsGrid();
        
        // Build the API URL with asset_id if available
        let url = '/fiona/api/debug/breakout-range/?range_type=' + currentRangeType;
        if (currentRangeAssetId) {
            url += '&asset_id=' + currentRangeAssetId;
        }
        
        fetch(url, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            setRangeRefreshButtonLoading(false);
            
            if (data.success) {
                updateRangeDiagnosticsUI(data.data);
            } else {
                showRangeDiagnosticsError(data.error || data.message || 'Fehler beim Laden der Range-Daten');
            }
        })
        .catch(error => {
            console.error('Range diagnostics error:', error);
            setRangeRefreshButtonLoading(false);
            showRangeDiagnosticsError('Verbindungsfehler');
        });
    }
    
    // Update startAutoRefresh to include range diagnostics
    const originalStartAutoRefresh = startAutoRefresh;
    startAutoRefresh = function() {
        originalStartAutoRefresh();
        // Initialize asset selector
        initializeRangeAssetSelector();
        // Also refresh range diagnostics
        refreshRangeDiagnostics();
        rangeRefreshInterval = setInterval(refreshRangeDiagnostics, RANGE_REFRESH_INTERVAL);
    };
    
    // Update stopAutoRefresh to include range diagnostics
    const originalStopAutoRefresh = stopAutoRefresh;
    stopAutoRefresh = function() {
        originalStopAutoRefresh();
        if (rangeRefreshInterval) {
            clearInterval(rangeRefreshInterval);
            rangeRefreshInterval = null;
        }
        if (priceRangeRefreshInterval) {
            clearInterval(priceRangeRefreshInterval);
            priceRangeRefreshInterval = null;
        }
    };
    
    // ============================================================================
    // Price vs Range - Live Status
    // ============================================================================
    
    let priceRangeRefreshInterval = null;
    const PRICE_RANGE_REFRESH_INTERVAL = 30000; // 30 seconds
    let currentPriceRangeAssetId = null;
    let currentPriceRangePhase = 'ASIA_RANGE';
    
    // Initialize selected asset from the dropdown
    function initializePriceRangeAssetSelector() {
        const selector = document.getElementById('price-range-asset-selector');
        if (selector && selector.options.length > 0) {
            currentPriceRangeAssetId = selector.value;
        }
    }
    
    function selectPriceRangeAsset(assetId) {
        currentPriceRangeAssetId = assetId;
        // Sync with range diagnostics selector
        const rangeDiagSelector = document.getElementById('range-asset-selector');
        if (rangeDiagSelector) {
            rangeDiagSelector.value = assetId;
        }
        // Refresh status
        refreshPriceRangeStatus();
    }
    
    function selectPriceRangePhase(phase) {
        currentPriceRangePhase = phase;
        
        // Update button states
        document.querySelectorAll('.phase-tab-btn').forEach(btn => {
            if (btn.dataset.phase === phase) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });
        
        // Refresh status with new phase
        refreshPriceRangeStatus();
    }
    
    function setPriceRangeRefreshButtonLoading(loading) {
        const btn = document.getElementById('refresh-price-range-btn');
        if (!btn) return;
        
        if (loading) {
            btn.classList.add('spinning');
            btn.disabled = true;
        } else {
            btn.classList.remove('spinning');
            btn.disabled = false;
        }
    }
    
    function refreshPriceRangeStatus() {
        setPriceRangeRefreshButtonLoading(true);
        
        const contentEl = document.getElementById('price-range-status-content');
        if (!contentEl) {
            setPriceRangeRefreshButtonLoading(false);
            return;
        }
        
        // Build URL with current asset and phase
        let url = '/fiona/htmx/price-range-status/?phase=' + currentPriceRangePhase;
        if (currentPriceRangeAssetId) {
            url += '&asset_id=' + currentPriceRangeAssetId;
        }
        
        // Use HTMX to load the partial
        htmx.ajax('GET', url, {
            target: '#price-range-status-content',
            swap: 'innerHTML'
        }).then(function() {
            setPriceRangeRefreshButtonLoading(false);
        }).catch(function(error) {
            console.error('Price range status error:', error);
            setPriceRangeRefreshButtonLoading(false);
            contentEl.innerHTML = '<div class="price-range-fallback"><i class="bi bi-exclamation-triangle"></i><span>Verbindungsfehler</span></div>';
        });
    }
    
    // Update startAutoRefresh to include price range status
    const originalStartAutoRefresh2 = startAutoRefresh;
    startAutoRefresh = function() {
        originalStartAutoRefresh2();
        // Initialize price range asset selector
        initializePriceRangeAssetSelector();
        // Also refresh price range status
        refreshPriceRangeStatus();
        priceRangeRefreshInterval = setInterval(refreshPriceRangeStatus, PRICE_RANGE_REFRESH_INTERVAL);
    };
    
    // ============================================================================
    // Signal Polling & Desktop Notifications
    // ============================================================================
    
    const SIGNAL_POLLING_INTERVAL = 10000; // 10 seconds
    let signalPollingInterval = null;
    let lastSignalCheckTime = new Date().toISOString();
    let notificationsEnabled = false;
    
    /**
     * Request notification permission from the user.
     */
    function requestNotificationPermission() {
        if (!('Notification' in window)) {
            console.log('Browser does not support notifications');
            return Promise.resolve('denied');
        }
        
        if (Notification.permission === 'granted') {
            return Promise.resolve('granted');
        }
        
        if (Notification.permission !== 'denied') {
            return Notification.requestPermission();
        }
        
        return Promise.resolve(Notification.permission);
    }
    
    /**
     * Toggle notifications on/off.
     */
    function toggleNotifications() {
        const icon = document.getElementById('notification-icon');
        const btn = document.getElementById('notification-toggle');
        
        if (notificationsEnabled) {
            // Disable notifications
            notificationsEnabled = false;
            icon.classList.remove('bi-bell-fill');
            icon.classList.add('bi-bell');
            btn.classList.remove('btn-success');
            btn.classList.add('btn-outline-light');
            btn.title = 'Benachrichtigungen aktivieren';
        } else {
            // Try to enable notifications
            requestNotificationPermission().then(function(permission) {
                if (permission === 'granted') {
                    notificationsEnabled = true;
                    icon.classList.remove('bi-bell');
                    icon.classList.add('bi-bell-fill');
                    btn.classList.remove('btn-outline-light');
                    btn.classList.add('btn-success');
                    btn.title = 'Benachrichtigungen deaktivieren';
                } else {
                    alert('Benachrichtigungen wurden vom Browser blockiert. Bitte erlauben Sie Benachrichtigungen in den Browser-Einstellungen.');
                }
            });
        }
    }
    
    /**
     * Show a desktop notification for new signals.
     */
    function showSignalNotification(signals) {
        if (!notificationsEnabled || !('Notification' in window) || Notification.permission !== 'granted') {
            return;
        }
        
        const count = signals.length;
        const firstSignal = signals[0];
        
        let title = count === 1 
            ? 'Neues Trading-Signal'
            : `${count} neue Trading-Signale`;
        
        let body = '';
        if (firstSignal) {
            body = `${firstSignal.setup_type_display} - ${firstSignal.direction}`;
            if (firstSignal.trigger_price) {
                body += ` @ ${firstSignal.trigger_price}`;
            }
            if (count > 1) {
                body += `\n+${count - 1} weitere`;
            }
        }
        
        const notification = new Notification(title, {
            body: body,
            icon: '/media/Finoa_192.png',
            tag: 'fiona-signal',
            requireInteraction: false,
        });
        
        // Focus window and navigate to signal detail on click
        notification.onclick = function() {
            window.focus();
            if (firstSignal && firstSignal.id) {
                // Build the URL dynamically using the signal ID
                window.location.href = window.location.origin + '/fiona/signals/' + firstSignal.id + '/';
            }
            notification.close();
        };
        
        // Auto-close after 8 seconds
        setTimeout(function() {
            notification.close();
        }, 8000);
    }
    
    /**
     * Update the UI with new signals.
     */
    function updateUIWithNewSignals(count) {
        // Update badge count
        const badge = document.getElementById('signal-count-badge');
        if (badge) {
            // Get current count from the badge text and add new count
            const currentText = badge.textContent;
            const match = currentText.match(/(\d+)/);
            const currentCount = match ? parseInt(match[1], 10) : 0;
            const newTotal = currentCount + count;
            badge.textContent = `${newTotal} aktive Signale`;
            
            // Add visual pulse effect
            badge.classList.add('badge-pulse');
            setTimeout(function() {
                badge.classList.remove('badge-pulse');
            }, 1000);
        }
        
        // Reload the signal list (full page reload for now, HTMX partial refresh could be added)
        // This ensures we get the complete updated UI with proper Django template rendering
        location.reload();
    }
    
    /**
     * Poll for new signals since the last check.
     */
    function pollForNewSignals() {
        // Get the API URL from the data attribute and replace the placeholder with actual timestamp
        const dashboard = document.querySelector('.fiona-dashboard');
        const apiBase = dashboard ? dashboard.dataset.signalsApiBase : '/fiona/api/signals/since/TIMESTAMP/';
        const url = apiBase.replace('TIMESTAMP', encodeURIComponent(lastSignalCheckTime));
        
        fetch(url, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            },
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            // Update the last check time to the server's 'now' timestamp
            lastSignalCheckTime = data.now;
            
            if (data.count > 0) {
                console.log(`Found ${data.count} new signal(s)`);
                
                // Show desktop notification
                showSignalNotification(data.signals);
                
                // Update the UI
                updateUIWithNewSignals(data.count);
            }
        })
        .catch(error => {
            console.error('Error polling for signals:', error);
        });
    }
    
    /**
     * Start polling for new signals.
     */
    function startSignalPolling() {
        // Don't start if already running
        if (signalPollingInterval) {
            return;
        }
        
        // Set the initial last check time to now
        lastSignalCheckTime = new Date().toISOString();
        
        // Start polling
        signalPollingInterval = setInterval(pollForNewSignals, SIGNAL_POLLING_INTERVAL);
        console.log('Signal polling started');
    }
    
    /**
     * Stop polling for new signals.
     */
    function stopSignalPolling() {
        if (signalPollingInterval) {
            clearInterval(signalPollingInterval);
            signalPollingInterval = null;
            console.log('Signal polling stopped');
        }
    }
    
    /**
     * Initialize notification state based on browser permission.
     */
    function initializeNotificationState() {
        if ('Notification' in window && Notification.permission === 'granted') {
            // Notifications were previously granted, enable them
            notificationsEnabled = true;
            const icon = document.getElementById('notification-icon');
            const btn = document.getElementById('notification-toggle');
            if (icon && btn) {
                icon.classList.remove('bi-bell');
                icon.classList.add('bi-bell-fill');
                btn.classList.remove('btn-outline-light');
                btn.classList.add('btn-success');
                btn.title = 'Benachrichtigungen deaktivieren';
            }
        }
    }
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        initializeNotificationState();
        startSignalPolling();
    });
    
    // Handle visibility changes to conserve resources
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            stopSignalPolling();
        } else {
            startSignalPolling();
        }
    });
</script>
{% endblock %}
