{% extends 'core/base.html' %}

{% block title %}Fiona - Signal Dashboard{% endblock %}

{% block extra_css %}
<style>
    /* Fiona Trading Dashboard - Dark Mode Styles */
    :root {
        --fiona-bg-dark: #1a1d21;
        --fiona-card-dark: #2d3239;
        --fiona-card-header: #3a4149;
        --fiona-text-light: #e9ecef;
        --fiona-text-muted: #8b949e;
        --fiona-border: #484f58;
        
        /* Signal Colors */
        --signal-long: #28a745;
        --signal-short: #dc3545;
        
        /* Confidence Colors */
        --confidence-high: #28a745;
        --confidence-medium: #ffc107;
        --confidence-low: #dc3545;
        
        /* Risk Colors */
        --risk-green: #28a745;
        --risk-yellow: #ffc107;
        --risk-red: #dc3545;
    }
    
    .fiona-dashboard {
        background-color: var(--fiona-bg-dark);
        min-height: 100vh;
        color: var(--fiona-text-light);
        padding: 1rem;
    }
    
    .fiona-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--fiona-border);
    }
    
    .fiona-header h1 {
        color: var(--fiona-text-light);
        margin: 0;
    }
    
    .fiona-header .badge {
        font-size: 1rem;
        padding: 0.5rem 1rem;
    }
    
    /* Signal Card */
    .signal-card {
        background-color: var(--fiona-card-dark);
        border: 1px solid var(--fiona-border);
        border-radius: 12px;
        margin-bottom: 1.5rem;
        overflow: hidden;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .signal-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    
    .signal-card-header {
        background-color: var(--fiona-card-header);
        padding: 1rem 1.25rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid var(--fiona-border);
    }
    
    .signal-card-body {
        padding: 1.25rem;
    }
    
    .signal-card-footer {
        padding: 1rem 1.25rem;
        background-color: var(--fiona-card-header);
        border-top: 1px solid var(--fiona-border);
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }
    
    /* Setup Type Badge */
    .setup-type-badge {
        font-size: 0.875rem;
        padding: 0.35rem 0.75rem;
        border-radius: 6px;
        font-weight: 600;
    }
    
    .setup-type-BREAKOUT {
        background-color: #2563eb;
        color: white;
    }
    
    .setup-type-EIA_REVERSION {
        background-color: #7c3aed;
        color: white;
    }
    
    .setup-type-EIA_TRENDDAY {
        background-color: #059669;
        color: white;
    }
    
    /* Session Phase Tag */
    .session-phase-tag {
        background-color: var(--fiona-border);
        color: var(--fiona-text-light);
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    /* Direction Badge */
    .direction-badge {
        font-size: 1rem;
        font-weight: 700;
        padding: 0.5rem 1rem;
        border-radius: 6px;
    }
    
    .direction-LONG {
        background-color: var(--signal-long);
        color: white;
    }
    
    .direction-SHORT {
        background-color: var(--signal-short);
        color: white;
    }
    
    /* Confidence Badge */
    .confidence-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.35rem 0.75rem;
        border-radius: 6px;
        font-weight: 600;
    }
    
    .confidence-high {
        background-color: rgba(40, 167, 69, 0.2);
        color: var(--confidence-high);
        border: 1px solid var(--confidence-high);
    }
    
    .confidence-medium {
        background-color: rgba(255, 193, 7, 0.2);
        color: var(--confidence-medium);
        border: 1px solid var(--confidence-medium);
    }
    
    .confidence-low {
        background-color: rgba(220, 53, 69, 0.2);
        color: var(--confidence-low);
        border: 1px solid var(--confidence-low);
    }
    
    /* Risk Badge */
    .risk-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.35rem 0.75rem;
        border-radius: 6px;
        font-weight: 600;
    }
    
    .risk-GREEN {
        background-color: rgba(40, 167, 69, 0.2);
        color: var(--risk-green);
        border: 1px solid var(--risk-green);
    }
    
    .risk-YELLOW {
        background-color: rgba(255, 193, 7, 0.2);
        color: var(--risk-yellow);
        border: 1px solid var(--risk-yellow);
    }
    
    .risk-RED {
        background-color: rgba(220, 53, 69, 0.2);
        color: var(--risk-red);
        border: 1px solid var(--risk-red);
    }
    
    /* Range Info Box */
    .range-info {
        background-color: rgba(0, 0, 0, 0.2);
        border-radius: 8px;
        padding: 0.75rem;
        margin-bottom: 1rem;
    }
    
    .range-info-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.25rem;
    }
    
    .range-info-row:last-child {
        margin-bottom: 0;
    }
    
    .range-label {
        color: var(--fiona-text-muted);
        font-size: 0.875rem;
    }
    
    .range-value {
        font-weight: 600;
        font-family: 'Roboto Mono', monospace;
    }
    
    /* KI Info */
    .ki-info {
        background-color: rgba(0, 0, 0, 0.2);
        border-radius: 8px;
        padding: 0.75rem;
        margin-top: 1rem;
    }
    
    .ki-reasoning {
        color: var(--fiona-text-muted);
        font-size: 0.875rem;
        line-height: 1.5;
        margin-top: 0.5rem;
    }
    
    /* Trade Buttons */
    .btn-trade-live {
        background-color: var(--signal-long);
        border-color: var(--signal-long);
        color: white;
        font-weight: 600;
    }
    
    .btn-trade-live:hover:not(:disabled) {
        background-color: #218838;
        border-color: #1e7e34;
        color: white;
    }
    
    .btn-trade-live:disabled {
        background-color: #6c757d;
        border-color: #6c757d;
        opacity: 0.65;
    }
    
    .btn-trade-shadow {
        background-color: #6c757d;
        border-color: #6c757d;
        color: white;
        font-weight: 600;
    }
    
    .btn-trade-shadow:hover {
        background-color: #545b62;
        border-color: #4e555b;
        color: white;
    }
    
    .btn-trade-reject {
        background-color: transparent;
        border-color: var(--signal-short);
        color: var(--signal-short);
    }
    
    .btn-trade-reject:hover {
        background-color: var(--signal-short);
        color: white;
    }
    
    .btn-trade-details {
        background-color: #3a6ea5;
        border-color: #3a6ea5;
        color: white;
    }
    
    .btn-trade-details:hover {
        background-color: #2e5684;
        border-color: #2e5684;
        color: white;
    }
    
    /* Section Label */
    .section-label {
        color: var(--fiona-text-muted);
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 1px;
        margin-bottom: 0.5rem;
    }
    
    /* Stats Grid */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
    }
    
    .stat-item {
        text-align: center;
    }
    
    .stat-value {
        font-size: 1.25rem;
        font-weight: 700;
        font-family: 'Roboto Mono', monospace;
    }
    
    .stat-label {
        font-size: 0.75rem;
        color: var(--fiona-text-muted);
        text-transform: uppercase;
    }
    
    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        color: var(--fiona-text-muted);
    }
    
    .empty-state i {
        font-size: 4rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }
    
    /* Account Info Card */
    .account-info-card {
        background-color: var(--fiona-card-dark);
        border: 1px solid var(--fiona-border);
        border-radius: 12px;
        padding: 1rem 1.25rem;
        margin-bottom: 1.5rem;
    }
    
    .account-info-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
    }
    
    .account-info-header h5 {
        margin: 0;
        color: var(--fiona-text-light);
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .account-info-status {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.75rem;
    }
    
    .account-info-status.connected {
        color: var(--signal-long);
    }
    
    .account-info-status.disconnected {
        color: var(--signal-short);
    }
    
    .account-info-status.loading {
        color: var(--fiona-text-muted);
    }
    
    .account-info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
    }
    
    .account-info-item {
        text-align: center;
        padding: 0.5rem;
        background-color: rgba(0, 0, 0, 0.2);
        border-radius: 8px;
    }
    
    .account-info-value {
        font-size: 1.25rem;
        font-weight: 700;
        font-family: 'Roboto Mono', monospace;
        color: var(--fiona-text-light);
    }
    
    .account-info-value.positive {
        color: var(--signal-long);
    }
    
    .account-info-value.negative {
        color: var(--signal-short);
    }
    
    .account-info-label {
        font-size: 0.75rem;
        color: var(--fiona-text-muted);
        text-transform: uppercase;
        margin-top: 0.25rem;
    }
    
    .account-info-error {
        color: var(--signal-short);
        font-size: 0.875rem;
        text-align: center;
        padding: 1rem;
    }
    
    .refresh-btn {
        background: transparent;
        border: none;
        color: var(--fiona-text-muted);
        cursor: pointer;
        padding: 0.25rem;
        transition: color 0.2s;
    }
    
    .refresh-btn:hover {
        color: var(--fiona-text-light);
    }
    
    .refresh-btn.spinning i {
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    
    /* Worker Status Card */
    .worker-status-card {
        background-color: var(--fiona-card-dark);
        border: 1px solid var(--fiona-border);
        border-radius: 12px;
        padding: 1rem 1.25rem;
        margin-bottom: 1.5rem;
    }
    
    .worker-status-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
    }
    
    .worker-status-header h5 {
        margin: 0;
        color: var(--fiona-text-light);
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .worker-status-indicator {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.875rem;
        font-weight: 600;
        padding: 0.25rem 0.75rem;
        border-radius: 6px;
    }
    
    .worker-status-indicator.online {
        background-color: rgba(40, 167, 69, 0.2);
        color: var(--signal-long);
        border: 1px solid var(--signal-long);
    }
    
    .worker-status-indicator.offline {
        background-color: rgba(220, 53, 69, 0.2);
        color: var(--signal-short);
        border: 1px solid var(--signal-short);
    }
    
    .worker-status-indicator.no-data {
        background-color: rgba(108, 117, 125, 0.2);
        color: var(--fiona-text-muted);
        border: 1px solid var(--fiona-border);
    }
    
    .worker-status-indicator.loading {
        background-color: rgba(108, 117, 125, 0.2);
        color: var(--fiona-text-muted);
        border: 1px solid var(--fiona-border);
    }
    
    .worker-status-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 0.75rem;
    }
    
    .worker-status-item {
        text-align: center;
        padding: 0.5rem;
        background-color: rgba(0, 0, 0, 0.2);
        border-radius: 8px;
    }
    
    .worker-status-value {
        font-size: 1rem;
        font-weight: 700;
        font-family: 'Roboto Mono', monospace;
        color: var(--fiona-text-light);
    }
    
    .worker-status-label {
        font-size: 0.7rem;
        color: var(--fiona-text-muted);
        text-transform: uppercase;
        margin-top: 0.25rem;
    }
    
    .worker-diagnostic {
        margin-top: 0.75rem;
        padding: 0.5rem 0.75rem;
        background-color: rgba(0, 0, 0, 0.2);
        border-radius: 8px;
        font-size: 0.85rem;
        color: var(--fiona-text-muted);
    }
    
    .worker-diagnostic .label {
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 0.25rem;
        color: var(--fiona-text-muted);
    }
    
    .worker-diagnostic .message {
        color: var(--fiona-text-light);
    }
    
    .worker-status-error {
        color: var(--signal-short);
        font-size: 0.875rem;
        text-align: center;
        padding: 1rem;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
        .signal-card-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.5rem;
        }
        
        .signal-card-footer {
            justify-content: center;
        }
        
        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .account-info-grid {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .worker-status-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="fiona-dashboard">
    <div class="container-fluid">
        <div class="fiona-header">
            <div>
                <h1>
                    <i class="bi bi-graph-up-arrow"></i> Fiona Signal Dashboard
                </h1>
                <small class="text-muted">Trading Signal Management v1.0</small>
            </div>
            <div class="d-flex gap-2 align-items-center">
                <span class="badge bg-success">{{ active_count }} aktive Signale</span>
                <a href="{% url 'trade_history' %}" class="btn btn-sm btn-outline-light">
                    <i class="bi bi-clock-history"></i> Historie
                </a>
            </div>
        </div>
        
        <!-- Account Info Card -->
        <div class="account-info-card" id="account-info">
            <div class="account-info-header">
                <h5><i class="bi bi-bank"></i> Konto &amp; Margin</h5>
                <div class="d-flex align-items-center gap-2">
                    <span id="account-status" class="account-info-status loading">
                        <i class="bi bi-circle-fill"></i>
                        <span>Lädt...</span>
                    </span>
                    <button class="refresh-btn" id="refresh-account-btn" onclick="refreshAccountState()" title="Aktualisieren">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                </div>
            </div>
            <div id="account-info-content">
                <div class="account-info-grid">
                    <div class="account-info-item">
                        <div class="account-info-value" id="account-balance">--</div>
                        <div class="account-info-label">Kontostand</div>
                    </div>
                    <div class="account-info-item">
                        <div class="account-info-value" id="account-available">--</div>
                        <div class="account-info-label">Verfügbar</div>
                    </div>
                    <div class="account-info-item">
                        <div class="account-info-value" id="account-margin-used">--</div>
                        <div class="account-info-label">Margin (genutzt)</div>
                    </div>
                    <div class="account-info-item">
                        <div class="account-info-value" id="account-margin-available">--</div>
                        <div class="account-info-label">Margin (verfügbar)</div>
                    </div>
                    <div class="account-info-item">
                        <div class="account-info-value" id="account-pnl">--</div>
                        <div class="account-info-label">Unrealisiert P&amp;L</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Worker Status Card -->
        <div class="worker-status-card" id="worker-status">
            <div class="worker-status-header">
                <h5><i class="bi bi-cpu"></i> Worker Status</h5>
                <div class="d-flex align-items-center gap-2">
                    <span id="worker-status-indicator" class="worker-status-indicator loading">
                        <i class="bi bi-circle-fill"></i>
                        <span>Lädt...</span>
                    </span>
                    <button class="refresh-btn" id="refresh-worker-btn" onclick="refreshWorkerStatus()" title="Aktualisieren">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                </div>
            </div>
            <div id="worker-status-content">
                <div class="worker-status-grid">
                    <div class="worker-status-item">
                        <div class="worker-status-value" id="worker-last-activity">--</div>
                        <div class="worker-status-label">Letzte Aktivität</div>
                    </div>
                    <div class="worker-status-item">
                        <div class="worker-status-value" id="worker-phase">--</div>
                        <div class="worker-status-label">Phase</div>
                    </div>
                    <div class="worker-status-item">
                        <div class="worker-status-value" id="worker-epic">--</div>
                        <div class="worker-status-label">Epic</div>
                    </div>
                    <div class="worker-status-item">
                        <div class="worker-status-value" id="worker-price">--</div>
                        <div class="worker-status-label">Preis (Bid/Ask)</div>
                    </div>
                    <div class="worker-status-item">
                        <div class="worker-status-value" id="worker-setup-count">--</div>
                        <div class="worker-status-label">Setups gefunden</div>
                    </div>
                    <div class="worker-status-item">
                        <div class="worker-status-value" id="worker-interval">--</div>
                        <div class="worker-status-label">Intervall</div>
                    </div>
                </div>
                <div class="worker-diagnostic" id="worker-diagnostic">
                    <div class="label">Diagnose</div>
                    <div class="message" id="worker-diagnostic-message">--</div>
                </div>
            </div>
        </div>
        
        {% if signals %}
        <div class="row">
            {% for signal in signals %}
            <div class="col-lg-6 col-xl-4">
                <div class="signal-card">
                    <div class="signal-card-header">
                        <div class="d-flex align-items-center gap-2">
                            <span class="setup-type-badge setup-type-{% if signal.setup_type %}{{ signal.setup_type }}{% else %}BREAKOUT{% endif %}">
                                {% if signal.setup_type_display %}
                                    {{ signal.setup_type_display }}
                                {% else %}
                                    {{ signal.get_setup_type_display }}
                                {% endif %}
                            </span>
                            <span class="session-phase-tag">
                                {% if signal.session_phase_display %}
                                    {{ signal.session_phase_display }}
                                {% else %}
                                    {{ signal.get_session_phase_display }}
                                {% endif %}
                            </span>
                        </div>
                        <span class="direction-badge direction-{{ signal.direction }}">
                            {% if signal.direction == 'LONG' %}
                                <i class="bi bi-arrow-up-circle-fill"></i>
                            {% else %}
                                <i class="bi bi-arrow-down-circle-fill"></i>
                            {% endif %}
                            {{ signal.direction }}
                        </span>
                    </div>
                    
                    <div class="signal-card-body">
                        <!-- Range Info -->
                        <div class="range-info">
                            <div class="section-label">Range Info</div>
                            <div class="range-info-row">
                                <span class="range-label">Range High</span>
                                <span class="range-value">{{ signal.range_high }}</span>
                            </div>
                            <div class="range-info-row">
                                <span class="range-label">Range Low</span>
                                <span class="range-value">{{ signal.range_low }}</span>
                            </div>
                            <div class="range-info-row">
                                <span class="range-label">Trigger</span>
                                <span class="range-value text-warning">{{ signal.trigger_price }}</span>
                            </div>
                        </div>
                        
                        <!-- Stats -->
                        <div class="stats-grid">
                            <div class="stat-item">
                                <div class="stat-value text-danger">{{ signal.stop_loss }}</div>
                                <div class="stat-label">SL</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value text-success">{{ signal.take_profit }}</div>
                                <div class="stat-label">TP</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">{{ signal.position_size }}</div>
                                <div class="stat-label">Size</div>
                            </div>
                        </div>
                        
                        <!-- KI & Risk Badges -->
                        <div class="d-flex flex-wrap gap-2 mt-3">
                            {% with gpt_conf=signal.gpt_confidence|floatformat:0 %}
                            <span class="confidence-badge {% if gpt_conf >= 80 %}confidence-high{% elif gpt_conf >= 60 %}confidence-medium{% else %}confidence-low{% endif %}">
                                <i class="bi bi-cpu"></i> GPT {{ gpt_conf }}%
                            </span>
                            {% endwith %}
                            
                            <span class="risk-badge risk-{{ signal.risk_status }}">
                                {% if signal.risk_status == 'GREEN' %}
                                    <i class="bi bi-check-circle-fill"></i> Erlaubt
                                {% elif signal.risk_status == 'YELLOW' %}
                                    <i class="bi bi-exclamation-triangle-fill"></i> Riskant
                                {% else %}
                                    <i class="bi bi-x-circle-fill"></i> Verboten
                                {% endif %}
                            </span>
                        </div>
                        
                        <!-- KI Reasoning -->
                        <div class="ki-info">
                            <div class="section-label">KI-Begründung</div>
                            <p class="ki-reasoning mb-0">{{ signal.ki_reasoning|truncatechars:120 }}</p>
                        </div>
                    </div>
                    
                    <div class="signal-card-footer">
                        <a href="{% url 'signal_detail' signal.id %}" class="btn btn-trade-details btn-sm">
                            <i class="bi bi-eye"></i> Details
                        </a>
                        
                        <button class="btn btn-trade-live btn-sm" 
                                {% if not signal.can_execute_live %}disabled{% endif %}
                                onclick="executeTrade('{{ signal.id }}', 'live')">
                            <i class="bi bi-lightning-fill"></i> Live Trade
                        </button>
                        
                        <button class="btn btn-trade-shadow btn-sm"
                                onclick="executeTrade('{{ signal.id }}', 'shadow')">
                            <i class="bi bi-eye-slash"></i> Shadow
                        </button>
                        
                        <button class="btn btn-trade-reject btn-sm"
                                onclick="rejectSignal('{{ signal.id }}')">
                            <i class="bi bi-x-lg"></i>
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            <i class="bi bi-graph-up-arrow"></i>
            <h3>Keine aktiven Signale</h3>
            <p>Es sind derzeit keine aktiven Trading-Signale vorhanden.</p>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    function executeTrade(signalId, tradeType) {
        const url = tradeType === 'live' 
            ? `/fiona/signals/${signalId}/live/`
            : `/fiona/signals/${signalId}/shadow/`;
        
        fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert('Fehler: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Ein Fehler ist aufgetreten.');
        });
    }
    
    function rejectSignal(signalId) {
        if (!confirm('Signal wirklich verwerfen?')) {
            return;
        }
        
        fetch(`/fiona/signals/${signalId}/reject/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert('Fehler: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Ein Fehler ist aufgetreten.');
        });
    }
    
    // Account state auto-refresh functionality
    let accountRefreshInterval = null;
    const REFRESH_INTERVAL = 30000; // 30 seconds
    
    function formatCurrency(value, currency) {
        const num = parseFloat(value);
        if (isNaN(num)) return '--';
        return new Intl.NumberFormat('de-DE', {
            style: 'currency',
            currency: currency || 'EUR',
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        }).format(num);
    }
    
    function updateAccountStatus(status, text) {
        const statusEl = document.getElementById('account-status');
        if (!statusEl) return;
        
        statusEl.className = 'account-info-status ' + status;
        statusEl.innerHTML = '<i class="bi bi-circle-fill"></i> <span>' + text + '</span>';
    }
    
    function setRefreshButtonLoading(loading) {
        const btn = document.getElementById('refresh-account-btn');
        if (!btn) return;
        
        if (loading) {
            btn.classList.add('spinning');
            btn.disabled = true;
        } else {
            btn.classList.remove('spinning');
            btn.disabled = false;
        }
    }
    
    function updateAccountInfo(data) {
        const currency = data.currency || 'EUR';
        
        // Update balance
        const balanceEl = document.getElementById('account-balance');
        if (balanceEl) {
            balanceEl.textContent = formatCurrency(data.balance, currency);
        }
        
        // Update available
        const availableEl = document.getElementById('account-available');
        if (availableEl) {
            availableEl.textContent = formatCurrency(data.available, currency);
        }
        
        // Update margin used
        const marginUsedEl = document.getElementById('account-margin-used');
        if (marginUsedEl) {
            marginUsedEl.textContent = formatCurrency(data.margin_used, currency);
        }
        
        // Update margin available
        const marginAvailableEl = document.getElementById('account-margin-available');
        if (marginAvailableEl) {
            marginAvailableEl.textContent = formatCurrency(data.margin_available, currency);
        }
        
        // Update P&L with color coding
        const pnlEl = document.getElementById('account-pnl');
        if (pnlEl) {
            const pnlValue = parseFloat(data.unrealized_pnl);
            pnlEl.textContent = formatCurrency(data.unrealized_pnl, currency);
            pnlEl.classList.remove('positive', 'negative');
            if (!isNaN(pnlValue)) {
                if (pnlValue > 0) {
                    pnlEl.classList.add('positive');
                } else if (pnlValue < 0) {
                    pnlEl.classList.add('negative');
                }
            }
        }
    }
    
    function showAccountError(errorMessage) {
        const contentEl = document.getElementById('account-info-content');
        if (contentEl) {
            contentEl.innerHTML = '<div class="account-info-error"><i class="bi bi-exclamation-triangle"></i> ' + errorMessage + '</div>';
        }
    }
    
    // Account info grid template - used for both initial render and reset
    const ACCOUNT_INFO_GRID_TEMPLATE = `
        <div class="account-info-grid">
            <div class="account-info-item">
                <div class="account-info-value" id="account-balance">--</div>
                <div class="account-info-label">Kontostand</div>
            </div>
            <div class="account-info-item">
                <div class="account-info-value" id="account-available">--</div>
                <div class="account-info-label">Verfügbar</div>
            </div>
            <div class="account-info-item">
                <div class="account-info-value" id="account-margin-used">--</div>
                <div class="account-info-label">Margin (genutzt)</div>
            </div>
            <div class="account-info-item">
                <div class="account-info-value" id="account-margin-available">--</div>
                <div class="account-info-label">Margin (verfügbar)</div>
            </div>
            <div class="account-info-item">
                <div class="account-info-value" id="account-pnl">--</div>
                <div class="account-info-label">Unrealisiert P&L</div>
            </div>
        </div>
    `;
    
    function resetAccountInfoGrid() {
        const contentEl = document.getElementById('account-info-content');
        if (contentEl) {
            contentEl.innerHTML = ACCOUNT_INFO_GRID_TEMPLATE;
        }
    }
    
    function refreshAccountState() {
        updateAccountStatus('loading', 'Lädt...');
        setRefreshButtonLoading(true);
        resetAccountInfoGrid();
        
        fetch('/fiona/api/account-state/', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            setRefreshButtonLoading(false);
            
            if (data.success) {
                updateAccountStatus('connected', 'Verbunden');
                updateAccountInfo(data.data);
            } else {
                updateAccountStatus('disconnected', 'Nicht verbunden');
                showAccountError(data.error || 'Verbindung fehlgeschlagen');
            }
        })
        .catch(error => {
            console.error('Account state error:', error);
            setRefreshButtonLoading(false);
            updateAccountStatus('disconnected', 'Fehler');
            showAccountError('Verbindungsfehler');
        });
    }
    
    function startAutoRefresh() {
        // Initial load
        refreshAccountState();
        refreshWorkerStatus();
        
        // Set up interval for auto-refresh
        accountRefreshInterval = setInterval(refreshAccountState, REFRESH_INTERVAL);
        workerRefreshInterval = setInterval(refreshWorkerStatus, WORKER_REFRESH_INTERVAL);
    }
    
    function stopAutoRefresh() {
        if (accountRefreshInterval) {
            clearInterval(accountRefreshInterval);
            accountRefreshInterval = null;
        }
        if (workerRefreshInterval) {
            clearInterval(workerRefreshInterval);
            workerRefreshInterval = null;
        }
    }
    
    // Worker Status refresh functionality
    let workerRefreshInterval = null;
    const WORKER_REFRESH_INTERVAL = 30000; // 30 seconds
    
    function updateWorkerStatusIndicator(status, text) {
        const indicatorEl = document.getElementById('worker-status-indicator');
        if (!indicatorEl) return;
        
        indicatorEl.className = 'worker-status-indicator ' + status;
        indicatorEl.innerHTML = '<i class="bi bi-circle-fill"></i> <span>' + text + '</span>';
    }
    
    function setWorkerRefreshButtonLoading(loading) {
        const btn = document.getElementById('refresh-worker-btn');
        if (!btn) return;
        
        if (loading) {
            btn.classList.add('spinning');
            btn.disabled = true;
        } else {
            btn.classList.remove('spinning');
            btn.disabled = false;
        }
    }
    
    // Constants for display formatting
    const EPIC_MAX_DISPLAY_LENGTH = 15;
    const EPIC_TRUNCATED_LENGTH = 12;
    
    function formatTimeAgo(seconds) {
        if (seconds < 60) {
            return 'vor ' + seconds + 's';
        } else if (seconds < 3600) {
            const minutes = Math.floor(seconds / 60);
            return 'vor ' + minutes + ' Min.';
        } else {
            const hours = Math.floor(seconds / 3600);
            return 'vor ' + hours + ' Std.';
        }
    }
    
    function formatTime(isoString) {
        // Note: UTC is used intentionally for trading time consistency
        const date = new Date(isoString);
        return date.toLocaleTimeString('de-DE', { 
            hour: '2-digit', 
            minute: '2-digit', 
            second: '2-digit',
            timeZone: 'UTC'
        }) + ' UTC';
    }
    
    function updateWorkerInfo(data) {
        // Update last activity
        const lastActivityEl = document.getElementById('worker-last-activity');
        if (lastActivityEl && data.last_run_at) {
            const timeStr = formatTime(data.last_run_at);
            const agoStr = formatTimeAgo(data.seconds_since_last_run);
            lastActivityEl.innerHTML = timeStr + '<br><small>' + agoStr + '</small>';
        }
        
        // Update phase
        const phaseEl = document.getElementById('worker-phase');
        if (phaseEl) {
            phaseEl.textContent = data.phase || '--';
        }
        
        // Update epic
        const epicEl = document.getElementById('worker-epic');
        if (epicEl) {
            // Shorten the epic for display if too long
            const epic = data.epic || '--';
            epicEl.textContent = epic.length > EPIC_MAX_DISPLAY_LENGTH 
                ? epic.substring(0, EPIC_TRUNCATED_LENGTH) + '...' 
                : epic;
            epicEl.title = epic;
        }
        
        // Update price
        const priceEl = document.getElementById('worker-price');
        if (priceEl && data.price_info) {
            if (data.price_info.bid && data.price_info.ask) {
                priceEl.textContent = data.price_info.bid + '/' + data.price_info.ask;
            } else {
                priceEl.textContent = '--';
            }
        }
        
        // Update setup count
        const setupCountEl = document.getElementById('worker-setup-count');
        if (setupCountEl) {
            setupCountEl.textContent = data.setup_count !== undefined ? data.setup_count : '--';
        }
        
        // Update interval
        const intervalEl = document.getElementById('worker-interval');
        if (intervalEl) {
            intervalEl.textContent = data.worker_interval ? (data.worker_interval + 's') : '--';
        }
        
        // Update diagnostic message
        const diagnosticEl = document.getElementById('worker-diagnostic-message');
        if (diagnosticEl) {
            diagnosticEl.textContent = data.diagnostic_message || 'Keine Diagnose verfügbar';
        }
    }
    
    function showWorkerError(errorMessage) {
        const contentEl = document.getElementById('worker-status-content');
        if (contentEl) {
            contentEl.innerHTML = '<div class="worker-status-error"><i class="bi bi-exclamation-triangle"></i> ' + errorMessage + '</div>';
        }
    }
    
    // Worker status grid template
    const WORKER_STATUS_GRID_TEMPLATE = `
        <div class="worker-status-grid">
            <div class="worker-status-item">
                <div class="worker-status-value" id="worker-last-activity">--</div>
                <div class="worker-status-label">Letzte Aktivität</div>
            </div>
            <div class="worker-status-item">
                <div class="worker-status-value" id="worker-phase">--</div>
                <div class="worker-status-label">Phase</div>
            </div>
            <div class="worker-status-item">
                <div class="worker-status-value" id="worker-epic">--</div>
                <div class="worker-status-label">Epic</div>
            </div>
            <div class="worker-status-item">
                <div class="worker-status-value" id="worker-price">--</div>
                <div class="worker-status-label">Preis (Bid/Ask)</div>
            </div>
            <div class="worker-status-item">
                <div class="worker-status-value" id="worker-setup-count">--</div>
                <div class="worker-status-label">Setups gefunden</div>
            </div>
            <div class="worker-status-item">
                <div class="worker-status-value" id="worker-interval">--</div>
                <div class="worker-status-label">Intervall</div>
            </div>
        </div>
        <div class="worker-diagnostic" id="worker-diagnostic">
            <div class="label">Diagnose</div>
            <div class="message" id="worker-diagnostic-message">--</div>
        </div>
    `;
    
    function resetWorkerStatusGrid() {
        const contentEl = document.getElementById('worker-status-content');
        if (contentEl) {
            contentEl.innerHTML = WORKER_STATUS_GRID_TEMPLATE;
        }
    }
    
    function refreshWorkerStatus() {
        updateWorkerStatusIndicator('loading', 'Lädt...');
        setWorkerRefreshButtonLoading(true);
        
        fetch('/fiona/api/worker/status/', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            setWorkerRefreshButtonLoading(false);
            
            if (data.success) {
                if (data.worker_status === 'NO_DATA') {
                    updateWorkerStatusIndicator('no-data', 'Keine Daten');
                    resetWorkerStatusGrid();
                    document.getElementById('worker-diagnostic-message').textContent = data.status_message;
                } else if (data.worker_status === 'ONLINE') {
                    updateWorkerStatusIndicator('online', 'ONLINE');
                    resetWorkerStatusGrid();
                    updateWorkerInfo(data.data);
                } else {
                    updateWorkerStatusIndicator('offline', 'OFFLINE');
                    resetWorkerStatusGrid();
                    updateWorkerInfo(data.data);
                }
            } else {
                updateWorkerStatusIndicator('offline', 'Fehler');
                showWorkerError(data.status_message || 'Unbekannter Fehler');
            }
        })
        .catch(error => {
            console.error('Worker status error:', error);
            setWorkerRefreshButtonLoading(false);
            updateWorkerStatusIndicator('offline', 'Fehler');
            showWorkerError('Verbindungsfehler');
        });
    }
    
    // Start auto-refresh when page loads
    document.addEventListener('DOMContentLoaded', function() {
        startAutoRefresh();
    });
    
    // Stop auto-refresh when page is hidden to save resources
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            stopAutoRefresh();
        } else {
            startAutoRefresh();
        }
    });
</script>
{% endblock %}
