{% extends 'core/base.html' %}
{% load static %}

{% block title %}Fiona - Breakout Distance Chart{% endblock %}

{% block extra_css %}
<style>
    /* Breakout Distance Chart Styles */
    :root {
        --fiona-bg-dark: #1a1d21;
        --fiona-card-dark: #2d3239;
        --fiona-card-header: #3a4149;
        --fiona-text-light: #e9ecef;
        --fiona-text-muted: #8b949e;
        --fiona-border: #484f58;
        --range-asia: rgba(255, 193, 7, 0.3);
        --range-london: rgba(59, 130, 246, 0.3);
        --range-us: rgba(34, 197, 94, 0.3);
        --breakout-long: #22c55e;
        --breakout-short: #ef4444;
    }

    .chart-dashboard {
        background-color: var(--fiona-bg-dark);
        min-height: 100vh;
        color: var(--fiona-text-light);
        padding: 1rem;
    }

    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid var(--fiona-border);
        flex-wrap: wrap;
        gap: 0.75rem;
    }

    .chart-header h1 {
        color: var(--fiona-text-light);
        margin: 0;
        font-size: 1.5rem;
    }

    .chart-controls {
        display: flex;
        gap: 1rem;
        align-items: center;
        flex-wrap: wrap;
    }

    .control-group {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .control-label {
        color: var(--fiona-text-muted);
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .control-select {
        background-color: var(--fiona-card-dark);
        border: 1px solid var(--fiona-border);
        color: var(--fiona-text-light);
        padding: 0.4rem 0.75rem;
        border-radius: 6px;
        font-size: 0.9rem;
        min-width: 100px;
    }

    .control-select:focus {
        outline: none;
        border-color: #3b82f6;
    }

    .time-window-btns {
        display: flex;
        gap: 0.25rem;
    }

    .time-btn {
        background-color: var(--fiona-card-dark);
        border: 1px solid var(--fiona-border);
        color: var(--fiona-text-muted);
        padding: 0.35rem 0.6rem;
        border-radius: 4px;
        font-size: 0.75rem;
        cursor: pointer;
        transition: all 0.2s;
    }

    .time-btn:hover {
        background-color: var(--fiona-card-header);
        color: var(--fiona-text-light);
    }

    .time-btn.active {
        background-color: #3b82f6;
        border-color: #3b82f6;
        color: white;
    }

    /* Chart Container */
    .chart-container {
        display: grid;
        grid-template-columns: 1fr 300px;
        gap: 1rem;
        height: calc(100vh - 180px);
        min-height: 500px;
    }

    @media (max-width: 992px) {
        .chart-container {
            grid-template-columns: 1fr;
            height: auto;
        }
    }

    .chart-panel {
        background-color: var(--fiona-card-dark);
        border: 1px solid var(--fiona-border);
        border-radius: 8px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    .chart-area {
        flex: 1;
        min-height: 400px;
        position: relative;
    }

    #candlestick-chart {
        width: 100%;
        height: 100%;
    }

    /* Range Toggle Switches */
    .range-toggles {
        display: flex;
        gap: 0.75rem;
        padding: 0.75rem 1rem;
        background-color: var(--fiona-card-header);
        border-top: 1px solid var(--fiona-border);
        flex-wrap: wrap;
    }

    .range-toggle {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .range-toggle input[type="checkbox"] {
        width: 16px;
        height: 16px;
        accent-color: #3b82f6;
    }

    .range-toggle label {
        font-size: 0.8rem;
        color: var(--fiona-text-light);
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.35rem;
    }

    .range-color-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        display: inline-block;
    }

    .range-color-dot.asia { background-color: #ffc107; }
    .range-color-dot.london { background-color: #3b82f6; }
    .range-color-dot.us { background-color: #22c55e; }

    /* Info Panel */
    .info-panel {
        background-color: var(--fiona-card-dark);
        border: 1px solid var(--fiona-border);
        border-radius: 8px;
        display: flex;
        flex-direction: column;
    }

    .info-panel-header {
        padding: 0.75rem 1rem;
        background-color: var(--fiona-card-header);
        border-bottom: 1px solid var(--fiona-border);
    }

    .info-panel-header h3 {
        margin: 0;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--fiona-text-light);
    }

    .info-panel-content {
        flex: 1;
        padding: 1rem;
        overflow-y: auto;
    }

    .info-section {
        margin-bottom: 1.25rem;
    }

    .info-section:last-child {
        margin-bottom: 0;
    }

    .info-section-title {
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--fiona-text-muted);
        margin-bottom: 0.5rem;
        padding-bottom: 0.25rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .info-row {
        display: flex;
        justify-content: space-between;
        padding: 0.35rem 0;
        font-size: 0.85rem;
    }

    .info-label {
        color: var(--fiona-text-muted);
    }

    .info-value {
        font-weight: 600;
        font-family: 'Roboto Mono', monospace;
        color: var(--fiona-text-light);
    }

    .info-value.price-high {
        color: var(--breakout-long);
    }

    .info-value.price-low {
        color: var(--breakout-short);
    }

    .info-value.phase {
        color: #3b82f6;
    }

    /* Status Badge */
    .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.25rem 0.6rem;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .status-badge.inside {
        background-color: rgba(34, 197, 94, 0.2);
        color: var(--breakout-long);
        border: 1px solid var(--breakout-long);
    }

    .status-badge.above {
        background-color: rgba(34, 197, 94, 0.2);
        color: var(--breakout-long);
        border: 1px solid var(--breakout-long);
    }

    .status-badge.below {
        background-color: rgba(239, 68, 68, 0.2);
        color: var(--breakout-short);
        border: 1px solid var(--breakout-short);
    }

    /* Loading State */
    .chart-loading {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: var(--fiona-text-muted);
    }

    .chart-loading i {
        font-size: 2rem;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }

    .chart-error {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: var(--fiona-text-muted);
        text-align: center;
        padding: 2rem;
    }

    .chart-error i {
        font-size: 2.5rem;
        margin-bottom: 1rem;
        color: #ef4444;
    }

    /* Back Link */
    .back-link {
        color: var(--fiona-text-muted);
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        font-size: 0.85rem;
        transition: color 0.2s;
    }

    .back-link:hover {
        color: var(--fiona-text-light);
    }

    /* Data Status Indicator */
    .data-status-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.35rem 0.65rem;
        border-radius: 4px;
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .data-status-badge i {
        font-size: 0.5rem;
    }

    .data-status-badge.live {
        background-color: rgba(34, 197, 94, 0.2);
        color: #22c55e;
        border: 1px solid #22c55e;
    }

    .data-status-badge.poll {
        background-color: rgba(59, 130, 246, 0.2);
        color: #3b82f6;
        border: 1px solid #3b82f6;
    }

    .data-status-badge.cached {
        background-color: rgba(255, 193, 7, 0.2);
        color: #ffc107;
        border: 1px solid #ffc107;
    }

    .data-status-badge.offline {
        background-color: rgba(239, 68, 68, 0.2);
        color: #ef4444;
        border: 1px solid #ef4444;
    }
</style>
{% endblock %}

{% block content %}
<div class="chart-dashboard">
    <div class="container-fluid">
        <!-- Header -->
        <div class="chart-header">
            <div>
                <a href="{% url 'signal_dashboard' %}" class="back-link">
                    <i class="bi bi-arrow-left"></i> Zurück zum Dashboard
                </a>
                <h1><i class="bi bi-graph-up"></i> Breakout Distance Chart</h1>
            </div>
            <div class="chart-controls">
                <!-- Asset Selector -->
                <div class="control-group">
                    <span class="control-label">Asset</span>
                    <select id="asset-selector" class="control-select" onchange="changeAsset(this.value, this.options[this.selectedIndex].dataset.id)">
                        {% for asset in active_assets %}
                        <option value="{{ asset.symbol }}" data-id="{{ asset.id }}" {% if selected_asset and asset.id == selected_asset.id %}selected{% endif %}>
                            {{ asset.symbol }} - {{ asset.name }}
                        </option>
                        {% empty %}
                        <option value="">Keine Assets</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Time Window -->
                <div class="control-group">
                    <span class="control-label">Zeitfenster</span>
                    <div class="time-window-btns">
                        {% for hours in time_windows %}
                        <button class="time-btn {% if hours == selected_hours %}active{% endif %}"
                                data-hours="{{ hours }}"
                                onclick="changeTimeWindow({{ hours }})">
                            {{ hours }}h
                        </button>
                        {% endfor %}
                    </div>
                </div>

                <!-- Refresh Button -->
                <button class="btn btn-sm btn-outline-light" onclick="refreshChart()" title="Aktualisieren">
                    <i class="bi bi-arrow-clockwise"></i>
                </button>

                <!-- Data Status Indicator -->
                <div class="control-group" id="data-status-group">
                    <span id="data-status" class="data-status-badge offline" title="Datenstatus">
                        <i class="bi bi-circle-fill"></i> <span id="data-status-text">OFFLINE</span>
                    </span>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="chart-container">
            <!-- Chart Panel -->
            <div class="chart-panel">
                <div class="chart-area">
                    <div id="candlestick-chart">
                        <div class="chart-loading">
                            <i class="bi bi-hourglass-split"></i>
                        </div>
                    </div>
                </div>
                <!-- Range Toggle Switches -->
                <div class="range-toggles">
                    <div class="range-toggle">
                        <input type="checkbox" id="toggle-asia" checked onchange="toggleRange('asia', this.checked)">
                        <label for="toggle-asia">
                            <span class="range-color-dot asia"></span>
                            Asia Range
                        </label>
                    </div>
                    <div class="range-toggle">
                        <input type="checkbox" id="toggle-london" checked onchange="toggleRange('london', this.checked)">
                        <label for="toggle-london">
                            <span class="range-color-dot london"></span>
                            London Range
                        </label>
                    </div>
                    <div class="range-toggle">
                        <input type="checkbox" id="toggle-us" checked onchange="toggleRange('us', this.checked)">
                        <label for="toggle-us">
                            <span class="range-color-dot us"></span>
                            US Core Range
                        </label>
                    </div>
                </div>
            </div>

            <!-- Info Panel -->
            <div class="info-panel">
                <div class="info-panel-header">
                    <h3><i class="bi bi-info-circle"></i> Breakout Info</h3>
                </div>
                <div class="info-panel-content">
                    <!-- Asset Info -->
                    <div class="info-section">
                        <div class="info-section-title">Asset</div>
                        <div class="info-row">
                            <span class="info-label">Symbol</span>
                            <span class="info-value" id="info-asset">{% if selected_asset %}{{ selected_asset.symbol }}{% else %}--{% endif %}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Phase</span>
                            <span class="info-value phase" id="info-phase">--</span>
                        </div>
                    </div>

                    <!-- Range Info -->
                    <div class="info-section">
                        <div class="info-section-title">Referenz-Range</div>
                        <div class="info-row">
                            <span class="info-label">Range Typ</span>
                            <span class="info-value" id="info-reference-phase">--</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">High</span>
                            <span class="info-value price-high" id="info-range-high">--</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Low</span>
                            <span class="info-value price-low" id="info-range-low">--</span>
                        </div>
                    </div>

                    <!-- Breakout Levels -->
                    <div class="info-section">
                        <div class="info-section-title">Breakout Levels</div>
                        <div class="info-row">
                            <span class="info-label">Long Trigger</span>
                            <span class="info-value price-high" id="info-breakout-long">--</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Short Trigger</span>
                            <span class="info-value price-low" id="info-breakout-short">--</span>
                        </div>
                    </div>

                    <!-- Current Price -->
                    <div class="info-section">
                        <div class="info-section-title">Preis-Position</div>
                        <div class="info-row">
                            <span class="info-label">Aktueller Preis</span>
                            <span class="info-value" id="info-current-price">--</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Status</span>
                            <span id="info-status">
                                <span class="status-badge inside">
                                    <i class="bi bi-arrows-collapse"></i> Innerhalb
                                </span>
                            </span>
                        </div>
                    </div>

                    <!-- Tick Distances -->
                    <div class="info-section">
                        <div class="info-section-title">Distanzen</div>
                        <div class="info-row">
                            <span class="info-label">Zu High</span>
                            <span class="info-value" id="info-distance-high">-- Ticks</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Zu Low</span>
                            <span class="info-value" id="info-distance-low">-- Ticks</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Tick Size</span>
                            <span class="info-value" id="info-tick-size">{% if selected_asset %}{{ selected_asset.tick_size }}{% else %}--{% endif %}</span>
                        </div>
                    </div>

                    <!-- Chart Info -->
                    <div class="info-section">
                        <div class="info-section-title">Chart-Daten</div>
                        <div class="info-row">
                            <span class="info-label">Kerzen</span>
                            <span class="info-value" id="info-candle-count">--</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Timeframe</span>
                            <span class="info-value" id="info-timeframe">1m</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Zeitfenster</span>
                            <span class="info-value" id="info-window">{{ selected_hours }}h</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'core/js/lightweight-charts.standalone.production.js' %}"></script>
<script>
    // Chart state
    let chart = null;
    let candlestickSeries = null;
    let priceLines = {};
    let rangeMarkers = {};
    let resizeListenerAdded = false;
    let refreshInterval = null;
    let currentCandles = [];

    // Configuration
    const REFRESH_INTERVAL_MS = 30000;  // Auto-refresh every 30 seconds

    // Current settings
    let currentAsset = '{{ selected_asset.symbol|default:"" }}';
    let currentAssetId = '{{ selected_asset.id|default:"" }}';
    let currentHours = {{ selected_hours }};
    let currentTimeframe = '1m';  // Default to 1-minute candles for realtime
    let rangeVisibility = {
        asia: true,
        london: true,
        us: true
    };

    // Colors
    const colors = {
        asia: { fill: 'rgba(255, 193, 7, 0.15)', line: '#ffc107' },
        london: { fill: 'rgba(59, 130, 246, 0.15)', line: '#3b82f6' },
        us: { fill: 'rgba(34, 197, 94, 0.15)', line: '#22c55e' },
        breakoutLong: '#22c55e',
        breakoutShort: '#ef4444',
        rangeHigh: '#fbbf24',
        rangeLow: '#fb923c',
    };

    // Initialize chart (called once on page load)
    function initChart() {
        const container = document.getElementById('candlestick-chart');
        
        // Handle resize (only add once)
        if (!resizeListenerAdded) {
            window.addEventListener('resize', () => {
                if (chart) {
                    chart.resize(container.offsetWidth, container.offsetHeight);
                }
            });
            resizeListenerAdded = true;
        }

        // Load data (this will create the chart after data is fetched)
        loadChartData();
    }

    // Create chart and series
    function createChartAndSeries() {
        const container = document.getElementById('candlestick-chart');
        container.innerHTML = '';

        chart = LightweightCharts.createChart(container, {
            width: container.offsetWidth,
            height: container.offsetHeight,
            layout: {
                background: { type: 'solid', color: '#2d3239' },
                textColor: '#e9ecef',
            },
            grid: {
                vertLines: { color: 'rgba(255, 255, 255, 0.1)' },
                horzLines: { color: 'rgba(255, 255, 255, 0.1)' },
            },
            crosshair: {
                mode: LightweightCharts.CrosshairMode.Normal,
            },
            rightPriceScale: {
                borderColor: '#484f58',
            },
            timeScale: {
                borderColor: '#484f58',
                timeVisible: true,
                secondsVisible: false,
            },
        });

        // Create candlestick series
        candlestickSeries = chart.addCandlestickSeries({
            upColor: '#22c55e',
            downColor: '#ef4444',
            borderUpColor: '#22c55e',
            borderDownColor: '#ef4444',
            wickUpColor: '#22c55e',
            wickDownColor: '#ef4444',
        });

        // Reset price lines since we're creating a new chart
        priceLines = {};
    }

    // Load chart data
    async function loadChartData() {
        if (!currentAssetId) {
            showError('Kein Asset ausgewählt');
            return;
        }

        const firstLoad = !chart;

        // Only replace the container with a loading spinner when the chart
        // doesn't exist yet. For existing charts (e.g., switching assets or
        // time windows), keep the chart DOM intact so Lightweight Charts keeps
        // its canvas mounted and we can update the data in place.
        if (firstLoad) {
            showLoading();
        }

        try {
            // Use the new Market Data Layer API for candles (broker-agnostic, Redis-backed)
            // Also load breakout context and session ranges for overlay data
            const [candlesRes, contextRes, rangesRes] = await Promise.all([
                fetch(`/fiona/api/breakout-distance-candles?asset_id=${currentAssetId}&timeframe=${currentTimeframe}&window=${currentHours}&force_refresh=1`),
                fetch(`/fiona/api/chart/${currentAsset}/breakout-context`),
                fetch(`/fiona/api/chart/${currentAsset}/session-ranges?hours=${currentHours}`),
            ]);

            const candlesData = await candlesRes.json();
            const contextData = await contextRes.json();
            const rangesData = await rangesRes.json();

            // Update data status indicator
            if (candlesData.success && candlesData.status) {
                updateDataStatus(candlesData.status);
            } else {
                updateDataStatus({ status: 'OFFLINE', error: candlesData.error });
            }

            const sanitizedCandles = sanitizeCandles(candlesData.candles);

            if (candlesData.success && sanitizedCandles.length > 0) {
                if (!chart) {
                    createChartAndSeries();
                }

                // Update candle cache and chart without destroying the existing view
                updateCandles(sanitizedCandles);

                if (firstLoad && chart) {
                    chart.timeScale().fitContent();
                }

                // Update info panel with candle count
                document.getElementById('info-candle-count').textContent = `${sanitizedCandles.length} Candles`;
            } else {
                if (firstLoad) {
                    showError(candlesData.error || 'Keine Kerzen-Daten verfügbar');
                }
                return;
            }

            // Update info panel
            if (contextData.success) {
                updateInfoPanel(contextData);
            }

            // Draw range lines
            if (rangesData.success && rangesData.ranges) {
                drawSessionRanges(rangesData.ranges, contextData);
            }

            // Draw breakout context lines
            if (contextData.success) {
                drawBreakoutContext(contextData);
            }

        } catch (error) {
            console.error('Error loading chart data:', error);
            updateDataStatus({ status: 'OFFLINE', error: error.message });
            if (firstLoad) {
                showError('Fehler beim Laden der Chart-Daten');
            }
        }
    }

    function sanitizeCandles(candles) {
        if (!Array.isArray(candles)) {
            return [];
        }

        const validCandles = [];

        for (const candle of candles) {
            if (!candle) continue;

            const requiredFields = ['time', 'open', 'high', 'low', 'close'];
            if (requiredFields.some((key) => candle[key] === null || candle[key] === undefined)) {
                continue;
            }

            const normalizedCandle = {
                time: Number(candle.time),
                open: Number(candle.open),
                high: Number(candle.high),
                low: Number(candle.low),
                close: Number(candle.close),
            };

            if (Object.values(normalizedCandle).some((value) => Number.isNaN(value))) {
                continue;
            }

            if (candle.volume !== null && candle.volume !== undefined) {
                const volume = Number(candle.volume);
                if (!Number.isNaN(volume)) {
                    normalizedCandle.volume = volume;
                }
            }

            if (candle.complete === false) {
                normalizedCandle.complete = false;
            }

            validCandles.push(normalizedCandle);
        }

        return validCandles;
    }

    // Update candles in place to avoid full chart reloads
    function updateCandles(newCandles) {
        if (!newCandles || newCandles.length === 0 || !candlestickSeries) {
            return;
        }

        if (!currentCandles.length) {
            currentCandles = [...newCandles];
        } else {
            const candleMap = new Map(currentCandles.map(c => [c.time, c]));
            for (const candle of newCandles) {
                candleMap.set(candle.time, candle);
            }
            currentCandles = Array.from(candleMap.values()).sort((a, b) => a.time - b.time);
        }

        candlestickSeries.setData(currentCandles);
    }

    // Update data status indicator
    function updateDataStatus(statusData) {
        const badge = document.getElementById('data-status');
        const text = document.getElementById('data-status-text');
        
        if (!badge || !text) return;
        
        // Remove all status classes
        badge.classList.remove('live', 'poll', 'cached', 'offline');
        
        const status = statusData.status || 'OFFLINE';
        let displayText = status;
        let cssClass = 'offline';
        let tooltip = 'Datenstatus';
        
        switch (status.toUpperCase()) {
            case 'LIVE':
                cssClass = 'live';
                displayText = 'LIVE';
                tooltip = 'Echtzeit-Stream aktiv';
                break;
            case 'POLL':
                cssClass = 'poll';
                displayText = 'POLL';
                tooltip = 'Fallback: REST-Polling';
                break;
            case 'CACHED':
                cssClass = 'cached';
                displayText = 'CACHE';
                tooltip = 'Daten aus Redis-Cache';
                break;
            case 'OFFLINE':
            default:
                cssClass = 'offline';
                displayText = 'OFFLINE';
                tooltip = statusData.error || 'Keine Daten / Verbindungsfehler';
                break;
        }
        
        badge.classList.add(cssClass);
        text.textContent = displayText;
        badge.title = tooltip;
    }

    // Draw session ranges as horizontal lines
    function drawSessionRanges(ranges, context) {
        // Remove existing range lines
        for (const key in priceLines) {
            if (key.startsWith('range_')) {
                try {
                    candlestickSeries.removePriceLine(priceLines[key]);
                } catch (e) {}
                delete priceLines[key];
            }
        }

        const phaseMapping = {
            'ASIA_RANGE': 'asia',
            'LONDON_CORE': 'london',
            'PRE_US_RANGE': 'us',
            'US_CORE_TRADING': 'us',
        };

        for (const [phase, rangeData] of Object.entries(ranges)) {
            const rangeKey = phaseMapping[phase];
            if (!rangeKey || !rangeVisibility[rangeKey]) continue;
            if (!rangeData.is_valid || !rangeData.high || !rangeData.low) continue;

            const color = colors[rangeKey];

            // Draw high line
            priceLines[`range_${phase}_high`] = candlestickSeries.createPriceLine({
                price: rangeData.high,
                color: color.line,
                lineWidth: 1,
                lineStyle: LightweightCharts.LineStyle.Dashed,
                axisLabelVisible: true,
                title: `${rangeData.phase_display} High`,
            });

            // Draw low line
            priceLines[`range_${phase}_low`] = candlestickSeries.createPriceLine({
                price: rangeData.low,
                color: color.line,
                lineWidth: 1,
                lineStyle: LightweightCharts.LineStyle.Dashed,
                axisLabelVisible: true,
                title: `${rangeData.phase_display} Low`,
            });
        }
    }

    // Draw breakout context (current trading levels)
    function drawBreakoutContext(context) {
        // Remove existing breakout lines
        for (const key of ['breakout_long', 'breakout_short', 'range_high', 'range_low']) {
            if (priceLines[key]) {
                try {
                    candlestickSeries.removePriceLine(priceLines[key]);
                } catch (e) {}
                delete priceLines[key];
            }
        }

        // Only draw if we have valid range data
        if (!context.range_high || !context.range_low) return;

        // Draw range boundaries (solid lines)
        priceLines['range_high'] = candlestickSeries.createPriceLine({
            price: context.range_high,
            color: colors.rangeHigh,
            lineWidth: 2,
            lineStyle: LightweightCharts.LineStyle.Solid,
            axisLabelVisible: true,
            title: 'Range High',
        });

        priceLines['range_low'] = candlestickSeries.createPriceLine({
            price: context.range_low,
            color: colors.rangeLow,
            lineWidth: 2,
            lineStyle: LightweightCharts.LineStyle.Solid,
            axisLabelVisible: true,
            title: 'Range Low',
        });

        // Draw breakout levels (dashed lines)
        if (context.breakout_long_level) {
            priceLines['breakout_long'] = candlestickSeries.createPriceLine({
                price: context.breakout_long_level,
                color: colors.breakoutLong,
                lineWidth: 1,
                lineStyle: LightweightCharts.LineStyle.Dotted,
                axisLabelVisible: true,
                title: 'Breakout Long',
            });
        }

        if (context.breakout_short_level) {
            priceLines['breakout_short'] = candlestickSeries.createPriceLine({
                price: context.breakout_short_level,
                color: colors.breakoutShort,
                lineWidth: 1,
                lineStyle: LightweightCharts.LineStyle.Dotted,
                axisLabelVisible: true,
                title: 'Breakout Short',
            });
        }
    }

    // Update info panel
    function updateInfoPanel(context) {
        document.getElementById('info-asset').textContent = currentAsset;
        document.getElementById('info-phase').textContent = formatPhase(context.phase);
        document.getElementById('info-reference-phase').textContent = formatPhase(context.reference_phase || '--');
        
        document.getElementById('info-range-high').textContent = context.range_high ? context.range_high.toFixed(2) : '--';
        document.getElementById('info-range-low').textContent = context.range_low ? context.range_low.toFixed(2) : '--';
        
        document.getElementById('info-breakout-long').textContent = context.breakout_long_level ? context.breakout_long_level.toFixed(2) : '--';
        document.getElementById('info-breakout-short').textContent = context.breakout_short_level ? context.breakout_short_level.toFixed(2) : '--';
        
        document.getElementById('info-current-price').textContent = context.current_price ? context.current_price.toFixed(2) : '--';
        document.getElementById('info-tick-size').textContent = context.tick_size || '--';
        
        // Update distances
        if (context.distance_to_high_ticks !== null) {
            document.getElementById('info-distance-high').textContent = `${context.distance_to_high_ticks} Ticks`;
        } else {
            document.getElementById('info-distance-high').textContent = '-- Ticks';
        }
        
        if (context.distance_to_low_ticks !== null) {
            document.getElementById('info-distance-low').textContent = `${context.distance_to_low_ticks} Ticks`;
        } else {
            document.getElementById('info-distance-low').textContent = '-- Ticks';
        }
        
        // Update status badge
        const statusEl = document.getElementById('info-status');
        if (context.is_above_range) {
            statusEl.innerHTML = '<span class="status-badge above"><i class="bi bi-arrow-up-circle"></i> Oberhalb (Long)</span>';
        } else if (context.is_below_range) {
            statusEl.innerHTML = '<span class="status-badge below"><i class="bi bi-arrow-down-circle"></i> Unterhalb (Short)</span>';
        } else {
            statusEl.innerHTML = '<span class="status-badge inside"><i class="bi bi-arrows-collapse"></i> Innerhalb</span>';
        }
    }

    // Format phase name
    function formatPhase(phase) {
        const phaseNames = {
            'ASIA_RANGE': 'Asia Range',
            'LONDON_CORE': 'London Core',
            'PRE_US_RANGE': 'Pre-US Range',
            'US_CORE_TRADING': 'US Core Trading',
            'OTHER': 'Other',
        };
        return phaseNames[phase] || phase || '--';
    }

    // Show loading state
    function showLoading() {
        const container = document.getElementById('candlestick-chart');
        container.innerHTML = '<div class="chart-loading"><i class="bi bi-hourglass-split"></i></div>';
    }

    // Show error state
    function showError(message) {
        const container = document.getElementById('candlestick-chart');
        container.innerHTML = `
            <div class="chart-error">
                <i class="bi bi-exclamation-triangle"></i>
                <p>${escapeHtml(message)}</p>
                <button class="btn btn-sm btn-outline-light" onclick="refreshChart()">
                    <i class="bi bi-arrow-clockwise"></i> Erneut versuchen
                </button>
            </div>
        `;
    }

    // Escape HTML
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Change asset
    function changeAsset(symbol, assetId) {
        currentAsset = symbol;
        currentAssetId = assetId;
        currentCandles = [];
        // Update tick size display
        document.getElementById('info-asset').textContent = symbol;
        if (chart) {
            loadChartData();
        } else {
            initChart();
        }
    }

    // Change time window
    function changeTimeWindow(hours) {
        currentHours = hours;
        currentCandles = [];

        // Update button states
        document.querySelectorAll('.time-btn').forEach(btn => {
            if (parseInt(btn.dataset.hours) === hours) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });
        
        // Update info panel
        document.getElementById('info-window').textContent = `${hours}h`;
        
        loadChartData();
    }

    // Toggle range visibility
    function toggleRange(rangeType, visible) {
        rangeVisibility[rangeType] = visible;
        loadChartData();
    }

    // Refresh chart
    function refreshChart() {
        loadChartData();
    }

    // Start auto-refresh
    function startAutoRefresh() {
        if (refreshInterval) {
            clearInterval(refreshInterval);
        }
        refreshInterval = setInterval(() => {
            loadChartData();
        }, REFRESH_INTERVAL_MS);
    }

    // Stop auto-refresh
    function stopAutoRefresh() {
        if (refreshInterval) {
            clearInterval(refreshInterval);
            refreshInterval = null;
        }
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        initChart();
        startAutoRefresh();
    });

    // Stop refresh when page is hidden
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            stopAutoRefresh();
        } else {
            loadChartData();
            startAutoRefresh();
        }
    });
</script>
{% endblock %}
