{% extends 'core/base.html' %}

{% block title %}Dashboard - Finoa{% endblock %}

{% block content %}
<div class="container">
    <h1 class="mb-4">
        <i class="bi bi-speedometer2"></i> Dashboard
    </h1>

    <!-- Liquidity & Assets Summary -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card card-finoa summary-card">
                <div class="card-body">
                    <div class="label">Liquidität (Ist)</div>
                    <div class="value {% if liquidity_actual >= 0 %}balance-positive{% else %}balance-negative{% endif %}">
                        {{ liquidity_actual|floatformat:2 }} €
                    </div>
                    <small class="text-muted">Nur liquiditätsrelevant</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card card-finoa summary-card">
                <div class="card-body">
                    <div class="label">Liquidität (Forecast)</div>
                    <div class="value {% if liquidity_forecast >= 0 %}balance-positive{% else %}balance-negative{% endif %}">
                        {{ liquidity_forecast|floatformat:2 }} €
                    </div>
                    <small class="text-muted">Nur liquiditätsrelevant</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card card-finoa summary-card">
                <div class="card-body">
                    <div class="label">Gesamt-Vermögen (Ist)</div>
                    <div class="value {% if assets_actual >= 0 %}balance-positive{% else %}balance-negative{% endif %}">
                        {{ assets_actual|floatformat:2 }} €
                    </div>
                    <small class="text-muted">Alle Konten</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card card-finoa summary-card">
                <div class="card-body">
                    <div class="label">Gesamt-Vermögen (Forecast)</div>
                    <div class="value {% if assets_forecast >= 0 %}balance-positive{% else %}balance-negative{% endif %}">
                        {{ assets_forecast|floatformat:2 }} €
                    </div>
                    <small class="text-muted">Alle Konten</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Overdue & Upcoming Bookings Summary -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card card-finoa summary-card">
                <div class="card-body">
                    <div class="label">Überfällige Buchungen</div>
                    <div class="value {% if overdue_sum >= 0 %}balance-positive{% else %}balance-negative{% endif %}">
                        {{ overdue_sum|floatformat:2 }} €
                    </div>
                    <small class="{% if overdue_deficit >= 0 %}balance-positive{% else %}balance-negative{% endif %}">
                        Fehlbetrag zu Liquidität (Ist): {{ overdue_deficit|floatformat:2 }} €
                    </small>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card card-finoa summary-card">
                <div class="card-body">
                    <div class="label">Fällig in den nächsten 7 Tagen</div>
                    <div class="value {% if upcoming_sum >= 0 %}balance-positive{% else %}balance-negative{% endif %}">
                        {{ upcoming_sum|floatformat:2 }} €
                    </div>
                    <small class="{% if upcoming_deficit >= 0 %}balance-positive{% else %}balance-negative{% endif %}">
                        Fehlbetrag zu Liquidität (Ist): {{ upcoming_deficit|floatformat:2 }} €
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- Time Tracking Summary -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card card-finoa summary-card">
                <div class="card-body">
                    <div class="label">Summe offener Zeiterfassungen</div>
                    <div class="value {% if unbilled_time_sum >= 0 %}balance-positive{% else %}balance-negative{% endif %}">
                        {{ unbilled_time_sum|floatformat:2 }} €
                    </div>
                    <small class="text-muted">
                        Noch nicht abgerechnete Stunden
                        <a href="{% url 'time_tracking' %}?status=unbilled" class="ms-2">
                            <i class="bi bi-arrow-right-circle"></i> Zur Zeiterfassung
                        </a>
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- 6-Month Forecast Charts -->
    <div class="row mb-4">
        <div class="col-lg-6">
            {% if liquidity_timeline_data %}
            <div class="card card-finoa">
                <div class="card-header">
                    <h5 class="mb-0">Liquiditäts-Forecast (6 Monate)</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="liquidityForecastChart"></canvas>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
        <div class="col-lg-6">
            {% if assets_timeline_data %}
            <div class="card card-finoa">
                <div class="card-header">
                    <h5 class="mb-0">Vermögens-Forecast (6 Monate)</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="assetsForecastChart"></canvas>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Account Summaries -->
    <div class="card card-finoa mt-4">
        <div class="card-header">
            <h5 class="mb-0">Konten Übersicht</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-finoa">
                    <thead>
                        <tr>
                            <th>Konto</th>
                            <th>Typ</th>
                            <th class="text-end">Ist-Saldo</th>
                            <th class="text-end">Forecast-Saldo (Monatsende)</th>
                            <th class="text-center">Aktionen</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in account_summaries %}
                        <tr class="account-{{ item.account.type }}">
                            <td>
                                <a href="{% url 'account_detail' item.account.id %}" class="text-decoration-none">
                                    <strong>{{ item.account.name }}</strong>
                                </a>
                            </td>
                            <td>{{ item.account.get_type_display }}</td>
                            <td class="text-end {% if item.actual_balance >= 0 %}balance-positive{% else %}balance-negative{% endif %}">
                                {{ item.actual_balance|floatformat:2 }} €
                            </td>
                            <td class="text-end {% if item.forecast_balance_eom >= 0 %}balance-positive{% else %}balance-negative{% endif %}">
                                {{ item.forecast_balance_eom|floatformat:2 }} €
                                <small class="text-muted">({{ item.forecast_balance_today|floatformat:2 }} €)</small>
                            </td>
                            <td class="text-center">
                                <a href="{% url 'account_detail' item.account.id %}" class="btn btn-sm btn-finoa-secondary">
                                    <i class="bi bi-eye"></i> Details
                                </a>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="text-center text-muted">
                                Keine aktiven Konten vorhanden
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{% if liquidity_timeline_data %}
<script>
    const liquidityCtx = document.getElementById('liquidityForecastChart').getContext('2d');
    const liquidityForecastChart = new Chart(liquidityCtx, {
        type: 'line',
        data: {
            labels: {{ liquidity_timeline_data.months|safe }},
            datasets: [
                {
                    label: 'Ist-Saldo',
                    data: {{ liquidity_timeline_data.actual|safe }},
                    borderColor: '#3A6EA5',
                    backgroundColor: 'rgba(58, 110, 165, 0.1)',
                    tension: 0.4,
                    fill: true
                },
                {
                    label: 'Forecast-Saldo',
                    data: {{ liquidity_timeline_data.forecast|safe }},
                    borderColor: '#39A77B',
                    backgroundColor: 'rgba(57, 167, 123, 0.1)',
                    tension: 0.4,
                    fill: true,
                    borderDash: [5, 5]
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ' + 
                                   context.parsed.y.toFixed(2) + ' €';
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: false,
                    ticks: {
                        callback: function(value) {
                            return value.toFixed(0) + ' €';
                        }
                    }
                }
            }
        }
    });
</script>
{% endif %}

{% if assets_timeline_data %}
<script>
    const assetsCtx = document.getElementById('assetsForecastChart').getContext('2d');
    const assetsForecastChart = new Chart(assetsCtx, {
        type: 'line',
        data: {
            labels: {{ assets_timeline_data.months|safe }},
            datasets: [
                {
                    label: 'Ist-Saldo',
                    data: {{ assets_timeline_data.actual|safe }},
                    borderColor: '#3A6EA5',
                    backgroundColor: 'rgba(58, 110, 165, 0.1)',
                    tension: 0.4,
                    fill: true
                },
                {
                    label: 'Forecast-Saldo',
                    data: {{ assets_timeline_data.forecast|safe }},
                    borderColor: '#39A77B',
                    backgroundColor: 'rgba(57, 167, 123, 0.1)',
                    tension: 0.4,
                    fill: true,
                    borderDash: [5, 5]
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ' + 
                                   context.parsed.y.toFixed(2) + ' €';
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: false,
                    ticks: {
                        callback: function(value) {
                            return value.toFixed(0) + ' €';
                        }
                    }
                }
            }
        }
    });
</script>
{% endif %}
{% endblock %}
