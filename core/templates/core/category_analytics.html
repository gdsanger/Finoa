{% extends 'core/base.html' %}

{% block title %}Kategorien-Auswertung - Finoa{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="mb-4">
        <i class="bi bi-bar-chart"></i> Kategorien-Auswertung
    </h1>

    <!-- Filters -->
    <div class="card card-finoa mb-4">
        <div class="card-body">
            <form method="get" 
                  hx-get="{% url 'category_analytics' %}" 
                  hx-target="#analytics-content" 
                  hx-swap="innerHTML"
                  hx-indicator=".htmx-indicator">
                
                <div class="row align-items-end">
                    <!-- Filter Type -->
                    <div class="col-md-3 mb-3">
                        <label for="filterType" class="form-label"><strong>Zeitraum-Typ:</strong></label>
                        <select id="filterType" name="filter" class="form-select" onchange="toggleDateInputs(this.value)">
                            <option value="month" {% if filter_type == 'month' %}selected{% endif %}>Monat</option>
                            <option value="custom" {% if filter_type == 'custom' %}selected{% endif %}>Freier Zeitraum</option>
                        </select>
                    </div>

                    <!-- Month Navigation (shown when filter=month) -->
                    <div class="col-md-4 mb-3" id="monthNav" {% if filter_type == 'custom' %}style="display:none;"{% endif %}>
                        <label class="form-label"><strong>Monat:</strong></label>
                        <div class="btn-group w-100" role="group">
                            <button type="button" 
                                    class="btn btn-finoa-secondary"
                                    onclick="navigateToMonth({{ prev_year }}, {{ prev_month }})">
                                <i class="bi bi-chevron-left"></i>
                            </button>
                            <button type="button" class="btn btn-outline-secondary" disabled>
                                {{ month_name }}
                            </button>
                            <button type="button" 
                                    class="btn btn-finoa-secondary"
                                    onclick="navigateToMonth({{ next_year }}, {{ next_month }})">
                                <i class="bi bi-chevron-right"></i>
                            </button>
                        </div>
                        <input type="hidden" name="year" id="year-input" value="{{ year }}">
                        <input type="hidden" name="month" id="month-input" value="{{ month }}">
                    </div>

                    <!-- Custom Date Range (shown when filter=custom) -->
                    <div class="col-md-4 mb-3" id="customDateRange" {% if filter_type != 'custom' %}style="display:none;"{% endif %}>
                        <label class="form-label"><strong>Von - Bis:</strong></label>
                        <div class="input-group">
                            <input type="date" name="start_date" class="form-control" value="{{ start_date|date:'Y-m-d' }}">
                            <input type="date" name="end_date" class="form-control" value="{{ end_date|date:'Y-m-d' }}">
                        </div>
                    </div>

                    <!-- Account Filter -->
                    <div class="col-md-3 mb-3">
                        <label for="accountSelect" class="form-label"><strong>Konto:</strong></label>
                        <select id="accountSelect" name="account_id" class="form-select">
                            <option value="">Alle Konten</option>
                            {% for account in accounts %}
                            <option value="{{ account.id }}" {% if selected_account and account.id == selected_account.id %}selected{% endif %}>
                                {{ account.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Submit Button -->
                    <div class="col-md-2 mb-3">
                        <button type="submit" class="btn btn-finoa-primary w-100">
                            <i class="bi bi-filter"></i> Filtern
                        </button>
                    </div>
                </div>

                <!-- Loading Indicator -->
                <div class="htmx-indicator text-center py-2">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Laden...</span>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Analytics Content -->
    <div id="analytics-content">
        {% include 'core/partials/category_analytics_content.html' %}
    </div>
</div>

<script>
function toggleDateInputs(filterType) {
    const monthNav = document.getElementById('monthNav');
    const customDateRange = document.getElementById('customDateRange');
    
    if (filterType === 'custom') {
        monthNav.style.display = 'none';
        customDateRange.style.display = 'block';
    } else {
        monthNav.style.display = 'block';
        customDateRange.style.display = 'none';
    }
}

function navigateToMonth(year, month) {
    // Update hidden fields
    document.getElementById('year-input').value = year;
    document.getElementById('month-input').value = month;
    
    // Build the URL with all current parameters
    const accountSelect = document.getElementById('accountSelect');
    const accountId = accountSelect ? accountSelect.value : '';
    
    let url = '?filter=month&year=' + year + '&month=' + month;
    if (accountId) {
        url += '&account_id=' + accountId;
    }
    
    // Use HTMX to update the content
    htmx.ajax('GET', url, {
        target: '#analytics-content',
        swap: 'innerHTML'
    });
}
</script>
{% endblock %}
